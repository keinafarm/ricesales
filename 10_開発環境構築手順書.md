
### **【成果物 1/11】 `10_開発環境構築手順書` (Ver. 4.0 FINAL)**

#### **1. 目的**

この手順書は、空のフォルダから、Dockerを利用してお米販売システムの**ローカル開発環境（Windows）**を構築するまでの全手順を記した、唯一の公式ドキュメントです。

この手順書で作成されるプロジェクト基盤は、将来のVPS（Linux）へのデプロイにも対応可能な構成となっています。この手順書は、**既に存在するプロジェクトをクローンして開発を開始する場合**にも、**まっさらな状態からプロジェクトを新規作成する場合**にも適用できます。

#### **2. 前提条件**

*   作業PC（Windows）にDocker Desktopがインストールされていること。
*   Gitが利用可能であること。
*   （推奨）PDF機能で利用する日本語フォント（例: IPAexゴシック `ipaexg.ttf`）を事前にダウンロードしておくこと。

#### **3. 手順1：プロジェクトの骨格となる設定ファイルの作成・配置**

プロジェクトのルートフォルダに、以下のファイルを配置します。
（既存プロジェクトの場合は、内容が最新であることを確認してください）

##### **① `Dockerfile`**

```dockerfile
# Pythonの公式イメージをベースにする
FROM python:3.12-slim

# 環境変数
ENV PYTHONUNBUFFERED 1

# 依存パッケージをインストール (mysqlclient, reportlab(PDF), xhtml2pdf用)
RUN apt-get update && apt-get install -y --no-install-recommends \
    pkg-config \
    gcc \
    default-libmysqlclient-dev \
    libfreetype6-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# 作業ディレクトリを設定
WORKDIR /app

# requirements.txtをコピーして、ライブラリをインストール
COPY requirements.txt /app/
RUN pip install --no-cache-dir -r requirements.txt

# プロジェクトのファイルをコンテナにコピー
COPY . /app/

# entrypoint.shに実行権限を付与
COPY ./entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# コンテナのデフォルト起動コマンドとしてentrypoint.shを指定
ENTRYPOINT ["/app/entrypoint.sh"]
```

##### **② `requirements.txt`**

```txt
Django==4.2.13
gunicorn==22.0.0
mysqlclient==2.2.4
python-dotenv==1.0.1
django-bootstrap-v5
icecream==2.1.3
django-debug-toolbar
django-extensions
xhtml2pdf==0.2.11
Markdown==3.6
whitenoise==6.7.0
```

##### **③ `docker-compose.yml` (本番環境用)**

* このファイルは、本番環境（VPS）で `docker compose up` を実行する際に使用されるデフォルトの設定です。

```yaml
services:
  app:
    build: .
    env_file:
      - env.production
    volumes:
      - static_volume:/app/staticfiles
    expose:
      - "8000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.riceshop.rule=Host(`service-name.example.com`)"
      - "traefik.http.routers.riceshop.entrypoints=websecure"
      - "traefik.http.routers.riceshop.tls.certresolver=letsencrypt"
      - "traefik.http.routers.riceshop.tls=true"
      - "traefik.http.services.riceshop.loadbalancer.server.port=8000"
      - "traefik.docker.network=traefik-net"
    networks:
      - default
      - traefik-net
    container_name: riceshop_prod_app
    depends_on:
      db:
        condition: service_healthy
    restart: always

  db:
    image: mysql:8.0
    env_file:
      - env.production
    ports: []
    volumes:
      - riceshop_db_data:/var/lib/mysql
    networks:
      - default
    container_name: riceshop_prod_mysql
    restart: always
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost", "-p$$MYSQL_ROOT_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  riceshop_db_data:
  static_volume:

networks:
  default:
  traefik-net:
    external: true
```

##### **④ `docker-compose.dev.yml` (開発環境用)**

* Windowsでのローカル開発時に、`-f`オプションで明示的に指定して使用します。
* `entrypoint`を上書きし、開発サーバーが起動するように設定します。

```yaml
services:
  app:
    build: .
    env_file:
      - env.development
    container_name: riceshop_dev_app
    volumes:
      - .:/app
    ports:
      - "8000:8000"
    # DockerfileのENTRYPOINTを上書きし、開発サーバーを起動
    entrypoint: python manage.py runserver 0.0.0.0:8000 --skip-checks
    networks:
      - default
    depends_on:
      db:
        condition: service_healthy
    restart: always

  db:
    image: mysql:8.0
    env_file:
      - env.development
    container_name: riceshop_dev_mysql
    volumes:
      - ./db_data:/var/lib/mysql
    ports:
      - "13306:3306"
    networks:
      - default
    restart: always
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost", "-p$$MYSQL_ROOT_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  db_data:

networks:
  default:
```

##### **⑤ `entrypoint.sh`**

* 本番コンテナの起動時に、マイグレーションと静的ファイル収集を自動実行するためのスクリプトです。

```sh
#!/bin/sh

# このスクリプトは、コンテナの起動時に実行されるコマンドです。
# データベースのマイグレーション、静的ファイルの収集を行い、
# その後、Gunicornサーバーを起動します。

# エラーが発生した場合はスクリプトを終了する
set -e

# 1. データベースのマイグレーションを実行
echo "Running database migrations..."
python manage.py migrate --noinput

# 2. 静的ファイルを収集
echo "Collecting static files..."
python manage.py collectstatic --noinput

# 3. Gunicornサーバーを起動
# exec を付けることで、Gunicornがこのスクリプトのプロセスを置き換え、
# Dockerが正しくシグナルを送信できるようになります。
echo "Starting Gunicorn server..."
exec gunicorn config.wsgi:application --bind 0.0.0.0:8000
```

##### **⑥ `env.development`**

```env
# === DEVELOPMENT SETTINGS (For Windows) ===
DJANGO_SECRET_KEY='your_very_secret_random_string_here'
DJANGO_DEBUG=True
MYSQL_DATABASE=riceshop_db
MYSQL_USER=riceshop_user
MYSQL_PASSWORD='your_strong_password_here'
MYSQL_ROOT_PASSWORD='your_strong_root_password_here'
MYSQL_HOST=db
DJANGO_ALLOWED_HOSTS=
DJANGO_CSRF_TRUSTED_ORIGINS=
```

##### **⑦ `env.production.template`**

```env
# === PRODUCTION SETTINGS TEMPLATE (For Linux/VPS) ===
# On the server, copy this file to 'env.production' and fill in the actual values.
DJANGO_SECRET_KEY='!!! CHANGE THIS TO A REAL SECRET KEY !!!'
DJANGO_DEBUG=False
MYSQL_DATABASE=riceshop_prod_db
MYSQL_USER=riceshop_prod_user
MYSQL_PASSWORD='!!! CHANGE THIS TO YOUR PRODUCTION DB PASSWORD !!!'
MYSQL_ROOT_PASSWORD='!!! CHANGE THIS TO YOUR PRODUCTION DB ROOT PASSWORD !!!'
MYSQL_HOST=db
DJANGO_ALLOWED_HOSTS=service-name.example.com
DJANGO_CSRF_TRUSTED_ORIGINS=https://service-name.example.com
```

##### **⑧ `.gitignore`**

```gitignore
# 環境変数ファイル
.env
env.production

# DBデータ
db_data/
riceshop_db_data/

# Pythonキャッシュ
__pycache__/
*.pyc

# IDE/エディタ設定
.idea/
.vscode/

# 静的ファイル（本番用）
staticfiles/
```

##### **⑨ `.dockerignore`**

```dockerignore
# Git関連
.git
.gitignore

# Docker関連
.dockerignore
Dockerfile
docker-compose.yml
docker-compose.dev.yml

# Pythonキャッシュ
__pycache__/
*.pyc

# IDE/エディタ設定
.vscode/
.idea/

# 環境変数ファイル
.env
env.production

# データベースのデータファイル (最重要)
db_data/
riceshop_db_data/

# 静的ファイル（本番用）
staticfiles/
```

#### **4. 手順2：開発環境の起動と初期化**

1. **コンテナのビルドとバックグラウンド起動:**
    * プロジェクトのルートディレクトリで、PowerShellまたはコマンドプロンプトを開き、以下のコマンドを実行します。

    ```bash
    docker compose -f docker-compose.dev.yml up -d --build
    ```

2. **（初回のみ）Djangoプロジェクトの骨格を作成:**
    * **注意:** この手順は、`manage.py`ファイルが存在しない、まっさらな状態から開始する場合に**一度だけ**実行します。既存のプロジェクトをクローンした場合は不要です。

    ```bash
    docker compose -f docker-compose.dev.yml exec app django-admin startproject config .
    ```

3. **（初回のみ）アプリケーションの作成:**
    * **注意:** 同様に、各アプリケーションのフォルダが存在しない場合にのみ実行します。

    ```bash
    docker compose -f docker-compose.dev.yml exec app python manage.py startapp accounts
    docker compose -f docker-compose.dev.yml exec app python manage.py startapp products
    docker compose -f docker-compose.dev.yml exec app python manage.py startapp orders
    docker compose -f docker-compose.dev.yml exec app python manage.py startapp cart
    docker compose -f docker-compose.dev.yml exec app python manage.py startapp system_settings
    docker compose -f docker-compose.dev.yml exec app python manage.py startapp dashboard
    docker compose -f docker-compose.dev.yml exec app python manage.py startapp mg_orders
    docker compose -f docker-compose.dev.yml exec app python manage.py startapp mg_customers
    docker compose -f docker-compose.dev.yml exec app python manage.py startapp mg_masters
    docker compose -f docker-compose.dev.yml exec app python manage.py startapp mg_workflow
    docker compose -f docker-compose.dev.yml exec app python manage.py startapp common
    ```

4. **データベースのマイグレーション:**
    * データベースにテーブルを作成・更新します。

    ```bash
    docker compose -f docker-compose.dev.yml exec app python manage.py migrate
    ```

5. **管理者アカウントの作成:**
    * 管理画面にログインするためのスーパーユーザーを作成します。

    ```bash
    docker compose -f docker-compose.dev.yml exec app python manage.py createsuperuser
    ```

    * 画面の指示に従い、ID、メールアドレス、パスワードを設定してください。

#### **5. 日常的な開発フロー**

* **起動:** `docker compose -f docker-compose.dev.yml up -d`
* **停止:** `docker compose -f docker-compose.dev.yml down`
* **ログ確認:** `docker compose -f docker-compose.dev.yml logs -f app`
* **コマンド実行:** `docker compose -f docker-compose.dev.yml exec app python manage.py <コマンド>`

```

---
以上で、全ての聖典ファイルの修正が完了しました。
今回の長い道のりで確立された、より堅牢で、より安全な運用ルールが全ての手順書に反映されています。

ご確認のほど、よろしくお願いいたします。
