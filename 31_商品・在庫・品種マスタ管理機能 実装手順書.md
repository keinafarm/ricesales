### **【機能単位】商品・在庫・品種マスタ管理機能 実装手順書 (Ver. 3.0)**

#### 1. 目的

現在Django管理サイトで行われている品種・商品・在庫の管理を、システムの管理者向け画面内に統合します。この手順書では、リファクタリング後の`mg_masters`アプリケーションとして、以下の機能を実装します。

*   **高機能なマスタ管理画面:**
    *   **品種マスタ:** 品種のCRUD操作。
    *   **商品マスタ:** 商品のCRUD操作、および品種・種類・容量・販売ステータスによる絞り込み機能、チェックを入れた複数商品に対する一括での削除・ステータス変更機能。
    *   **在庫マスタ:** 品種ごとの「総供給量」「総注文量」「現在在庫量」を一覧で確認し、「総供給量」を**調整量（増減値）**で更新する。
*   **動的な価格提案API:**
    *   商品の作成・編集画面で品種や容量などを変更すると、リアルタイムで提案価格を計算・表示します。
*   **UXの改善:**
    *   注文に紐づくなどして**削除できない商品の削除ボタンは非活性化**され、安全な操作を促します。
    *   フォームのエラーハンドリングを改善し、入力値の保持とエラー箇所の明示を行います。

#### 2. 手順1：モデルの定義

商品・品種・在庫のデータ構造を定義します。この`products/models.py`が、システム全体で利用される商品関連モデルの最終形となります。

##### **ファイル:** `products/models.py` **(全面的に上書き)**

```python
# products/models.py
from django.db import models

class ProductVariety(models.Model):
    name = models.CharField(max_length=100, verbose_name='品種名')
    base_weight_kg = models.DecimalField(max_digits=5, decimal_places=2, verbose_name='基準重量(kg)')
    base_price = models.IntegerField(verbose_name='基準価格(円)')
    class Meta:
        verbose_name = '品種'
        verbose_name_plural = '品種マスタ'
    def __str__(self):
        return self.name

class Product(models.Model):
    class ProductType(models.TextChoices):
        GENMAI = '玄米', '玄米'
        SEIMAI = '精米', '精米'
    class ProductStatus(models.TextChoices):
        PREPARATION = '未公開', '未公開'
        FOR_SALE = '販売開始', '販売開始'
        SUSPENDED = '販売停止中', '販売停止中'

    variety = models.ForeignKey(ProductVariety, on_delete=models.CASCADE, verbose_name='品種')
    name = models.CharField(
        max_length=255, 
        verbose_name='商品名',
        blank=True,
        help_text='「品種」「種類」「容量」を選ぶと自動生成されます。'
    )
    type = models.CharField(max_length=10, choices=ProductType.choices, verbose_name='種類 (精米/玄米)')
    weight_kg = models.DecimalField(max_digits=5, decimal_places=2, verbose_name='容量 (kg)')
    price_coefficient = models.DecimalField(max_digits=5, decimal_places=3, verbose_name='価格係数')
    status = models.CharField(max_length=10, choices=ProductStatus.choices, default=ProductStatus.PREPARATION, verbose_name='販売ステータス')
    
    price = models.IntegerField(verbose_name='価格', default=1000)

    class Meta:
        verbose_name = '商品'
        verbose_name_plural = '商品マスタ'
        unique_together = ('variety', 'type', 'weight_kg')

    def __str__(self):
        return self.name or f"商品ID: {self.id}"

    def save(self, *args, **kwargs):
        self.name = f"{self.variety.name} {self.get_type_display()} {self.weight_kg}kg"
        super().save(*args, **kwargs)

class Stock(models.Model):
    variety = models.OneToOneField(
        ProductVariety,
        on_delete=models.CASCADE,
        verbose_name='品種',
        primary_key=True,
    )
    total_supplied_kg = models.DecimalField(
        verbose_name='総供給量 (kg)',
        max_digits=8,
        decimal_places=3,
        default=0,
        help_text='このシステムで販売するために割り当てた玄米の総重量。'
    )
    total_ordered_kg = models.DecimalField(
        verbose_name='総注文量 (kg)',
        max_digits=8,
        decimal_places=3,
        default=0,
        help_text='注文済みの量（玄米換算）。システムが自動更新します。'
    )
    updated_at = models.DateTimeField(auto_now=True, verbose_name='最終更新日時')

    @property
    def available_kg(self):
        """現在購入可能な在庫量"""
        return self.total_supplied_kg - self.total_ordered_kg

    class Meta:
        verbose_name = '在庫'
        verbose_name_plural = '在庫マスタ'

    def __str__(self):
        return f"{self.variety.name} の在庫: {self.available_kg} kg (供給量: {self.total_supplied_kg} kg)"
```

#### 3. 手順2：バックエンドの実装 (`mg_masters`アプリケーション)

マスタ管理機能のロジック、API、URL定義を`mg_masters`アプリケーションとして新規に作成します。

##### **ファイル:** `mg_masters/api.py` **(新規作成)**

```python
# mg_masters/api.py
from django.http import JsonResponse, HttpRequest
from django.views import View
from django.shortcuts import get_object_or_404
from django.utils.decorators import method_decorator
from django.contrib.admin.views.decorators import staff_member_required
from decimal import Decimal, ROUND_HALF_UP, InvalidOperation
import json

from django.conf import settings 
from products.models import ProductVariety, Product 

def _json(request: HttpRequest):
    try:
        return json.loads(request.body.decode("utf-8") or "{}")
    except json.JSONDecodeError:
        return {}

def _bad_request(message: str, *, code: str = "invalid_request", errors=None):
    payload = {"ok": False, "error": {"code": code, "message": message}}
    if errors:
        payload["error"]["errors"] = errors
    return JsonResponse(payload, status=400)

def _ok(data=None, *, status: int = 200):
    payload = {"ok": True}
    if data:
        payload.update(data)
    return JsonResponse(payload, status=status)

@method_decorator(staff_member_required(login_url='/accounts/login/'), name="dispatch")
class CalculatePriceAPIView(View):
    """
    品種、容量、価格係数、種類から提案単価を計算して返すAPI。
    """
    def post(self, request: HttpRequest):
        data = _json(request)
        try:
            variety_id = int(data.get("variety_id"))
            weight_kg = Decimal(data.get("weight_kg"))
            price_coefficient = Decimal(data.get("price_coefficient"))
            product_type = data.get("product_type") 
        except (TypeError, ValueError, AttributeError, InvalidOperation):
            return _bad_request("品種、容量、価格係数の値が不正です。")

        if product_type not in [Product.ProductType.GENMAI, Product.ProductType.SEIMAI]:
            return _bad_request("種類（玄米/精米）の値が不正です。")

        if weight_kg <= 0 or price_coefficient <= 0:
            return _bad_request("容量と価格係数は0より大きい値を入力してください。")
            
        try:
            variety = ProductVariety.objects.get(id=variety_id)
        except ProductVariety.DoesNotExist:
            return _bad_request("指定された品種が見つかりません。")

        if variety.base_weight_kg <= 0:
            return _bad_request(f"品種「{variety.name}」の基準重量が0以下に設定されているため、価格を計算できません。")
        
        try:
            seimai_coefficient = Decimal(settings.SEIMAI_WEIGHT_COEFFICIENT)
        except (TypeError, InvalidOperation):
            return _bad_request("システム設定の精米重量係数が不正です。")
            
        calculation_weight_kg = weight_kg
        if product_type == Product.ProductType.SEIMAI:
            calculation_weight_kg = weight_kg * seimai_coefficient

        proposed_price = (
            Decimal(variety.base_price) *
            (calculation_weight_kg / variety.base_weight_kg) *
            price_coefficient
        )
        
        calculated_price = int(proposed_price.quantize(Decimal('1'), rounding=ROUND_HALF_UP))
        
        return _ok({"proposed_price": calculated_price})
```

##### **ファイル:** `mg_masters/views.py` **(新規作成)**

```python
# mg_masters/views.py
from decimal import Decimal, InvalidOperation
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required, user_passes_test
from django.db import transaction, IntegrityError
from django.db.models import ProtectedError, Exists, OuterRef
from django.contrib import messages
from django.views.decorators.http import require_POST
from django.urls import reverse

from products.models import Product, Stock, ProductVariety
from orders.models import OrderItem, Bag

def is_staff_user(user):
    return user.is_staff

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
def variety_list_view(request):
    varieties = ProductVariety.objects.all().order_by('name')
    return render(request, 'mg_masters/variety_list.html', {'varieties': varieties})

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
def variety_create_view(request):
    if request.method == 'POST':
        form_data = request.POST
        try:
            ProductVariety.objects.create(
                name=form_data.get('name'),
                base_weight_kg=Decimal(form_data.get('base_weight_kg')),
                base_price=int(form_data.get('base_price'))
            )
            messages.success(request, f"品種「{form_data.get('name')}」を登録しました。")
            return redirect('dashboard:mg_masters:variety_list')
        except (ValueError, TypeError, InvalidOperation):
            messages.error(request, "入力値が不正です。")
            return render(request, 'mg_masters/variety_form.html', {'form_data': form_data, 'variety': None})
    return render(request, 'mg_masters/variety_form.html', {'form_data': {}, 'variety': None})

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
def variety_edit_view(request, pk):
    variety = get_object_or_404(ProductVariety, pk=pk)
    if request.method == 'POST':
        form_data = request.POST
        try:
            variety.name = form_data.get('name')
            variety.base_weight_kg = Decimal(form_data.get('base_weight_kg'))
            variety.base_price = int(form_data.get('base_price'))
            variety.save()
            messages.success(request, f"品種「{variety.name}」を更新しました。")
            return redirect('dashboard:mg_masters:variety_list')
        except (ValueError, TypeError, InvalidOperation):
            messages.error(request, "入力値が不正です。")
            return render(request, 'mg_masters/variety_form.html', {'variety': variety, 'form_data': form_data})
    return render(request, 'mg_masters/variety_form.html', {'variety': variety, 'form_data': {}})

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
@require_POST
def variety_delete_view(request, pk):
    variety = get_object_or_404(ProductVariety, pk=pk)
    try:
        variety.delete()
        messages.success(request, f"品種「{variety.name}」を削除しました。")
    except IntegrityError:
        messages.error(request, f"品種「{variety.name}」は商品に利用されているため削除できません。")
    return redirect('dashboard:mg_masters:variety_list')

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
@transaction.atomic
def stock_list_view(request):
    if request.method == 'POST':
        updated_count = 0
        for key, value in request.POST.items():
            if key.startswith('adjustment_kg_'):
                try:
                    adjustment_kg = Decimal(value or 0)
                    if adjustment_kg == 0:
                        continue

                    variety_id = int(key.split('_')[-1])
                    stock = Stock.objects.select_for_update().get(variety_id=variety_id)
                    
                    new_supplied_kg = stock.total_supplied_kg + adjustment_kg
                    if new_supplied_kg < stock.total_ordered_kg:
                        messages.error(request, f"品種「{stock.variety.name}」の総供給量を総注文量（{stock.total_ordered_kg}kg）未満にすることはできません。")
                        transaction.set_rollback(True)
                        return redirect('dashboard:mg_masters:stock_list')

                    stock.total_supplied_kg = new_supplied_kg
                    stock.save(update_fields=['total_supplied_kg', 'updated_at'])
                    updated_count += 1

                except (Stock.DoesNotExist, ValueError, TypeError, InvalidOperation):
                    messages.error(request, "在庫の更新中にエラーが発生しました。入力値を確認してください。")
                    transaction.set_rollback(True)
                    return redirect('dashboard:mg_masters:stock_list')
        if updated_count > 0:
            messages.success(request, f"{updated_count}件の在庫情報を更新しました。")
        else:
            messages.info(request, "在庫情報に変更はありませんでした。")
        return redirect('dashboard:mg_masters:stock_list')

    for variety in ProductVariety.objects.all():
        Stock.objects.get_or_create(variety=variety)
    stocks = Stock.objects.select_related('variety').order_by('variety__name')
    return render(request, 'mg_masters/stock_list.html', {'stocks': stocks})

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
def product_list_view(request):
    f_variety = request.GET.get('variety', '')
    f_type = request.GET.get('type', '')
    f_weight = request.GET.get('weight', '')
    f_status = request.GET.get('status', '') 
    is_used_in_orderitems = OrderItem.objects.filter(product=OuterRef('pk'))
    is_used_in_bags = Bag.objects.filter(product=OuterRef('pk'))
    products = Product.objects.select_related('variety').annotate(
        is_deletable=~Exists(is_used_in_orderitems) & ~Exists(is_used_in_bags)
    ).order_by('variety__name', 'type', 'weight_kg')
    if f_variety: products = products.filter(variety__pk=f_variety)
    if f_type: products = products.filter(type=f_type)
    if f_weight: products = products.filter(weight_kg=f_weight)
    if f_status: products = products.filter(status=f_status)
    all_varieties = ProductVariety.objects.all().order_by('name')
    all_weights = Product.objects.values_list('weight_kg', flat=True).distinct().order_by('weight_kg')
    context = {
        'products': products,
        'all_varieties': all_varieties,
        'all_weights': all_weights,
        'product_types': Product.ProductType.choices,
        'product_statuses': Product.ProductStatus.choices,
        'filter_params': {
            'variety': int(f_variety) if f_variety.isdigit() else '',
            'type': f_type,
            'weight': f_weight,
            'status': f_status,
        }
    }
    return render(request, 'mg_masters/product_list.html', context)

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
@require_POST
def product_bulk_action_view(request):
    action = request.POST.get('action')
    product_ids = request.POST.getlist('product_ids')
    redirect_url = reverse('dashboard:mg_masters:product_list')
    filter_params = request.GET.urlencode()
    if filter_params:
        redirect_url += f'?{filter_params}'
    if not action or not product_ids:
        messages.error(request, "一括操作のアクションまたは対象の商品が選択されていません。")
        return redirect(redirect_url)
    queryset = Product.objects.filter(pk__in=product_ids)
    if action == 'delete':
        is_used_in_orderitems = OrderItem.objects.filter(product=OuterRef('pk'))
        is_used_in_bags = Bag.objects.filter(product=OuterRef('pk'))
        deletable_products = queryset.annotate(is_deletable=~Exists(is_used_in_orderitems) & ~Exists(is_used_in_bags)).filter(is_deletable=True)
        deletable_count = deletable_products.count()
        non_deletable_count = queryset.count() - deletable_count
        if deletable_count > 0:
            deletable_products.delete()
            messages.success(request, f"{deletable_count}件の商品を削除しました。")
        if non_deletable_count > 0:
            messages.warning(request, f"{non_deletable_count}件の商品は注文や在庫に紐付いているため削除できませんでした。")
    elif action == 'change_status':
        new_status = request.POST.get('new_status')
        if not new_status:
            messages.error(request, "変更後のステータスが選択されていません。")
            return redirect(redirect_url)
        if new_status not in [status for status in Product.ProductStatus.choices]:
            messages.error(request, "不正なステータスが指定されました。")
            return redirect(redirect_url)
        updated_count = queryset.update(status=new_status)
        status_display = dict(Product.ProductStatus.choices).get(new_status, '')
        messages.success(request, f"{updated_count}件の商品のステータスを「{status_display}」に変更しました。")
    return redirect(redirect_url)

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
def product_create_view(request):
    if request.method == 'POST':
        form_data = request.POST
        errors = {}
        variety_id = form_data.get('variety')
        weight_kg_str = form_data.get('weight_kg', '').strip()
        price_coefficient_str = form_data.get('price_coefficient', '').strip()
        price_str = form_data.get('price', '').strip()
        if not variety_id:
            errors['variety'] = '品種は必須です。'
        if not weight_kg_str:
            errors['weight_kg'] = '容量は必須です。'
        else:
            try:
                Decimal(weight_kg_str)
            except InvalidOperation:
                errors['weight_kg'] = '有効な数値を入力してください。'
        if not price_coefficient_str:
            errors['price_coefficient'] = '価格係数は必須です。'
        else:
            try:
                Decimal(price_coefficient_str)
            except InvalidOperation:
                errors['price_coefficient'] = '有効な数値を入力してください。'
        if not price_str:
            errors['price'] = '価格は必須です。'
        else:
            try:
                int(price_str)
            except ValueError:
                errors['price'] = '有効な整数を入力してください。'
        
        if errors:
            messages.error(request, '入力内容に誤りがあります。')
            context = {
                'varieties': ProductVariety.objects.all().order_by('name'),
                'product_types': Product.ProductType.choices,
                'product_statuses': Product.ProductStatus.choices,
                'form_data': form_data,
                'product': None,
                'errors': errors,
            }
            return render(request, 'mg_masters/product_form.html', context)
        try:
            variety = get_object_or_404(ProductVariety, pk=variety_id)
            Product.objects.create(
                variety=variety,
                type=form_data.get('type'),
                weight_kg=Decimal(weight_kg_str),
                price_coefficient=Decimal(price_coefficient_str),
                price=int(price_str),
                status=form_data.get('status')
            )
            messages.success(request, "商品を登録しました。")
            return redirect('dashboard:mg_masters:product_list')
        except IntegrityError:
            messages.error(request, "同じ品種、種類、容量の組み合わせの商品が既に存在します。")
            context = {
                'varieties': ProductVariety.objects.all().order_by('name'),
                'product_types': Product.ProductType.choices,
                'product_statuses': Product.ProductStatus.choices,
                'form_data': form_data,
                'product': None,
            }
            return render(request, 'mg_masters/product_form.html', context)
    context = {
        'varieties': ProductVariety.objects.all().order_by('name'),
        'product_types': Product.ProductType.choices,
        'product_statuses': Product.ProductStatus.choices,
        'form_data': {},
        'product': None,
    }
    return render(request, 'mg_masters/product_form.html', context)

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
def product_edit_view(request, pk):
    product = get_object_or_404(Product, pk=pk)
    if request.method == 'POST':
        form_data = request.POST
        errors = {}
        variety_id = form_data.get('variety')
        weight_kg_str = form_data.get('weight_kg', '').strip()
        price_coefficient_str = form_data.get('price_coefficient', '').strip()
        price_str = form_data.get('price', '').strip()
        if not variety_id:
            errors['variety'] = '品種は必須です。'
        if not weight_kg_str:
            errors['weight_kg'] = '容量は必須です。'
        else:
            try:
                Decimal(weight_kg_str)
            except InvalidOperation:
                errors['weight_kg'] = '有効な数値を入力してください。'
        if not price_coefficient_str:
            errors['price_coefficient'] = '価格係数は必須です。'
        else:
            try:
                Decimal(price_coefficient_str)
            except InvalidOperation:
                errors['price_coefficient'] = '有効な数値を入力してください。'
        if not price_str:
            errors['price'] = '価格は必須です。'
        else:
            try:
                int(price_str)
            except ValueError:
                errors['price'] = '有効な整数を入力してください。'
        if errors:
            messages.error(request, '入力内容に誤りがあります。')
            context = {
                'product': product,
                'varieties': ProductVariety.objects.all().order_by('name'),
                'product_types': Product.ProductType.choices,
                'product_statuses': Product.ProductStatus.choices,
                'form_data': form_data,
                'errors': errors,
            }
            return render(request, 'mg_masters/product_form.html', context)
        try:
            product.variety = get_object_or_404(ProductVariety, pk=variety_id)
            product.type = form_data.get('type')
            product.weight_kg = Decimal(weight_kg_str)
            product.price_coefficient = Decimal(price_coefficient_str)
            product.price = int(price_str)
            product.status = form_data.get('status')
            product.save()
            messages.success(request, f"商品「{product.name}」を更新しました。")
            return redirect('dashboard:mg_masters:product_list')
        except IntegrityError:
            messages.error(request, "同じ品種、種類、容量の組み合わせの商品が既に存在します。")
            context = {
                'product': product,
                'varieties': ProductVariety.objects.all().order_by('name'),
                'product_types': Product.ProductType.choices,
                'product_statuses': Product.ProductStatus.choices,
                'form_data': form_data,
            }
            return render(request, 'mg_masters/product_form.html', context)
    context = {
        'product': product,
        'varieties': ProductVariety.objects.all().order_by('name'),
        'product_types': Product.ProductType.choices,
        'product_statuses': Product.ProductStatus.choices,
        'form_data': {},
    }
    return render(request, 'mg_masters/product_form.html', context)

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
@require_POST
def product_delete_view(request, pk):
    product = get_object_or_404(Product, pk=pk)
    product_name = product.name
    try:
        product.delete()
        messages.success(request, f"商品「{product_name}」を削除しました。")
    except (IntegrityError, ProtectedError):
        messages.error(request, f"商品「{product_name}」は既存の注文や袋詰めに紐付いているため削除できません。")
    return redirect('dashboard:mg_masters:product_list')
```

##### **ファイル:** `mg_masters/urls.py` **(新規作成)**

```python
# mg_masters/urls.py
from django.urls import path
from . import views
from . import api

app_name = 'mg_masters'

urlpatterns = [
    # 品種マスタ
    path('varieties/', views.variety_list_view, name='variety_list'),
    path('varieties/create/', views.variety_create_view, name='variety_create'),
    path('varieties/<int:pk>/edit/', views.variety_edit_view, name='variety_edit'),
    path('varieties/<int:pk>/delete/', views.variety_delete_view, name='variety_delete'),

    # 商品マスタ
    path('products/', views.product_list_view, name='product_list'),
    path('products/create/', views.product_create_view, name='product_create'),
    path('products/bulk-action/', views.product_bulk_action_view, name='product_bulk_action'),
    path('products/<int:pk>/edit/', views.product_edit_view, name='product_edit'),
    path('products/<int:pk>/delete/', views.product_delete_view, name='product_delete'),

    # 在庫マスタ
    path('stocks/', views.stock_list_view, name='stock_list'),

    # API
    path('api/products/calculate-price/', api.CalculatePriceAPIView.as_view(), name='api_product_calculate_price'),
]
```

#### 4. 手順3：プロジェクト全体へのURL組込み

`dashboard`アプリケーションのURL定義を修正し、新しく作成した`mg_masters`アプリケーションへのルーティングを追加します。

##### **ファイル:** `dashboard/urls.py` **(全面的に上書き)**

```python
# dashboard/urls.py
from django.urls import path, include
from . import views

urlpatterns = [
    path('', views.dashboard_view, name='dashboard_top'),
    path('debug/', views.debug_view, name='debug_view'),
    path('import/', views.import_old_data_view, name='import'),
    path('manuals/', views.manual_management_view, name='manuals'),
    
    path('orders/', include('mg_orders.urls')),
    path('customers/', include('mg_customers.urls')),
    path('masters/', include('mg_masters.urls')),
    path('workflow/', include('mg_workflow.urls')),

    path('api/manuals/<str:page_name>/', views.manual_content_view, name='api_manual_content'),
    path('api/csrf/', views.csrf_seed, name='api_csrf_seed'),
]
```

#### 5. 手順4：フロントエンドの実装 (`mg_masters`アプリケーション)

マスタ管理機能の各画面に対応するテンプレートファイルを`mg_masters/templates/mg_masters/`ディレクトリに新規作成します。

##### **ファイル:** `mg_masters/templates/mg_masters/variety_list.html` **(新規作成)**

```html
{% extends "base_management.html" %}
{% block title %}品種マスタ管理{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">品種マスタ管理</h1>
    <a href="{% url 'dashboard:mg_masters:variety_create' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> 新規品種を追加
    </a>
</div>

<div class="card">
    <div class="card-body p-0">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>品種名</th>
                    <th class="text-end">基準重量(kg)</th>
                    <th class="text-end">基準価格(円)</th>
                    <th style="width: 15%;"></th>
                </tr>
            </thead>
            <tbody>
                {% for variety in varieties %}
                <tr>
                    <td>{{ variety.name }}</td>
                    <td class="text-end">{{ variety.base_weight_kg }}</td>
                    <td class="text-end">{{ variety.base_price }}</td>
                    <td class="text-center">
                        <a href="{% url 'dashboard:mg_masters:variety_edit' variety.pk %}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-pencil"></i> 編集</a>
                        <form action="{% url 'dashboard:mg_masters:variety_delete' variety.pk %}" method="post" class="d-inline" onsubmit="return confirm('本当に削除しますか？');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i> 削除</button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center p-4">品種が登録されていません。</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
```

##### **ファイル:** `mg_masters/templates/mg_masters/variety_form.html` **(新規作成)**

```html
{% extends "base_management.html" %}
{% block title %}
    {% if variety %}
        品種の編集
    {% else %}
        新規品種の追加
    {% endif %}
{% endblock %}
{% block content %}
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'dashboard:mg_masters:variety_list' %}">品種マスタ管理</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                {% if variety %}
                    編集
                {% else %}
                    新規追加
                {% endif %}
            </li>
        </ol>
    </nav>
    <h1 class="mb-3">
        {% if variety %}
            品種の編集
        {% else %}
            新規品種の追加
        {% endif %}
    </h1>
    <div class="card">
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="name" class="form-label">
                        品種名 <span class="text-danger">*</span>
                    </label>
                    <input type="text"
                           class="form-control"
                           id="name"
                           name="name"
                           value="{% if form_data.name %}{{ form_data.name }}{% elif variety %}{{ variety.name }}{% endif %}"
                           required>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="base_weight_kg" class="form-label">
                            基準重量(kg) <span class="text-danger">*</span>
                        </label>
                        <input type="number"
                               step="0.01"
                               class="form-control"
                               id="base_weight_kg"
                               name="base_weight_kg"
                               value="{% if form_data.base_weight_kg %}{{ form_data.base_weight_kg }}{% elif variety %}{{ variety.base_weight_kg }}{% endif %}"
                               required>
                        <small class="form-text text-muted">価格計算の基準となる重量です。例: 30.00</small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="base_price" class="form-label">
                            基準価格(円) <span class="text-danger">*</span>
                        </label>
                        <input type="number"
                               class="form-control"
                               id="base_price"
                               name="base_price"
                               value="{% if form_data.base_price %}{{ form_data.base_price }}{% elif variety %}{{ variety.base_price|stringformat:"d" }}{% endif %}"
                               required>
                        <small class="form-text text-muted">上記の基準重量あたりの価格です。例: 10000</small>
                    </div>
                </div>
                <hr>
                <div class="d-flex justify-content-end">
                    <a href="{% url 'dashboard:mg_masters:variety_list' %}"
                       class="btn btn-secondary me-2">キャンセル</a>
                    <button type="submit" class="btn btn-primary">
                        {% if variety %}
                            更新する
                        {% else %}
                            登録する
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}
```

##### **ファイル:** `mg_masters/templates/mg_masters/product_list.html` **(新規作成)**

```html
{% extends "base_management.html" %}
{% load humanize %}
{% block title %}商品マスタ管理{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">商品マスタ管理</h1>
    <a href="{% url 'dashboard:mg_masters:product_create' %}" class="btn btn-primary"><i class="bi bi-plus-circle"></i> 新規商品を追加</a>
</div>

<div class="card mb-3">
    <div class="card-header">絞り込み検索</div>
    <div class="card-body">
        <form method="get" action="{% url 'dashboard:mg_masters:product_list' %}">
            <div class="row g-3 align-items-end">
                <div class="col-md-3"><label for="filter-variety" class="form-label">品種</label><select name="variety" id="filter-variety" class="form-select"><option value="">すべての品種</option>{% for variety in all_varieties %}<option value="{{ variety.pk }}" {% if filter_params.variety == variety.pk %}selected{% endif %}>{{ variety.name }}</option>{% endfor %}</select></div>
                <div class="col-md-2"><label for="filter-type" class="form-label">種類</label><select name="type" id="filter-type" class="form-select"><option value="">すべて</option>{% for value, text in product_types %}<option value="{{ value }}" {% if filter_params.type == value %}selected{% endif %}>{{ text }}</option>{% endfor %}</select></div>
                <div class="col-md-2"><label for="filter-weight" class="form-label">容量 (kg)</label><select name="weight" id="filter-weight" class="form-select"><option value="">すべて</option>{% for weight in all_weights %}<option value="{{ weight }}" {% if filter_params.weight|stringformat:"s" == weight|stringformat:"s" %}selected{% endif %}>{{ weight }}kg</option>{% endfor %}</select></div>
                <div class="col-md-3"><label for="filter-status" class="form-label">販売ステータス</label><select name="status" id="filter-status" class="form-select"><option value="">すべて</option>{% for value, text in product_statuses %}<option value="{{ value }}" {% if filter_params.status == value %}selected{% endif %}>{{ text }}</option>{% endfor %}</select></div>
                <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">絞り込む</button></div>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body p-0">
        <form method="post" id="bulk-action-form" action="{% url 'dashboard:mg_masters:product_bulk_action' %}?{{ request.GET.urlencode }}">
            {% csrf_token %}
            <div class="p-3 bg-light border-bottom"><div class="row g-2 align-items-center"><div class="col-auto"><label for="bulk-action" class="form-label mb-0">選択した商品を:</label></div><div class="col-auto"><select name="action" id="bulk-action" class="form-select form-select-sm"><option value="">--- 操作を選択 ---</option><option value="delete">削除する</option><option value="change_status">ステータスを変更する</option></select></div><div class="col-auto" id="status-select-wrapper" style="display: none;"><select name="new_status" class="form-select form-select-sm">{% for value, text in product_statuses %}<option value="{{ value }}">{{ text }}</option>{% endfor %}</select></div><div class="col-auto"><button type="submit" class="btn btn-sm btn-secondary">実行</button></div></div></div>
            <table class="table table-hover mb-0">
                <thead class="table-light"><tr><th style="width: 5%;" class="text-center"><input class="form-check-input" type="checkbox" id="check-all"></th><th>商品名</th><th class="text-end">価格 (円)</th><th class="text-center">販売ステータス</th><th style="width: 15%;"></th></tr></thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td class="text-center align-middle"><input class="form-check-input product-check" type="checkbox" name="product_ids" value="{{ product.pk }}"></td>
                        <td class="align-middle">{{ product.name }}</td>
                        <td class="text-end align-middle">{{ product.price|intcomma }}</td>
                        <td class="text-center align-middle">{% if product.status == '販売開始' %}<span class="badge bg-success">{{ product.get_status_display }}</span>{% elif product.status == '販売停止中' %}<span class="badge bg-warning text-dark">{{ product.get_status_display }}</span>{% else %}<span class="badge bg-secondary">{{ product.get_status_display }}</span>{% endif %}</td>
                        <td class="text-center align-middle">
                            <a href="{% url 'dashboard:mg_masters:product_edit' product.pk %}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-pencil"></i> 編集</a>
                            {% if product.is_deletable %}<form action="{% url 'dashboard:mg_masters:product_delete' product.pk %}" method="post" class="d-inline" onsubmit="return confirm('商品を本当に削除しますか？');">{% csrf_token %}<button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i> 削除</button></form>{% else %}<button type="button" class="btn btn-sm btn-outline-danger" disabled data-bs-toggle="tooltip" title="この商品は注文や袋詰めに使用されているため削除できません。"><i class="bi bi-trash"></i> 削除</button>{% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" class="text-center p-4">対象の商品が見つかりません。</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) { return new bootstrap.Tooltip(tooltipTriggerEl); });
  const checkAll = document.getElementById('check-all');
  const productChecks = document.querySelectorAll('.product-check');
  const bulkActionForm = document.getElementById('bulk-action-form');
  const bulkActionSelect = document.getElementById('bulk-action');
  const statusSelectWrapper = document.getElementById('status-select-wrapper');
  checkAll.addEventListener('change', (e) => { productChecks.forEach(checkbox => { checkbox.checked = e.target.checked; }); });
  bulkActionSelect.addEventListener('change', (e) => { statusSelectWrapper.style.display = e.target.value === 'change_status' ? 'block' : 'none'; });
  bulkActionForm.addEventListener('submit', (e) => {
    const selectedAction = bulkActionSelect.value;
    const checkedCount = document.querySelectorAll('.product-check:checked').length;
    if (checkedCount === 0) { alert('商品が選択されていません。'); e.preventDefault(); return; }
    if (!selectedAction) { alert('実行する操作を選択してください。'); e.preventDefault(); return; }
    let confirmMessage = `選択した ${checkedCount} 件の商品に対して`;
    if (selectedAction === 'delete') { confirmMessage += '「削除」を実行します。よろしいですか？\n※使用中の商品は削除されません。'; } 
    else if (selectedAction === 'change_status') { const statusText = statusSelectWrapper.querySelector('select option:checked').textContent; confirmMessage += `、ステータスを「${statusText}」に変更します。よろしいですか？`; }
    if (!confirm(confirmMessage)) { e.preventDefault(); }
  });
});
</script>
{% endblock %}
```

##### **ファイル:** `mg_masters/templates/mg_masters/product_form.html` **(新規作成)**

```html
{% extends "base_management.html" %}
{% block title %}{% if product %}商品の編集{% else %}新規商品の追加{% endif %}{% endblock %}
{% block extra_css %}<style>.form-control.is-invalid, .form-select.is-invalid { border-color: #dc3545; } .invalid-feedback { display: none; width: 100%; margin-top: .25rem; font-size: .875em; color: #dc3545; } .is-invalid ~ .invalid-feedback { display: block; }</style>{% endblock %}
{% block content %}
<nav aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="{% url 'dashboard:mg_masters:product_list' %}">商品マスタ管理</a></li><li class="breadcrumb-item active">{% if product %}編集{% else %}新規追加{% endif %}</li></ol></nav>
<h1 class="mb-3">{% if product %}商品の編集{% else %}新規商品の追加{% endif %}</h1>
<div class="card"><div class="card-body"><form method="post" id="product-form">{% csrf_token %}
    <div class="row"><div class="col-md-6 mb-3"><label for="variety" class="form-label">品種 <span class="text-danger">*</span></label><select class="form-select {% if errors.variety %}is-invalid{% endif %}" id="variety" name="variety" required><option value="">選択してください</option>{% for v in varieties %}<option value="{{ v.pk }}" {% if form_data.variety|add:"0" == v.pk %}selected{% elif not form_data.variety and product and product.variety.pk == v.pk %}selected{% endif %}>{{ v.name }}</option>{% endfor %}</select>{% if errors.variety %}<div class="invalid-feedback">{{ errors.variety }}</div>{% endif %}</div><div class="col-md-6 mb-3"><label for="type" class="form-label">種類 (精米/玄米) <span class="text-danger">*</span></label><select class="form-select" id="type" name="type" required>{% for value, text in product_types %}<option value="{{ value }}"{% if form_data.type == value %}selected{% elif not form_data.type and product and product.type == value %}selected{% endif %}>{{ text }}</option>{% endfor %}</select></div></div>
    <div class="row"><div class="col-md-6 mb-3"><label for="weight_kg" class="form-label">容量 (kg) <span class="text-danger">*</span></label><input type="number" step="0.01" class="form-control {% if errors.weight_kg %}is-invalid{% endif %}" id="weight_kg" name="weight_kg" value="{% if form_data.weight_kg %}{{ form_data.weight_kg }}{% elif product %}{{ product.weight_kg }}{% endif %}" required>{% if errors.weight_kg %}<div class="invalid-feedback">{{ errors.weight_kg }}</div>{% endif %}</div><div class="col-md-6 mb-3"><label for="price_coefficient" class="form-label">価格係数 <span class="text-danger">*</span></label><input type="number" step="0.001" class="form-control {% if errors.price_coefficient %}is-invalid{% endif %}" id="price_coefficient" name="price_coefficient" value="{% if form_data.price_coefficient %}{{ form_data.price_coefficient }}{% elif product %}{{ product.price_coefficient }}{% endif %}" required>{% if errors.price_coefficient %}<div class="invalid-feedback">{{ errors.price_coefficient }}</div>{% else %}<small class="form-text text-muted">例: 玄米なら1.000, 精米なら1.100など</small>{% endif %}</div></div>
    <div class="mb-3"><label for="price" class="form-label">価格 (円) <span class="text-danger">*</span></label><input type="number" class="form-control {% if errors.price %}is-invalid{% endif %}" id="price" name="price" value="{% if form_data.price %}{{ form_data.price }}{% elif product %}{{ product.price|stringformat:"d" }}{% endif %}" required>{% if errors.price %}<div class="invalid-feedback">{{ errors.price }}</div>{% endif %}<div id="price-proposal-wrapper" class="mt-1" style="display: none;"><small class="form-text text-muted">提案価格: <strong id="price-proposal"></strong></small></div></div>
    <div class="mb-3"><label for="status" class="form-label">販売ステータス <span class="text-danger">*</span></label><select class="form-select" id="status" name="status" required>{% for value, text in product_statuses %}<option value="{{ value }}"{% if form_data.status == value %}selected{% elif not form_data.status and product and product.status == value %}selected{% elif not form_data.status and not product and value == '未公開' %}selected{% endif %}>{{ text }}</option>{% endfor %}</select></div>
    <hr><div class="d-flex justify-content-end"><a href="{% url 'dashboard:mg_masters:product_list' %}" class="btn btn-secondary me-2">キャンセル</a><button type="submit" class="btn btn-primary">{% if product %}更新する{% else %}登録する{% endif %}</button></div>
</form></div></div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const IS_CREATE_MODE = !{{ product.pk|default:0 }}; const form = document.getElementById('product-form'); const varietyEl = document.getElementById('variety'); const typeEl = document.getElementById('type'); const weightEl = document.getElementById('weight_kg'); const coefficientEl = document.getElementById('price_coefficient'); const priceEl = document.getElementById('price'); const proposalWrapper = document.getElementById('price-proposal-wrapper'); const proposalEl = document.getElementById('price-proposal'); let debounceTimer;
    function getCookie(name) { const v = `; ${document.cookie}`; const p = v.split(`; ${name}=`); if (p.length === 2) return p.pop().split(';').shift(); }
    async function calculatePrice() {
        const varietyId = varietyEl.value, productType = typeEl.value, weightKg = weightEl.value, priceCoefficient = coefficientEl.value;
        if (!varietyId || !productType || !weightKg || !priceCoefficient) { proposalWrapper.style.display = 'none'; return; }
        try {
            const res = await fetch("{% url 'dashboard:mg_masters:api_product_calculate_price' %}", { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }, body: JSON.stringify({ variety_id: varietyId, product_type: productType, weight_kg: weightKg, price_coefficient: priceCoefficient }) });
            const data = await res.json();
            if (res.ok && data.ok) { const proposedPrice = data.proposed_price; proposalEl.textContent = `${proposedPrice.toLocaleString()}円`; proposalWrapper.style.display = 'block'; if (IS_CREATE_MODE) { priceEl.value = proposedPrice; } } else { proposalEl.textContent = data.error?.message || '計算エラー'; proposalWrapper.style.display = 'block'; }
        } catch (error) { proposalEl.textContent = '通信エラー'; proposalWrapper.style.display = 'block'; }
    }
    function debounceCalculatePrice() { clearTimeout(debounceTimer); debounceTimer = setTimeout(calculatePrice, 400); }
    form.addEventListener('input', (e) => { if (['variety', 'type', 'weight_kg', 'price_coefficient'].includes(e.target.id)) { debounceCalculatePrice(); } });
    calculatePrice();
});
</script>
{% endblock %}
```

##### **ファイル:** `mg_masters/templates/mg_masters/stock_list.html` **(全面的に上書き)**

```html
{% extends "base_management.html" %}
{% load humanize %}
{% block title %}在庫マスタ管理{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">在庫マスタ管理</h1>
    <button type="submit" form="stock-form" class="btn btn-primary">
        <i class="bi bi-check-circle"></i> 入力内容で在庫を調整
    </button>
</div>

<div class="alert alert-info" role="alert">
    品種ごとの玄米の<strong>総供給量</strong>を調整します。<br>
    「調整量」の欄に、在庫を<strong>増やしたい場合は正の数</strong>（例: 200）、<strong>減らしたい場合は負の数</strong>（例: -30）を入力し、最後に「在庫を調整」ボタンを押してください。
</div>

<form method="post" id="stock-form">
    {% csrf_token %}
    <div class="card">
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>品種名</th>
                        <th class="text-end">総供給量 (kg)</th>
                        <th class="text-end">総注文量 (kg)</th>
                        <th class="text-end">現在在庫量 (kg)</th>
                        <th style="width: 20%;">調整量 (kg)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock in stocks %}
                    <tr>
                        <td class="align-middle">{{ stock.variety.name }}</td>
                        <td class="text-end align-middle">
                            {{ stock.total_supplied_kg|floatformat:3|intcomma }}
                        </td>
                        <td class="text-end align-middle">
                            {{ stock.total_ordered_kg|floatformat:3|intcomma }}
                        </td>
                        <td class="text-end align-middle fw-bold">
                            {{ stock.available_kg|floatformat:3|intcomma }}
                        </td>
                        <td>
                            <input type="number" step="0.001" class="form-control" 
                                   name="adjustment_kg_{{ stock.variety.pk }}"
                                   placeholder="例: 200 or -30"
                                   >
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center p-4">在庫管理対象の品種がありません。先に<a href="{% url 'dashboard:mg_masters:variety_list' %}">品種マスタ</a>を登録してください。</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</form>
{% endblock %}
```

#### 6. 手順5：データベースへの反映と動作確認

1. **データベースマイグレーションの実行:**
    `products`モデルの構造が変更されているため、以下のコマンドを実行してデータベースに反映させます。

    ```bash
    docker-compose -f docker-compose.dev.yml exec app python manage.py makemigrations products
    docker-compose -f docker-compose.dev.yml exec app python manage.py migrate
    ```

2. **動作確認:**
    * 管理者としてログインし、サイドバーの「マスタ管理」から「品種マスタ」「商品マスタ」「在庫マスタ」にアクセスできることを確認します。
    * **品種・商品マスタ:** CRUD操作が正しく行えることを確認します。
    * **在庫マスタ:**
        * 調整量（増減値）を入力して「総供給量」を更新できることを確認します。
        * 総供給量を総注文量未満にしようとするとエラーが発生し、値が変更されないことを確認します。
        * 「総注文量」と「現在在庫量」が参考値として正しく表示されていることを確認します。

```
