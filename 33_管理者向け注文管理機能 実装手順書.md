### **【機能単位】管理者向け注文管理機能 実装手順書 (Ver. 3.2)**

#### 1. 目的

この手順書は、`【機能単位】購入者向け機能 実装手順書 (Ver. 3.2)`までが完了した状態から、管理者が利用する以下の基本的な注文管理機能を、新設された`mg_orders`アプリケーションに実装するための公式ドキュメントです。

* **注文一覧・フィルタ機能:** 全ての注文を一覧で確認し、「対応中」「全件」「ステータス別」「入金ステータス別」で柔軟に表示を絞り込む機能。
* **注文受付機能:** 顧客からの「新規注文」を確認し、「注文受付」ステータスへ変更する機能。
* **高機能な注文編集:** 発送前の注文に対し、お届け先、商品数量、商品単価の変更や、商品の新規追加を行う機能。商品が0になった場合は注文が自動的に削除され、送料も正しく再計算される。
* **入金ステータス更新機能:** 注文一覧画面から非同期で「未入金」「入金済み」を切り替える機能。

#### 2. 手順1：バックエンドの実装 (`mg_orders`アプリケーション)

注文管理機能のロジック、API、URL定義を`mg_orders`アプリケーションとして新規に作成します。

##### **ファイル:** `mg_orders/api.py` **(全面的に上書き)**

```python
# mg_orders/api.py
from django.http import JsonResponse, HttpRequest
from django.views import View
from django.shortcuts import get_object_or_404
from django.utils.decorators import method_decorator
from django.views.decorators.csrf import csrf_protect
from django.contrib.admin.views.decorators import staff_member_required
from django.db import transaction
import json

from orders.models import Order

# --- Helper Functions ---
def _json(request: HttpRequest):
    try:
        body = request.body.decode("utf-8") or "{}"
        return json.loads(body)
    except json.JSONDecodeError:
        return {}

def _bad_request(message: str, *, code: str = "invalid_request"):
    return JsonResponse({"ok": False, "error": {"code": code, "message": message}}, status=400)

def _ok(data=None, *, status: int = 200):
    payload = {"ok": True}
    if data:
        payload.update(data)
    return JsonResponse(payload, status=status)
# --- End Helper Functions ---


@method_decorator(csrf_protect, name="dispatch")
@method_decorator(staff_member_required(login_url='/accounts/login/'), name="dispatch")
class PaymentStatusUpdateView(View):
    """注文の入金ステータスを更新するためのAPIビュー"""
    def post(self, request: HttpRequest, order_id: int):
        data = _json(request)
        new_status = data.get("payment_status")

        valid_statuses = [s[0] for s in Order.PaymentStatus.choices]
        if new_status not in valid_statuses:
            return _bad_request(f"無効なステータスです。有効な値: {', '.join(valid_statuses)}")

        with transaction.atomic():
            try:
                order = Order.objects.select_for_update().get(pk=order_id)
                order.payment_status = new_status
                order.save(update_fields=["payment_status"])
            except Order.DoesNotExist:
                return JsonResponse({"ok": False, "error": {"message": "対象の注文が見つかりません。"}}, status=404)

        return _ok({
            "message": f"注文(ORD-{order.id:06d})の入金ステータスを「{order.get_payment_status_display()}」に更新しました。"
        })
```

##### **ファイル:** `mg_orders/views.py` **(全面的に上書き)**

```python
# mg_orders/views.py
from decimal import Decimal
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required, user_passes_test
from django.db import transaction
from django.contrib import messages
from django.views.decorators.http import require_POST
from django.conf import settings
from orders.views import _calculate_provisional_shipping_fee

from orders.models import Order, OrderItem
from products.models import Product, Stock
from accounts.models import Destination

def is_staff_user(user):
    return user.is_staff

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
def order_list(request):
    filter_type = request.GET.get('filter', 'active')
    status_filter = request.GET.get('status', '')
    payment_status_filter = request.GET.get('payment_status', '')

    orders_query = Order.objects.select_related('user', 'destination') \
        .prefetch_related('items__product').order_by('-created_at')

    if status_filter:
        orders_query = orders_query.filter(status=status_filter)
        filter_type = 'status'
    elif payment_status_filter:
        orders_query = orders_query.filter(payment_status=payment_status_filter)
        filter_type = 'payment_status'
    elif filter_type == 'active':
        orders_query = orders_query.exclude(
            status__in=[
                Order.OrderStatus.SHIPPED,
                Order.OrderStatus.DELIVERED,
                Order.OrderStatus.CANCELED,
            ]
        )
    
    context = {
        'orders': orders_query,
        'all_statuses': Order.OrderStatus.choices,
        'current_status': status_filter,
        'current_payment_status': payment_status_filter,
        'filter_type': filter_type,
    }
    return render(request, 'mg_orders/order_list.html', context)

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
@require_POST
def order_accept(request, order_id):
    order = get_object_or_404(Order, id=order_id)
    if order.status == Order.OrderStatus.NEW:
        order.status = Order.OrderStatus.ACCEPTED
        order.save()
        messages.success(request, f'注文(ORD-{order.id:06d})を受付済みにしました。')
    else:
        messages.warning(request, f'注文(ORD-{order.id:06d})は既に処理されています。')
    return redirect('dashboard:mg_orders:order_list')

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
@transaction.atomic
def order_edit(request, order_id):
    order = get_object_or_404(Order.objects.prefetch_related('items__product__variety'), id=order_id)
    if not order.is_editable:
        messages.error(request, 'この注文は発送済みまたはキャンセル済みのため編集できません。')
        return redirect('dashboard:mg_orders:order_list')

    if request.method == 'POST':
        seimai_coefficient = Decimal(settings.SEIMAI_WEIGHT_COEFFICIENT)
        
        has_changes = False
        product_content_changed = False

        # ▼▼▼ 変更点: 更新後の「あるべき姿」の注文内容を、フォーム入力から先に構築する ▼▼▼
        prospective_items_data = []
        # ▲▲▲ 変更点ここまで ▲▲▲

        new_weights_by_variety = {}

        # 既存商品の数量・単価変更
        for item in order.items.all():
            quantity_str = request.POST.get(f'quantity_{item.id}', str(item.quantity))
            price_str = request.POST.get(f'price_{item.id}', str(item.price_at_order))
            new_quantity = int(quantity_str) if quantity_str.isdigit() else item.quantity
            new_price = int(price_str) if price_str.isdigit() else item.price_at_order

            if new_quantity != item.quantity:
                has_changes = True
                product_content_changed = True
            if new_price != item.price_at_order:
                has_changes = True

            # ▼▼▼ 変更点: 0より大きい数量の商品だけを「あるべき姿」リストに追加 ▼▼▼
            if new_quantity > 0:
                prospective_items_data.append({'product_id': item.product.id, 'quantity': new_quantity})
            # ▲▲▲ 変更点ここまで ▲▲▲

            weight = item.product.weight_kg * new_quantity
            if item.product.type == Product.ProductType.SEIMAI:
                weight *= seimai_coefficient
            new_weights_by_variety[item.product.variety_id] = new_weights_by_variety.get(item.product.variety_id, Decimal('0')) + weight

        # 新規追加商品
        new_product_id = request.POST.get('new_product')
        new_product_quantity_str = request.POST.get('new_product_quantity', '0')
        new_product_quantity = int(new_product_quantity_str) if new_product_quantity_str.isdigit() else 0
        if new_product_id and new_product_quantity > 0:
            has_changes = True
            product_content_changed = True

            # ▼▼▼ 変更点: 新規商品も「あるべき姿」リストに追加 ▼▼▼
            prospective_items_data.append({'product_id': int(new_product_id), 'quantity': new_product_quantity})
            # ▲▲▲ 変更点ここまで ▲▲▲

            product = get_object_or_404(Product, id=new_product_id)
            weight = product.weight_kg * new_product_quantity
            if product.type == Product.ProductType.SEIMAI:
                weight *= seimai_coefficient
            new_weights_by_variety[product.variety_id] = new_weights_by_variety.get(product.variety_id, Decimal('0')) + weight
        
        # 在庫チェック
        weight_diff_by_variety = {v_id: new_weights_by_variety.get(v_id, 0) - order.get_total_weight_in_genmai_for_variety(v_id) for v_id in set(new_weights_by_variety.keys()) | set(item.product.variety_id for item in order.items.all())}
        stocks_to_check = Stock.objects.select_for_update().filter(variety_id__in=weight_diff_by_variety.keys())
        for stock in stocks_to_check:
            if stock.available_kg < weight_diff_by_variety.get(stock.variety_id, 0):
                messages.error(request, f"在庫不足: {stock.variety.name}")
                return redirect('dashboard:mg_orders:order_edit', order_id=order.id)

        # 変更を適用
        if has_changes:
            # ▼▼▼ 変更点: DB操作の前に、まず「あるべき姿」で判定と計算を行う ▼▼▼
            if not prospective_items_data:
                # 在庫を元に戻す処理
                for stock in stocks_to_check:
                    diff = weight_diff_by_variety.get(stock.variety_id, 0)
                    if diff != 0:
                        stock.total_ordered_kg += diff
                        stock.save(update_fields=['total_ordered_kg', 'updated_at'])
                
                order.delete()
                messages.success(request, f'注文(ORD-{order_id:06d})の全商品を削除したため、注文は自動的に削除されました。')
                return redirect('dashboard:mg_orders:order_list')
            
            if product_content_changed:
                product_ids = [item['product_id'] for item in prospective_items_data]
                products = Product.objects.in_bulk(product_ids)
                
                temp_cart_group = {
                    'destination': order.destination,
                    'items': [{'product': products[item['product_id']], 'quantity': item['quantity']} for item in prospective_items_data]
                }
                order.provisional_shipping_fee = _calculate_provisional_shipping_fee(temp_cart_group)
                order.final_shipping_fee = None
            # ▲▲▲ 変更点ここまで ▲▲▲

            # DB操作
            for stock in stocks_to_check:
                diff = weight_diff_by_variety.get(stock.variety_id, 0)
                if diff != 0:
                    stock.total_ordered_kg += diff
                    stock.save(update_fields=['total_ordered_kg', 'updated_at'])
            
            for item in order.items.all():
                new_quantity = int(request.POST.get(f'quantity_{item.id}'))
                new_price = int(request.POST.get(f'price_{item.id}'))
                if new_quantity <= 0:
                    item.delete()
                else:
                    item.quantity = new_quantity
                    item.price_at_order = new_price
                    item.save()

            if new_product_id and new_product_quantity > 0:
                product = get_object_or_404(Product, id=new_product_id)
                OrderItem.objects.create(order=order, product=product, quantity=new_product_quantity, price_at_order=product.price)

            order.save()
            messages.success(request, f'注文(ORD-{order.id:06d})を更新しました。')
        else:
            messages.info(request, '変更点がなかったため、注文は更新されませんでした。')
        
        return redirect('dashboard:mg_orders:order_edit', order_id=order.id)

    customer_destinations = Destination.objects.filter(user=order.user)
    all_products = Product.objects.filter(status=Product.ProductStatus.FOR_SALE).order_by('name')
    context = {'order': order, 'customer_destinations': customer_destinations, 'all_products': all_products}
    return render(request, 'mg_orders/order_edit.html', context)
```

##### **ファイル:** `mg_orders/urls.py` **(全面的に上書き)**

```python
# mg_orders/urls.py
from django.urls import path
from . import views
from . import api

app_name = 'mg_orders'

urlpatterns = [
    path('', views.order_list, name='order_list'),
    path('accept/<int:order_id>/', views.order_accept, name='order_accept'),
    path('edit/<int:order_id>/', views.order_edit, name='order_edit'),
    
    # API
    path('api/<int:order_id>/payment-status/', api.PaymentStatusUpdateView.as_view(), name='api_order_payment_status_update'),
]
```

#### 3. 手順2：プロジェクト全体へのURL組込み

##### **ファイル:** `dashboard/urls.py` **(全面的に上書き)**

```python
# dashboard/urls.py
from django.urls import path, include
from . import views

urlpatterns = [
    path('', views.dashboard_view, name='dashboard_top'),
    path('debug/', views.debug_view, name='debug_view'),
    path('import/', views.import_old_data_view, name='import'),
    path('manuals/', views.manual_management_view, name='manuals'),
    
    path('orders/', include('mg_orders.urls')),
    path('customers/', include('mg_customers.urls')),
    path('masters/', include('mg_masters.urls')),
    path('workflow/', include('mg_workflow.urls')),

    path('api/manuals/<str:page_name>/', views.manual_content_view, name='api_manual_content'),
    path('api/csrf/', views.csrf_seed, name='api_csrf_seed'),
]
```

#### 4. 手順3：フロントエンドの実装

##### **ファイル:** `mg_orders/templates/mg_orders/order_list.html` **(全面的に上書き)**

```html
{% extends "base_management.html" %}
{% load humanize %}
{% load static %}
{% block title %}注文管理{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center">
    <h1>注文管理</h1>
</div>
<p>全ての注文を管理します。ステータスを選択して表示を絞り込めます。</p>
<div class="mb-3">
    <div class="btn-group btn-group-sm flex-wrap" role="group">
        <a href="{% url 'dashboard:mg_orders:order_list' %}" class="btn {% if filter_type == 'active' %}btn-primary{% else %}btn-outline-primary{% endif %}">対応中の注文</a>
        <a href="?filter=all" class="btn {% if filter_type == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">すべて表示</a>
        {% for status_value, status_name in all_statuses %}
            <a href="?status={{ status_value }}" class="btn {% if current_status == status_value %}btn-primary{% else %}btn-outline-primary{% endif %}">{{ status_name }}</a>
        {% endfor %}
    </div>
</div>

{% if orders %}
    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead class="table-light">
                <tr>
                    <th style="width: 12%;">注文日時 / 状態</th>
                    <th style="width: 13%;">購入者 / お届け先</th>
                    <th>注文内容</th>
                    <th class="text-center" style="width: 10%;">入金</th>
                    <th class="text-end" style="width: 10%;">合計金額</th>
                    <th class="text-center" style="width: 10%;">操作</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                    <tr>
                        <td>
                            {{ order.created_at|date:"y/m/d H:i" }}<br>
                            <span class="badge bg-info">{{ order.get_status_display }}</span>
                        </td>
                        <td>
                            {{ order.user.username }} 様<br>
                            <small class="text-muted">→ {{ order.destination.name }} 様</small>
                        </td>
                        <td>
                            <ul class="list-unstyled mb-0 small">
                                {% for item in order.items.all %}<li>{{ item.product.name }} × {{ item.quantity }}</li>{% endfor %}
                            </ul>
                        </td>
                        <td class="text-center align-middle">
                            {% if not order.is_canceled %}
                                {% if order.payment_status == 'PAID' %}
                                    <button class="btn btn-success btn-sm w-100 btn-payment-toggle"
                                            data-order-id="{{ order.id }}"
                                            data-next-status="UNPAID">
                                        {{ order.get_payment_status_display }}
                                    </button>
                                {% else %}
                                    <button class="btn btn-warning btn-sm w-100 btn-payment-toggle"
                                            data-order-id="{{ order.id }}"
                                            data-next-status="PAID">
                                        {{ order.get_payment_status_display }}
                                    </button>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-secondary">{{ order.get_payment_status_display }}</span>
                            {% endif %}
                        </td>
                        <td class="text-end fw-bold">{{ order.total_price|intcomma }} 円</td>
                        <td class="text-center align-middle">
                            <div class="d-grid gap-1">
                                {% if order.is_acceptable %}
                                    <form action="{% url 'dashboard:mg_orders:order_accept' order.id %}" method="post" onsubmit="return confirm('この注文を受付済みにしますか？');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-primary btn-sm w-100">受付済みにする</button>
                                    </form>
                                {% endif %}
                                
                                {% if order.is_editable %}
                                    <a href="{% url 'dashboard:mg_orders:order_edit' order.id %}" class="btn btn-outline-secondary btn-sm">編集</a>
                                {% else %}
                                    <a href="#" class="btn btn-outline-secondary btn-sm disabled" aria-disabled="true">編集不可</a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div class="alert alert-info" role="alert">表示対象の注文はありません。</div>
{% endif %}

<a href="{% url 'dashboard:dashboard_top' %}" class="btn btn-secondary mt-3">&laquo; ダッシュボードに戻る</a>

<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong id="appToastTitle" class="me-auto">通知</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div id="appToastBody" class="toast-body">
      メッセージ
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/order_list.js' %}"></script>
{% endblock %}
```

##### **ファイル:** `mg_orders/templates/mg_orders/order_edit.html` **(全面的に上書き)**

```html
{% extends "base_management.html" %}
{% load humanize %}{% load l10n %}
{% block title %}注文編集 - ORD-{{ order.id|stringformat:"06d" }}{% endblock %}
{% block content %}
<h1>注文編集 <span class="fs-5 text-muted">ORD-{{ order.id|stringformat:"06d" }}</span></h1>
<p>購入者: <strong>{{ order.user.username }}</strong> 様</p><hr>
<form action="{% url 'dashboard:mg_orders:order_edit' order.id %}" method="post">{% csrf_token %}
    <div class="mb-4 p-3 border rounded"><h5>お届け先情報</h5><div class="mb-3">
        <label for="destination" class="form-label">お届け先:</label>
        <select name="destination" id="destination" class="form-select">
        {% for dest in customer_destinations %}<option value="{{ dest.id }}" {% if dest.id == order.destination.id %}selected{% endif %}>{{ dest.name }} ({{ dest.address }})</option>{% endfor %}
        </select>
    </div></div>
    <div class="mb-4 p-3 border rounded"><h5>注文明細</h5><div class="table-responsive"><table class="table">
        <thead><tr><th>商品名</th><th style="width: 15%;">数量</th><th style="width: 20%;">単価（円）</th><th class="text-end" style="width: 15%;">小計</th></tr></thead>
        <tbody>{% for item in order.items.all %}<tr>
            <td>{{ item.product.name }}</td>
            <td><input type="number" name="quantity_{{ item.id }}" value="{{ item.quantity|unlocalize }}" class="form-control" min="0"></td>
            <td><input type="number" name="price_{{ item.id }}" value="{{ item.price_at_order|unlocalize }}" class="form-control" min="0" autocomplete="off"></td>
            <td class="text-end">{% widthratio item.price_at_order|default_if_none:0 1 item.quantity as subtotal %}{{ subtotal|intcomma }}円</td>
        </tr>{% endfor %}</tbody>
        <tfoot>
            <tr><td colspan="3" class="text-end">商品小計</td><td class="text-end">{{ order.items_subtotal|intcomma }}円</td></tr>
            <tr><td colspan="3" class="text-end">送料</td><td class="text-end">{{ order.shipping_fee|intcomma }}円</td></tr>
            <tr class="fs-5 table-light"><td colspan="3" class="text-end"><strong>総合計</strong></td><td class="text-end"><strong>{{ order.total_price|intcomma }}円</strong></td></tr>
        </tfoot>
    </table></div><p class="form-text">※数量を0にして更新すると、その商品は注文から削除されます。</p></div>
    <div class="mb-4 p-3 border rounded bg-light"><h5>商品の追加</h5><div class="row g-2 align-items-end">
        <div class="col-md-8"><label for="new_product" class="form-label">商品:</label>
            <select name="new_product" id="new_product" class="form-select"><option value="">--- 商品を選択 ---</option>
            {% for product in all_products %}<option value="{{ product.id }}">{{ product.name }}</option>{% endfor %}</select>
        </div>
        <div class="col-md-4"><label for="new_product_quantity" class="form-label">数量:</label><input type="number" name="new_product_quantity" id="new_product_quantity" class="form-control" value="0" min="0"></div>
    </div></div>
    <div class="d-grid gap-2"><button type="submit" class="btn btn-success btn-lg">この内容で注文を更新する</button><a href="{% url 'dashboard:mg_orders:order_list' %}" class="btn btn-secondary">« 注文一覧に戻る</a></div>
</form>
{% endblock %}
```

##### **ファイル:** `static/js/order_list.js` **(全面的に上書き)**

```javascript
// static/js/order_list.js

(() => {
  let appToastInstance = null;

  function showToast(message, type = 'success') {
      if (!appToastInstance) {
          alert(message);
          return;
      }
      const toastEl = appToastInstance._element;
      const toastHeader = toastEl.querySelector('.toast-header');
      const toastTitle = toastEl.querySelector('#appToastTitle');
      const toastBody = toastEl.querySelector('#appToastBody');
      
      toastBody.textContent = message;
      toastHeader.classList.remove('bg-success', 'bg-danger', 'text-white');

      if (type === 'success') {
          toastTitle.textContent = '成功';
          toastHeader.classList.add('bg-success', 'text-white');
      } else {
          toastTitle.textContent = 'エラー';
          toastHeader.classList.add('bg-danger', 'text-white');
      }
      appToastInstance.show();
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  }

  async function api(path, { method = 'GET', json, headers = {} } = {}) {
    const hds = { 'X-CSRFToken': getCookie('csrftoken'), ...headers };
    let body;
    if (json !== undefined) {
      hds['Content-Type'] = 'application/json';
      body = JSON.stringify(json);
    }
    const res = await fetch(path, { method, headers: hds, body });
    const data = await res.json().catch(() => null);
    return { ok: res.ok, status: res.status, data };
  }

  async function handlePaymentStatusUpdate(orderId, newStatus, button) {
      button.disabled = true;
      const originalText = button.innerHTML;
      button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 更新中...';

      const res = await api(`/management/orders/api/${orderId}/payment-status/`, {
          method: 'POST',
          json: { payment_status: newStatus }
      });
      
      if (res.ok) {
        showToast(res.data.message, 'success');
        setTimeout(() => location.reload(), 1500);
      } else {
        showToast(res.data?.error?.message || '更新に失敗しました。', 'danger');
        button.disabled = false;
        button.innerHTML = originalText;
      }
  }

  document.addEventListener('DOMContentLoaded', () => {
      const toastEl = document.getElementById('appToast');
      if (toastEl) {
        appToastInstance = new bootstrap.Toast(toastEl, { delay: 4000 });
      }

      document.body.addEventListener('click', (e) => {
          const button = e.target.closest('.btn-payment-toggle');
          if (button) {
              e.preventDefault();
              const { orderId, nextStatus } = button.dataset;
              handlePaymentStatusUpdate(orderId, nextStatus, button);
          }
      });
  });
})();
```

#### 5. 手順4：データベースへの反映と動作確認

1. **データベースマイグレーションの実行:**
    この手順書ではモデル構造に変更がないため、マイグレーションコマンドの実行は不要です。

2. **動作確認:**
    * 管理者としてログインし、サイドバーから「注文管理」にアクセスします。
        * **注文一覧画面:**
        * URLが`/management/orders/`となっていることを確認します。
        * 「対応中の注文」「すべて表示」「新規注文」などのフィルタが正しく機能することを確認します。
        * 「入金」列のボタンをクリックすると、ステータスが非同期で切り替わり、成功メッセージが表示された後、画面がリロードされることを確認します。
    * **注文受付機能:**
        * ステータスが「新規注文」の注文にある「受付済みにする」ボタンをクリックし、注文ステータスが正しく更新されることを確認します。
    * **注文編集機能:**
        * いずれかの注文の「編集」ボタンをクリックし、URLが`/management/orders/edit/<order_id>/`の画面に遷移することを確認します。
        * お届け先の変更、商品数量・単価の変更、商品の新規追加を行い、「在庫マスタ」の数値が正しく連動することを確認します。
        * 在庫を超える数量に変更しようとすると、エラーメッセージが表示され、更新ができないことを確認します。
