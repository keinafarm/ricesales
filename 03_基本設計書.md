### **【成果物 3/11】 `03_基本設計書` (Ver. 5.2)**

#### **1. はじめに**
本ドキュメントは、「お米販売システム 要件定義書」に基づき、システムの外部仕様および基本構造を定義するものである。本設計書は、後続の詳細設計および実装工程のインプットとなる。

#### **2. システム構成**
*   **バックエンド:** Djangoフレームワーク
*   **フロントエンド:** Bootstrap 5, JavaScript (動的なUIはAPI経由でバックエンドと通信)
*   **データベース:** MySQL
*   **インフラストラクチャ:** Dockerコンテナとして稼働。本番環境では`traefik`（リバースプロキシ）によるHTTPS化を想定。

#### **3. アプリケーション設計**
本システムは、機能ごとに明確に責務が分割された以下のDjangoアプリケーション群で構成される。

| アプリケーション名 | 役割と責務 |
| :--- | :--- |
| **`accounts`** | **人に関するデータ管理:** 顧客 (`User`) とお届け先 (`Destination`) のモデルを定義し、認証機能を提供する。 |
| **`products`** | **モノの定義データ管理:** 品種 (`ProductVariety`)、商品 (`Product`)、在庫 (`Stock`) のマスターデータを管理する。 |
| **`orders`** | **取引と物理的なモノの状態管理:** 注文 (`Order`, `OrderItem`)、引当 (`Allocation`)、物理的な袋 (`Bag`)、荷物 (`Package`) といった、業務フローの中核となるモデル群を定義する。 |
| **`cart`** | **一時的な状態管理:** ログインユーザーのセッションに基づき、ショッピングカート機能を提供する。 |
| **`system_settings`** | **システム全体の設定値管理:** 店舗情報、送料、各種係数、振込先口座情報など、システム全体で共有される設定値を管理する。 |
| **`dashboard`** | **管理者向け機能の統括（司令塔）:** 管理者向けトップページ（ToDoリスト）、デバッグ画面、データ移行、マニュアル管理など、特定のカテゴリに属さない横断的な機能を提供する。 |
| **`mg_orders`** | **【管理者】注文管理:** 注文の一覧表示、受付、編集機能および関連APIを提供する。 |
| **`mg_customers`** | **【管理者】顧客管理:** 顧客の一覧表示、新規作成、詳細編集機能および関連APIを提供する。 |
| **`mg_masters`** | **【管理者】マスタ管理:** 品種・商品・在庫のCRUD機能および関連APIを提供する。 |
| **`mg_workflow`** | **【管理者】出荷ワークフロー:** 袋詰管理、自動引当ボード、発送管理の各画面と、それらを支える複雑なビジネスロジックおよびAPI群を提供する。 |

#### **4. 機能一覧**

##### **4.1. 購入者向け機能**
*   ログイン・ログアウト機能（日本語ID対応）
*   商品一覧表示機能（お届け先選択、**購入可能在庫数**の表示）
*   配送グループ別ショッピングカート機能（お届け先ごとに独立したカート、**リアルタイム在庫チェック**）
*   **注文内容一括確認機能（参考送料表示）:** カート内の商品を基に梱包シミュレーションを行い、「参考送料」と「参考合計額」を提示する。
*   注文確定機能（複数のお届け先への注文を一括で生成、**最終在庫チェック**、**参考送料の保存**）
*   注文完了後の注文履歴一覧へのリダイレクト
*   注文履歴表示機能（キャンセル済み注文の表示/非表示フィルタ）
*   **注文詳細表示・ステータス確認機能:** 送料が参考値か確定値かを含めて、注文の状態を確認できる。
*   **配送状況確認機能:** 注文に紐づく荷物（パッケージ）が出荷された場合、伝票番号と配送業者の追跡サイトへのリンクを表示する。
*   注文変更機能（数量変更）（ステータスが「新規注文」の場合のみ、非同期通信によるスムーズな編集）
*   注文キャンセル機能（ステータスが「新規注文」の場合のみ）
*   **複数注文一括請求書PDFダウンロード機能:** 注文の送料確定状態に応じて、暫定の合計額または確定の合計額を記載した請求書を都度生成する。

##### **4.2. 管理者向け機能**
*   ログイン・ログアウト機能
*   ダッシュボード（ToDoリスト）表示機能
*   **注文管理:**
    *   統合注文一覧表示機能（「対応中」「全件」「ステータス別」の強力なフィルタ機能）
    *   注文受付機能（ステータスを「新規注文」から「注文受付」へ変更）
    *   高機能な注文編集機能（お届け先、商品数量、商品単価の変更、および販売中の全商品からの新規追加）。**商品内容の変更時には、`final_shipping_fee`は自動的に`NULL`に戻される。**
*   **出荷ワークフロー管理:**
    *   要袋詰リスト表示機能（品種・容量ごとに必要な袋数を自動集計して表示）
    *   袋詰完了登録機能
    *   自動パッケージング提案機能（同一宛先の袋を、箱数最小化・同一品種優先の原則で自動箱詰めして提案）
    *   **パッケージングの確定・解除機能:** パッケージを「発送準備完了」状態に移行、または編集可能な状態に差し戻す。宛先の全パッケージが確定したタイミングで、**最終的な送料を自動計算し、注文の`final_shipping_fee`を更新**する。
*   **発送管理:**
    *   発送対象パッケージ一覧表示機能（ステータスが「発送準備完了」「伝票印刷済み」「発送済み」「手渡し済み」のパッケージを一覧表示）
    *   ヤマトB2用CSV出力機能（選択したパッケージからCSVを都度動的に生成・ダウンロードする。CSV出力の履歴をパッケージごとに保持する）
    *   ヤマトB2用CSVインポート機能: B2クラウドから出力された伝票番号付きCSVをアップロードすることで、システム内のパッケージ情報に伝票番号を自動で紐付ける。
    *   発送ステータス管理機能（「CSV出力後」のパッケージを「伝票印刷済み」に更新する機能、および各状態への段階的差し戻し機能）
    *   手渡し完了登録機能（「発送準備完了」のパッケージを「手渡し済み」に更新）
*   **顧客管理:**
    *   ダッシュボード統合UI: Django管理サイトではなく、システム専用画面で全ての顧客管理操作を行う。
    *   顧客の検索、ソート、新規作成、および詳細情報の編集機能。
    *   顧客に紐づくお届け先情報のCRUD操作を非同期通信で実現。
*   **入金管理:**
    *   注文情報に「未入金」「入金済み」のステータスを保持し、一覧画面からトグル操作で変更可能。
*   **在庫管理:**
    *   ダッシュボード統合UI: 品種ごとの玄米換算での在庫を管理する。システムは「**総供給量**」と「**総注文量**」をデータとして保持し、「現在在庫量」は両者の差分から動的に計算される。管理者は、専用UIから「総供給量」を**調整量（増減）で更新**する。
*   **マスターデータ管理:**
    *   ダッシュボード統合UI: 品種マスタ、商品マスタのCRUD操作を専用画面で提供する。
    *   動的価格提案: 商品の作成・編集時、品種や容量の変更に応じて提案価格をリアルタイムで自動計算し、管理者の価格設定を支援する。
    *   安全な削除: 注文等に紐づく商品は削除ボタンが非活性化される。
*   **システム設定:**
    *   依頼主情報（ご請求先顧客コード含む）、送料、各種計算係数、請求書の振込先口座情報などは、Django管理サイトで設定する。
*   **旧システムデータ移行:**
    *   旧システムからエクスポートしたSQLファイルを専用画面からアップロードすることで、顧客およびお届け先情報を一括で安全に取り込むことができる。

#### **5. 画面・UI/UX設計**

##### **5.1. 画面一覧**
###### **共通画面**
*   `SCR-CM-010`: ログイン画面

###### **購入者向け画面**
*   `SCR-PU-010`: 商品一覧画面
*   `SCR-PU-030`: 注文内容確認画面
*   `SCR-PU-050`: 注文履歴一覧画面
*   `SCR-PU-060`: 注文詳細画面

###### **管理者向け画面**
*   `SCR-AD-010`: ダッシュボード画面
*   `SCR-AD-020`: 注文管理画面
*   `SCR-AD-030`: 注文編集画面
*   `SCR-AD-040`: 袋詰管理画面
*   `SCR-AD-050`: 自動引当・パッケージング提案ボード
*   `SCR-AD-060`: 発送管理画面
*   `SCR-AD-070`: 顧客一覧画面
*   `SCR-AD-071`: 顧客詳細・編集画面
*   `SCR-AD-081`: 品種マスタ一覧・編集画面
*   `SCR-AD-083`: 商品マスタ一覧・編集画面
*   `SCR-AD-085`: 在庫マスタ一覧・編集画面
*   `SCR-AD-087`: オンラインマニュアル管理画面
*   `SCR-AD-089`: 旧システムデータ移行画面
*   `SCR-AD-099`: 開発者向けデバッグ画面

##### **5.2. 画面レイアウト基本設計**
*   **構造:** 画面は「サイドバー」と「メインコンテンツ」で構成される。
*   **サイドバー内容:**
    *   **購入者向け:** ナビゲーション（商品一覧, 注文履歴）、**在庫状況（品種ごとの残り在庫量とカート内消費量）**、カート情報（お届け先別の内容と合計額）を表示。
    *   **管理者向け:** ナビゲーション（ダッシュボード、注文管理、顧客管理、出荷ワークフロー[ドロップダウン]、マスタ管理[ドロップダウン]、システム設定[ドロップダウン]）、袋在庫サマリーを表示。

##### **5.3. 主要画面ロジックとアーキテクチャ**

*   **在庫計算アーキテクチャ:**
    *   **モデル:** `products.Stock`モデルが品種ごとに「総供給量」と「総注文量」を保持する。`orders.Order`モデルに、注文合計重量（玄米換算）を計算するヘルパーメソッドを追加。
    *   **コンテキストプロセッサ:** `dashboard.context_processors.stock_summary`が、全購入者向けページに対し、現在の在庫状況（カート内消費量を含む）を計算して提供する。
    *   **ビュー:** `products.views.product_list`が、各商品が購入可能な残り個数（カート内の同一品種商品の消費量を考慮）を計算し、テンプレートに渡す。
    *   **API:** `cart.views.update_cart`が、カート更新時に在庫を排他ロックしてリアルタイムチェックを行う。
    *   **注文処理:** `orders.views`および`mg_orders.views`内の注文作成・変更・キャンセル処理は、全てデータベーストランザクション内で`Stock.total_ordered_kg`を安全に更新する。

*   **`SCR-PU-030`: 注文内容確認画面**
    *   **アーキテクチャ:**
        *   画面表示時、バックエンド(`orders/views.py`)はカート内の全お届け先グループを対象に、**管理者向けの自動梱包ロジックを呼び出して梱包シミュレーションを実行**する。
        *   シミュレーション結果（必要な箱数）と、お届け先の送料区分から**「参考送料」**を算出する。
        *   フロントエンドは、商品リストと共に「参考送料」と注釈を表示する。
        *   注文確定時、この参考送料は`Order.provisional_shipping_fee`に保存される。

*   **`SCR-PU-060`: 注文詳細画面**
    *   **ロジック:**
        *   `Order`モデルの`final_shipping_fee`が`NULL`でないかを確認し、送料が確定済みか否かを画面に表示する。
        *   注文ステータスが「新規注文」の場合のみ「この注文内容を変更する」ボタンを表示。ボタンを押すと、画面遷移せずにその場で数量が入力フォームに変わり、非同期通信で更新処理を行う。
        *   注文に関連する荷物（パッケージ）が「発送済み」などのステータスの場合、「配送状況」セクションを表示し、箱ごとのステータスと伝票番号（追跡サイトへのリンク付き）を提示する。

*   **`SCR-AD-050`: 自動引当・パッケージング提案ボード**
    *   **アーキテクチャ:** フロントエンドのJavaScript (`mg_workflow/static/js/packaging_board.js`) が司令塔となり、画面全体の描画、フィルター操作、ドラッグ＆ドロップなどのユーザーインタラクションを管理する。データの取得・更新は全てバックエンド (`mg_workflow/api_packaging.py`) のAPI群を非同期で呼び出すことで実行され、**操作のたびに全状態を再取得・再描画する**設計により、状態の整合性を担保する。
    *   **送料確定ロジック:**
        *   管理者が箱の「確定」ボタンを押した際、API(`mg_workflow/api_packaging.py`)は、その箱が属するお届け先の全注文（`Order`）を取得する。
        *   次に、そのお届け先の全荷物（`Package`）が「発送準備完了」以上のステータスになっているかを確認する。
        *   もし全ての荷物の梱包が完了していれば、荷物の総数に基づいて**最終送料を計算**し、関連する全`Order`の**`final_shipping_fee`フィールドを更新**する。

*   **`SCR-AD-060`: 発送管理画面**
    *   **アーキテクチャ:** 上記「自動引当ボード」と同様のアーキテクチャを採用。フロントエンド (`mg_workflow/static/js/shipping_list.js`) がUIを管理し、バックエンド (`mg_workflow/api_shipping.py`) のAPI群と連携する。
    *   **操作フロー:**
        1.  **CSVエクスポート:** ユーザーは荷物をチェックし、「CSV出力」ボタンでB2用CSVをダウンロードする。
        2.  **伝票番号CSVインポート:** 画面上部の「伝票番号CSV取込」ボタンから、ヤマトB2で発行済みのCSVファイルをアップロードする。システムが「お客様管理番号」をキーに、自動で伝票番号を各パッケージに紐付ける。
        3.  **ステータス更新:** B2での作業完了後、「伝票印刷済みにする」「発送済みにする」等のボタンでステータスを更新する。

*   **`SCR-AD-071`: 顧客詳細・編集画面**
    *   **アーキテクチャ:** 顧客の基本情報（ログインID、メール）の編集、パスワード再設定、お届け先情報のCRUD操作は、全てAPI (`mg_customers/api.py`) との非同期通信によって画面遷移なく実行される。

*   **`SCR-AD-083`: 商品マスタ作成・編集画面**
    *   **アーキテクチャ:**
        *   商品の品種、種類、容量、価格係数などのフォーム入力値をトリガーとして、API (`mg_masters/api.py`) にリクエストを送信。
        *   APIは返却値として提案価格を計算し、フロントエンドはそれをリアルタイムで画面に表示することで、管理者の価格設定を支援する。
        
*   **`SCR-AD-085`: 在庫マスタ一覧・編集画面**
    *   **アーキテクチャ:**
        *   フロントエンド (`mg_masters/templates/mg_masters/stock_list.html`) は、品種ごとに現在の在庫情報と「調整量」の入力欄を表示する。
        *   フォーム送信時、バックエンド (`mg_masters/views.py`) は「調整量」を受け取り、トランザクション内で`Stock.total_supplied_kg`を加算または減算する。

#### **6. データベース設計（論理設計）**
*(本システムの詳細なデータベース構造（テーブル定義、リレーションシップ）については、別紙「`04_データベース設計書`」で定義する)*

#### **7. 外部インターフェース設計**

*   **ヤマトB2クラウド連携用CSV**
    *   **エクスポート:**
        *   **ファイル形式:** 文字コード: `Shift_JIS`, 区切り文字: `カンマ (,)`
        *   **主要カラムの生成ロジック:**
            *   `お客様管理番号`: `PKG{package.id}` の形式で出力し、インポート時のキーとする。
            *   `お届け先電話番号枝番`: お届け先電話番号が依頼主電話番号と一致する場合のみ、重複エラー回避のため `destinations.id` を出力する。
            *   `ご請求先顧客コード`: `system_settings.b2_customer_code` の値を出力する。
            *   `品名１`: 箱の中身を「品種(頭2文字)＋精/玄＋重量(数字)x数量」の形式で連結した文字列を、25文字以内で出力する。
    *   **インポート:**
        *   **ファイル形式:** ヤマトB2クラウドから「発行済み」のCSVファイルを想定。文字コード: `Shift_JIS`。
        *   **主要カラムの解釈:** 1列目の `お客様管理番号` をキーにシステム内の荷物（`Package`）を特定し、4列目の `伝票番号` を取り込んでデータベースを更新する。

*   **旧システムデータ移行用SQL**
    *   **インポート:**
        *   **ファイル形式:** 旧システムからエクスポートされた、UTF-8エンコードのSQLファイル。日本語テーブル名（`販売システムユーザー`, `顧客名簿`）を含む `INSERT` 文で構成されることを想定。
        *   **解釈ロジック:** SQLファイルをテキストとして解析し、`INSERT`文からテーブル名と値のタプルを抽出。定義されたマッピングルールに基づき、新システムの`User`および`Destination`モデルにデータを登録する。
