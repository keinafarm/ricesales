
### **【補足資料1】カスタム管理コマンド 実装手順書**

#### **1. 目的**

システムの現在のパッケージング状態を詳細なJSON形式で出力するカスタム管理コマンド `packaging_snapshot` を実装します。これは、デバッグや特定時点での状態記録に利用できます。

#### **2. 手順1：ソースコードの配置**

1. `dashboard/management/commands/` ディレクトリ内に `packaging_snapshot.py` というファイルを**新規作成**します。
2. ファイルの内容を、**以下の聖典のコードで全面的に上書き**してください。

    ```python
    # dashboard/management/commands/packaging_snapshot.py (聖典準拠の完全版)
    from django.core.management.base import BaseCommand
    from django.conf import settings
    from django.db.models import Sum, Count, F
    from collections import defaultdict
    import json

    from orders.models import Order, OrderItem, Allocation, Bag, Package, PackageItem, PackagePlanItem
    from products.models import Product

    class Command(BaseCommand):
        help = "Dump packaging-related snapshot (orders/allocations/bags/packages/plans, weights/headroom) as JSON."

        def handle(self, *args, **opts):
            # (ご提供いただいたソースコードをここに記述)
            max_box = float(getattr(settings, "PACKAGE_MAX_WEIGHT_KG", 25.0))
            box_tare = float(getattr(settings, "DEFAULT_BOX_WEIGHT_KG", 0.0))
            product_weights = {p.id: float(getattr(p, "weight_kg", 0) or 0) for p in Product.objects.all()}
            orders_q = (OrderItem.objects.filter(order__status__in=[Order.OrderStatus.NEW, Order.OrderStatus.ACCEPTED, Order.OrderStatus.PACKED, Order.OrderStatus.SHIPPED, Order.OrderStatus.DELIVERED,]).values("order__destination_id", "product_id").annotate(ordered=Sum("quantity")))
            orders = defaultdict(dict)
            for r in orders_q:
                dest_id = r["order__destination_id"]
                pid = r["product_id"]
                orders[dest_id][pid] = int(r["ordered"] or 0)
            alloc_q = (Allocation.objects.values("order_item__order__destination_id", "bag__product_id").annotate(allocated=Count("id")))
            allocations = defaultdict(dict)
            for r in alloc_q:
                dest_id = r["order_item__order__destination_id"]
                pid = r["bag__product_id"]
                allocations[dest_id][pid] = int(r["allocated"] or 0)
            packaged_bag_ids = set(PackageItem.objects.values_list("bag_id", flat=True))
            prep_q = (Bag.objects.filter(prepared=True).exclude(id__in=packaged_bag_ids).values("allocation__order_item__order__destination_id", "product_id").annotate(prepared=Count("id")))
            prepared = defaultdict(dict)
            for r in prep_q:
                dest_id = r["allocation__order_item__order__destination_id"]
                if dest_id is None: continue
                pid = r["product_id"]
                prepared[dest_id][pid] = int(r["prepared"] or 0)
            dest_packages = defaultdict(list)
            for p in Package.objects.select_related("destination").prefetch_related("items__bag", "plan_items__product"):
                dest_id = p.destination_id
                items = []
                plans = []
                cur_w = float(box_tare)
                for it in p.items.select_related("bag__product"):
                    pid = it.bag.product_id
                    w = float(product_weights.get(pid, getattr(getattr(it.bag, "product", None), "weight_kg", 0) or 0))
                    items.append({"product_id": pid, "weight_kg": w, "bag_id": it.bag_id, "package_item_id": it.id})
                    cur_w += w
                for pl in p.plan_items.select_related("product"):
                    pid = pl.product_id
                    w = float(product_weights.get(pid, getattr(getattr(pl, "product", None), "weight_kg", 0) or 0))
                    qty = int(pl.quantity or 0)
                    plans.append({"product_id": pid, "quantity": qty, "weight_kg": w})
                    cur_w += w * qty
                headroom = max(0.0, float(max_box) - cur_w)
                dest_packages[dest_id].append({"id": p.id, "label": p.label, "items": items, "plans": plans, "current_weight_kg": round(cur_w, 3), "headroom_kg": round(headroom, 3)})
            packaged_q = (PackageItem.objects.values("package__destination_id", "bag__product_id").annotate(cnt=Count("id")))
            packaged = defaultdict(dict)
            for r in packaged_q:
                dest_id = r["package__destination_id"]
                pid = r["bag__product_id"]
                packaged[dest_id][pid] = int(r["cnt"] or 0)
            planned_q = (PackagePlanItem.objects.values("package__destination_id", "product_id").annotate(q=Sum("quantity")))
            planned = defaultdict(dict)
            for r in planned_q:
                dest_id = r["package__destination_id"]
                pid = r["product_id"]
                planned[dest_id][pid] = int(r["q"] or 0)
            placeholders = []
            all_dest_ids = set(orders.keys()) | set(dest_packages.keys()) | set(allocations.keys()) | set(packaged.keys()) | set(planned.keys())
            for dest_id in all_dest_ids:
                prod_ids = set()
                prod_ids |= set(orders.get(dest_id, {}).keys())
                prod_ids |= set(allocations.get(dest_id, {}).keys())
                prod_ids |= set(packaged.get(dest_id, {}).keys())
                prod_ids |= set(planned.get(dest_id, {}).keys())
                for pid in sorted(prod_ids):
                    ordered = int(orders.get(dest_id, {}).get(pid, 0))
                    alloc = int(allocations.get(dest_id, {}).get(pid, 0))
                    pkgd = int(packaged.get(dest_id, {}).get(pid, 0))
                    plan = int(planned.get(dest_id, {}).get(pid, 0))
                    remaining = max(0, ordered - (alloc + pkgd + plan))
                    placeholders.append({"destination_id": dest_id, "product_id": pid, "ordered": ordered, "allocated": alloc, "packaged": pkgd, "planned_total": plan, "remaining": remaining, "weight_kg": float(product_weights.get(pid, 0.0))})
            out = {"settings": {"PACKAGE_MAX_WEIGHT_KG": float(max_box), "DEFAULT_BOX_WEIGHT_KG": float(box_tare)}, "product_weights": product_weights, "prepared_groups": [{"destination_id": d, "product_id": pid, "qty": qty, "weight_kg": float(product_weights.get(pid, 0.0))} for d, dd in prepared.items() for pid, qty in dd.items()], "destinations": [{"id": d, "packages": dest_packages.get(d, [])} for d in sorted(all_dest_ids)], "placeholders": placeholders}
            self.stdout.write(json.dumps(out, ensure_ascii=False, indent=2))
    ```

#### **3. 手順2：実行方法**

ターミナルから以下のコマンドを実行すると、現在のシステムの状態がJSON形式で標準出力されます。

```bash
docker-compose -f docker-compose.dev.yml exec app python manage.py packaging_snapshot
```

---

### **【補足資料2】静的資産の配置と設定**

#### **1. 目的**

自動引当ボードのドラッグ＆ドロップ機能と、請求書PDFの日本語表示を正しく動作させるために必要な、外部の静的ファイルをプロジェクトに配置します。

#### **2. 手順1：Sortable.js の配置**

1. **ダウンロード:**
    * Webブラウザで [SortableJSの公式サイト](https://sortablejs.github.io/Sortable/) にアクセスします。
    * バージョン **1.15.2** の `sortable.min.js` をダウンロードします。
2. **配置:**
    * プロジェクトの `static/` ディレクトリ内に `vendor/` ディレクトリを、さらにその中に `sortablejs/` ディレクトリを**新規作成**します。
    * ダウンロードした `sortable.min.js` ファイルを、作成した `static/vendor/sortablejs/` ディレクトリ内に配置します。
    * （`output.txt`にある`LICENSE`ファイルも同様に配置すると完全です）

#### **3. 手順2：日本語フォントの配置**

1. **ダウンロード:**
    * Webブラウザで [IPAフォントの公式サイト](https://moji.or.jp/ipafont/ipafontdownload/) にアクセスします。
    * 「IPAexゴシック(ipaexg)」をダウンロードします。
2. **配置:**
    * プロジェクトの `static/` ディレクトリ内に `fonts/` ディレクトリを**新規作成**します。
    * ダウンロード・解凍したフォントファイルの中から `ipaexg.ttf` を、作成した `static/fonts/` ディレクトリ内に配置します。

---

### **【補足資料3】Django管理サイトと共通テンプレート設定**

#### **1. 目的**

Django管理サイトでのモデル表示を最適化し、404エラーページをカスタムデザインで表示するための設定を行います。

#### **2. 手順1：各アプリケーションの `admin.py` 設定**

各アプリケーションの `admin.py` ファイルを、以下の聖典コードでそれぞれ**全面的に上書き**してください。（記載のないものはデフォルトのままとします）

**`accounts/admin.py`**

```python
# (ご提供いただいたソースコードをここに記述)
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin as BaseUserAdmin
from django.contrib.auth.forms import UserCreationForm
from .models import User, Destination

class CustomUserCreationForm(UserCreationForm):
    class Meta(UserCreationForm.Meta):
        model = User

class DestinationInline(admin.TabularInline):
    model = Destination
    extra = 1
    fields = ('name', 'postal_code', 'address', 'phone', 'delivery_method', 'shipping_zone')

@admin.register(User)
class UserAdmin(BaseUserAdmin):
    inlines = [DestinationInline]
    add_form = CustomUserCreationForm
    add_fieldsets = ((None, {'classes': ('wide',), 'fields': ('username', 'password',)}),)
    class Media:
        js = ('accounts/js/admin_password_toggle.js',)
```

**`orders/admin.py`**
```python
# (ご提供いただいたソースコードをここに記述)
from django.contrib import admin
from .models import Order, OrderItem, Bag, Package, PackageItem

class OrderItemInline(admin.TabularInline):
    model = OrderItem
    extra = 1

@admin.register(Order)
class OrderAdmin(admin.ModelAdmin):
    list_display = ('id', 'user', 'status', 'is_paid', 'created_at')
    list_filter = ('status', 'is_paid')
    inlines = [OrderItemInline]

@admin.register(Bag)
class BagAdmin(admin.ModelAdmin):
    list_display = ('id', 'product', 'prepared', 'get_order_item', 'created_at')
    list_select_related = ('product', 'allocation__order_item__order')
    search_fields = ('product__name',)

    def get_order_item(self, obj):
        return getattr(getattr(obj, 'allocation', None), 'order_item', None)
    get_order_item.short_description = '紐づく注文明細'

@admin.register(Package)
class PackageAdmin(admin.ModelAdmin):
    list_display = ('id', 'destination', 'status', 'created_at')
    list_filter = ('status',)

@admin.register(PackageItem)
class PackageItemAdmin(admin.ModelAdmin):
    list_display = ('id', 'package', 'bag')
```

**`products/admin.py`**

```python
# (ご提供いただいたソースコードをここに記述)
from django.contrib import admin
from .models import ProductVariety, Product, Stock

@admin.register(ProductVariety)
class ProductVarietyAdmin(admin.ModelAdmin):
    list_display = ('name', 'base_weight_kg', 'base_price')

@admin.register(Product)
class ProductAdmin(admin.ModelAdmin):
    list_display = ('name', 'variety', 'type', 'weight_kg', 'status', 'price_coefficient')
    list_filter = ('status', 'type', 'variety')
    search_fields = ('name',)
    readonly_fields = ('name',)

@admin.register(Stock)
class StockAdmin(admin.ModelAdmin):
    list_display = ('variety', 'weight_kg', 'updated_at')
    search_fields = ('variety__name',)
```

**`system_settings/admin.py`**

```python
# (ご提供いただいたソースコードをここに記述)
from django.contrib import admin
from django.urls import reverse
from django.utils.html import format_html
from .models import SystemSetting, BankAccount

class BankAccountInline(admin.TabularInline):
    model = BankAccount
    extra = 1
    fields = ('title', 'details', 'order')

@admin.register(SystemSetting)
class SystemSettingAdmin(admin.ModelAdmin):
    inlines = [BankAccountInline]
    list_display = ('display_name_link', 'shop_name')

    def display_name_link(self, obj):
        """ shop_nameが空でもリンクが表示されるようにするカスタムメソッド """
        url = reverse('admin:system_settings_systemsetting_change', args=[obj.pk])
        # shop_nameが空の場合はオブジェクトのデフォルト文字列（"1 システム設定"など）を表示
        display_text = obj.shop_name or str(obj)
        return format_html('<a href="{}">{}</a>', url, display_text)
    display_name_link.short_description = "設定項目"

    def has_add_permission(self, request):
        return not SystemSetting.objects.exists()

    def has_delete_permission(self, request, obj=None):
        return False

    def response_add(self, request, obj, post_url_continue=None):
        return self.response_change(request, obj)
        
    def response_change(self, request, obj):
        return super().response_change(request, obj)
```

#### **3. 手順2：404エラーページの作成**

1. `templates/` ディレクトリ直下に `404.html` というファイルを**新規作成**します。
2. ファイルの内容を、**以下の聖典のコードで全面的に上書き**してください。

    ```html
    <!-- templates/404.html (聖典準拠の完全版) -->
    {% extends "base.html" %}

    {% block title %}ページが見つかりません{% endblock %}

    {% block content %}
    <div class="text-center">
        <h1 class="display-1">404</h1>
        <h2>ページが見つかりません</h2>
        <p>
            お探しのページは、移動または削除された可能性があります。<br>
            お手数ですが、以下のリンクからトップページにお戻りください。
        </p>
        <a href="{% url 'products:product_list' %}" class="btn btn-primary mt-3">トップページに戻る</a>
    </div>
    {% endblock %}
    ```
```
