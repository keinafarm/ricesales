
### **【機能単位】アカウント・認証機能 実装手順書 (Ver. 3.0)**

#### **【作業前確認】対象ファイル一覧**

今回のタスク「アカウント・認証機能」では、以下の聖典ファイルを参照・作成します。お手元のファイル群にこれらが全て含まれているか、ご確認ください。

*   **モデル定義:**
    *   `accounts/models.py`
*   **バックエンド:**
    *   `accounts/views.py`
    *   `accounts/urls.py`
*   **フロントエンド（ログイン画面）:**
    *   `templates/registration/login.html`
*   **Django管理サイト連携:**
    *   `accounts/admin.py`
    *   `accounts/static/accounts/js/admin_password_toggle.js`

上記ファイルが揃っていることを確認いたしましたので、実装手順書を作成します。

---

#### 1. 目的

この手順書は、`10_開発環境構築手順書`までが完了したクリーンな状態から、システムの根幹となる**顧客アカウント（認証）と、それに紐づくお届け先の管理機能**を実装するための公式ドキュメントです。

この手順書を適用することで、これまで不明確だった`accounts`アプリケーションの全機能が実装され、以下の仕様が実現されます。

*   **日本語対応カスタムユーザーモデル:** ログインIDに日本語（ひらがな、カタカナ、漢字）やスペースを利用できる`User`モデルを定義します。
*   **お届け先モデル:** 顧客ごとに複数の配送先住所を管理し、それぞれに「配送方法」と「送料区分」を設定できる`Destination`モデルを定義します。
*   **役割ベースのリダイレクト:** ログイン後、ユーザーが管理者（スタッフ）であれば管理者向けダッシュボードへ、一般の購入者であれば商品一覧ページへと自動的に振り分けます。
*   **UI/UXが改善されたログイン画面:** 専用のスタイルが適用され、パスワードの表示/非表示を切り替える「目玉アイコン」を持つログイン画面を実装します。
*   **強化された管理者サイト:** Django管理サイトのユーザー編集画面で、お届け先情報をインラインで同時に編集可能にし、利便性を向上させます。

#### 2. 前提条件
*   `10_開発環境構築手順書.md`に記載された手順がすべて完了していること。
*   `docker-compose ... exec app python manage.py startapp accounts` コマンドが実行され、`accounts`アプリケーションのディレクトリが作成済みであること。

#### 3. 手順1：モデルの定義 (`accounts/models.py`)

顧客アカウント（`User`）と、それに紐づくお届け先（`Destination`）のデータ構造を定義します。日本語のログインIDを許可するためのカスタムバリデーターもここで実装します。

1.  `accounts/models.py` をエディタで開きます。
2.  ファイルの内容を、**以下の聖典のコードで全面的に上書き**してください。

```python
# accounts/models.py (聖典準拠の完全版)
from django.db import models
from django.contrib.auth.models import AbstractUser
from django.contrib.auth.validators import UnicodeUsernameValidator

class CustomUnicodeUsernameValidator(UnicodeUsernameValidator):
    regex = r'^[ぁ-んァ-ヶ一-龠々\w.@+\s-]+\Z'
    message = '有効なユーザー名を入力してください。ひらがな、カタカナ、漢字、スペース、半角英数字、@/./+/-/_ が使用できます。'

class User(AbstractUser):
    username_validator = CustomUnicodeUsernameValidator()
    username = models.CharField(
        'ログインID', max_length=150, unique=True,
        validators=[username_validator],
        error_messages={'unique': "このログインIDは既に使用されています。",},
    )
    email = models.EmailField('メールアドレス', blank=True)
    USERNAME_FIELD = 'username'
    REQUIRED_FIELDS = ['email']
    class Meta:
        verbose_name = '顧客アカウント'
        verbose_name_plural = '顧客アカウント'
    def __str__(self):
        return self.username

class Destination(models.Model):
    class DeliveryMethod(models.TextChoices):
        YAMATO = 'YAMATO', 'ヤマト配送'
        TEWATASHI = 'TEWATASHI', '直接手渡し'

    class ShippingZone(models.TextChoices):
        NORMAL = 'NORMAL', '通常'
        ENCHI = 'ENCHI', '遠地'

    user = models.ForeignKey(User, on_delete=models.CASCADE, verbose_name='顧客')
    name = models.CharField(max_length=255, verbose_name='宛名')
    postal_code = models.CharField(max_length=10, verbose_name='郵便番号')
    address = models.CharField(max_length=255, verbose_name='住所')
    phone = models.CharField(max_length=20, verbose_name='電話番号')
    
    delivery_method = models.CharField(
        max_length=10, choices=DeliveryMethod.choices, default=DeliveryMethod.YAMATO, verbose_name='配送方法'
    )
    shipping_zone = models.CharField(
        max_length=10, choices=ShippingZone.choices, default=ShippingZone.NORMAL, verbose_name='送料区分'
    )

    class Meta:
        verbose_name = 'お届け先'
        verbose_name_plural = 'お届け先'
    def __str__(self):
        return self.name
```

#### 4. 手順2：バックエンドロジックの実装（View, URL）

ログイン処理と、管理者/購入者によるリダイレクト振り分けを行うロジックを実装します。

1.  `accounts/views.py` をエディタで開き、**以下の聖典のコードで全面的に上書き**してください。
    ```python
    # accounts/views.py (聖典準拠の完全版)
    from django.contrib.auth.views import LoginView
    from django.shortcuts import redirect
    from django.urls import reverse_lazy

    class CustomLoginView(LoginView):
        template_name = 'registration/login.html'

        def get_success_url(self):
            """
            ログイン後のリダイレクト先をユーザー種別によって振り分ける。
            管理者の場合はダッシュボードへ、一般ユーザーは商品一覧へ。
            """
            if self.request.user.is_staff:
                return reverse_lazy('dashboard:dashboard_top')
            else:
                return reverse_lazy('products:product_list')

        def form_valid(self, form):
            """
            ログイン処理を実行し、リダイレクト先へ遷移させる。
            """
            super().form_valid(form)
            return redirect(self.get_success_url())
    ```
2.  `accounts/urls.py` をエディタで開き、**以下の聖典のコードで全面的に上書き**してください。
    ```python
    # accounts/urls.py (聖典準拠の完全版)
    from django.urls import path
    from django.contrib.auth import views as auth_views
    from .views import CustomLoginView 

    app_name = 'accounts'
    urlpatterns = [
        path('login/', CustomLoginView.as_view(), name='login'),
        path('logout/', auth_views.LogoutView.as_view(), name='logout'),
    ]
    ```

#### 5. 手順3：ログイン画面の作成

ユーザーが認証を行うためのインターフェースを作成します。

1.  `templates/` フォルダ内に `registration/` というフォルダを**新規作成**します。
2.  作成した `templates/registration/` フォルダ内に `login.html` というファイルを**新規作成**し、**以下の聖典のコードで全面的に上書き**してください。
    ```html
    <!-- templates/registration/login.html (聖典準拠の完全版) -->
    <!DOCTYPE html>
    <html lang="ja">
    <head>
        <meta charset="UTF-8">
        <title>ログイン</title>
        <style>
            body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f4f4f4; }
            .login-container { padding: 40px; border-radius: 8px; background-color: white; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); width: 320px; }
            h1 { text-align: center; color: #333; }
            .form-group { margin-bottom: 20px; }
            .form-group label { display: block; margin-bottom: 5px; color: #555; }
            .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
            .password-wrapper { position: relative; }
            .password-wrapper input { padding-right: 40px; }
            .toggle-password { position: absolute; top: 10px; right: 10px; cursor: pointer; user-select: none; color: #777; }
            .error-message { color: #d9534f; margin-bottom: 15px; text-align: center; }
            button { width: 100%; padding: 12px; border: none; border-radius: 4px; background-color: #5cb85c; color: white; font-size: 16px; cursor: pointer; }
        </style>
    </head>
    <body>
        <div class="login-container">
            <h1>お米販売システム ログイン</h1>
            {% if form.errors %}<p class="error-message">IDまたはパスワードが正しくありません。</p>{% endif %}
            <form method="post">
                {% csrf_token %}
                <div class="form-group">
                    <label for="id_username">ログインID</label>
                    <input type="text" name="username" id="id_username" required>
                </div>
                <div class="form-group">
                    <label for="id_password">パスワード</label>
                    <div class="password-wrapper">
                        <input type="password" name="password" id="id_password" required>
                        <span class="toggle-password">👁️</span>
                    </div>
                </div>
                <button type="submit">ログイン</button>
            </form>
        </div>
        <script>
            const togglePassword = document.querySelector('.toggle-password');
            const passwordInput = document.getElementById('id_password');
            if (togglePassword && passwordInput) {
                togglePassword.addEventListener('click', function () {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    this.textContent = type === 'password' ? '👁️' : '🙈';
                });
            }
        </script>
    </body>
    </html>
    ```

#### 6. 手順4：Django管理サイトとの連携強化

1.  `accounts/admin.py` をエディタで開き、**以下の聖典のコードで全面的に上書き**してください。
    ```python
    # accounts/admin.py (聖典準拠の完全版)
    from django.contrib import admin
    from django.contrib.auth.admin import UserAdmin as BaseUserAdmin
    from django.contrib.auth.forms import UserCreationForm
    from .models import User, Destination

    class CustomUserCreationForm(UserCreationForm):
        class Meta(UserCreationForm.Meta):
            model = User

    class DestinationInline(admin.TabularInline):
        model = Destination
        extra = 1
        fields = ('name', 'postal_code', 'address', 'phone', 'delivery_method', 'shipping_zone')

    @admin.register(User)
    class UserAdmin(BaseUserAdmin):
        inlines = [DestinationInline]
        add_form = CustomUserCreationForm
        add_fieldsets = (
            (None, {
                'classes': ('wide',),
                'fields': ('username', 'password',),
            }),
        )
        class Media:
            js = ('accounts/js/admin_password_toggle.js',)
    ```
2.  `accounts/static/accounts/` フォルダ内に `js/` というフォルダを**新規作成**します。
3.  作成した `js/` フォルダ内に `admin_password_toggle.js` というファイルを**新規作成**し、**以下の聖典のコードで全面的に上書き**してください。
    ```javascript
    // accounts/static/accounts/js/admin_password_toggle.js (聖典準拠の完全版)
    window.addEventListener('load', function() {
        function addToggle(selector) {
            const passwordInput = document.querySelector(selector);
            if (passwordInput) {
                const toggle = document.createElement('span');
                toggle.textContent = '👁️';
                toggle.style.cursor = 'pointer';
                toggle.style.marginLeft = '10px';
                passwordInput.parentNode.appendChild(toggle);
                toggle.addEventListener('click', () => {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    toggle.textContent = type === 'password' ? '👁️' : '🙈';
                });
            }
        }
        addToggle('#id_password');
    });
    ```

#### 7. 手順5：データベースへの反映と動作確認

1.  **データベースマイグレーションの実行:**
    新しいモデル定義をデータベースに反映させるため、以下のコマンドを実行します。
    ```bash
    docker-compose -f docker-compose.dev.yml exec app python manage.py makemigrations accounts
    docker-compose -f docker-compose.dev.yml exec app python manage.py migrate
    ```

2.  **動作確認:**
    *   ブラウザで `http://localhost:8000/accounts/login/` にアクセスし、新しいログイン画面が表示されることを確認します。パスワードの「目玉アイコン」が機能することも確認してください。
    *   **購入者アカウント**でログインし、**商品一覧ページ**にリダイレクトされることを確認します。
    *   一度ログアウトし、**管理者アカウント**でログインし、**管理者向けダッシュボード** (`/management/`) にリダイレクトされることを確認します。
    *   Django管理サイト (`/admin/`) にアクセスし、「顧客アカウント」の編集画面を開きます。
    *   画面下部に「お届け先」をインラインで追加・編集できるセクションが表示されていることを確認します。

---

以上で、システムの認証基盤が完成し、リファクタリング後の全機能の土台が整いました。