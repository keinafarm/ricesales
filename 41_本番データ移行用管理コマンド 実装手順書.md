承知いたしました。
この重要な作業、細心の注意を払って進めます。聖典ファイルのご提示、ありがとうございます。

今回の教訓の核心は、**「マイグレーションファイルは、Windowsの開発環境で生成・テストしたものを、Gitを使って本番環境に届ける」**という運用ルールにあります。これにより、環境ごとの差異によるエラーを根本的に防ぎます。

この新しいルールに基づき、ご提示いただいた3つの聖典ファイルを、1つずつ、省略のない完全な形で修正案として提示します。

---

### **【修正案 1/3】 `41_本番データ移行用管理コマンド 実装手順書.md` の更新**

まず、今回の混乱の直接的な原因となった「マイグレーションファイルのGit管理からの除外」というルールを**完全に撤回**し、新しい正しいルールに置き換えます。

##### **ファイル:** `41_本番データ移行用管理コマンド 実装手順書.md` **(全面的に上書き)**

```markdown
### **【補足資料】高度な運用手順書（マイグレーション管理とデータ移行）(Ver. 2.0)**

#### **1. はじめに**

本ドキュメントは、プロジェクトの保守性と安全性を長期的に確保するため、特に重要となる2つの高度な運用手順について詳述するものです。

*   **第1部: 新・マイグレーション管理ルール:** システムの安定稼働の要となる、データベースのバージョン管理に関するルールです。
*   **第2部: 本番データ移行用カスタム管理コマンドの実装:** 本番データベースに対する破壊的な操作（データクリアなど）を、安全かつ再利用可能な形で実行するための手順です。

これらの手順は、システムの安定運用に不可欠です。

---

### **第1部: 新・マイグレーション管理ルール**

#### **1.1. 目的と原則**

開発環境（Windows）と本番環境（Linux）のデータベース構造を常に一致させ、デプロイ時のエラーを根本的に防ぐため、本プロジェクトでは以下の原則を厳格に守ります。

*   **原則1: マイグレーションファイルはGitで一元管理する**
    *   データベースの構造変更を記録したマイグレーションファイル（`0001_initial.py`など）は、ソースコードの一部として扱い、必ずGitリポジトリにコミットします。

*   **原則2: `makemigrations`は開発環境でのみ実行する**
    *   新しいマイグレーションファイルを生成する`python manage.py makemigrations`コマンドは、**必ずWindowsの開発環境で実行**します。これにより、全ての変更履歴が開発者の手元で生成・テストされることを保証します。

*   **原則3: 本番環境では`makemigrations`を実行しない**
    *   本番サーバー上で`makemigrations`コマンドを実行することは、意図しない差異を生む原因となるため、**固く禁じます**。本番環境は、Gitから取得したマイグレーションファイルを`migrate`コマンドで適用するだけです。

#### **1.2. 【全開発者向け】設定ファイルの統一**

このルールを徹底するため、マイグレーションファイルがGitの管理対象から外れないように、プロジェクトの`.gitignore`ファイルを以下の状態に統一します。

1.  ローカルPCで、プロジェクトのルートディレクトリにある`.gitignore`ファイルを開きます。
2.  ファイル内に、マイグレーションファイルを除外する以下の記述があれば、**必ず削除またはコメントアウト**してください。

    ```gitignore
    # 以下の記述は、このプロジェクトでは使用しません。
    # もし存在する場合は、必ず削除してください。
    # */migrations/
    # !*/migrations/__init__.py
    ```

#### **1.3. 運用フロー**

1.  **開発者（ローカルPC）:**
    *   `models.py`を編集します。
    *   `docker compose -f docker-compose.dev.yml exec app python manage.py makemigrations` を実行し、新しいマイグレーションファイルを生成します。
    *   `docker compose -f docker-compose.dev.yml exec app python manage.py migrate` を実行し、ローカルで動作確認します。
    *   生成されたマイグレーションファイルを含む、全ての変更を`git commit`し、`git push`します。

2.  **運用管理者（本番サーバー）:**
    *   `git pull` を実行し、ソースコードと**新しいマイグレーションファイル**をサーバーに展開します。
    *   `docker compose up -d --build` を実行します。コンテナ内の`entrypoint.sh`が、新しいマイグレーションファイルを検知し、自動で`migrate`コマンドを実行してくれます。

---

### **第2部: 本番データ移行用カスタム管理コマンドの実装**

#### **2.1. 目的**

本番環境のデータベースに対して、既存の注文関連データをすべてクリアし、在庫情報をリセットする操作が必要になりました。このような破壊的かつ定型的な操作は、安全で再実行可能な「カスタム管理コマンド」として実装するのがベストプラクティスです。

ここでは、`python manage.py clear_orders` というコマンドを実装します。

#### **2.2. 【ローカルPCでの作業】管理コマンドファイルの作成**

管理者向け機能の統括アプリケーションである `dashboard` に、コマンドを実装します。

1.  ローカルPCの `dashboard` アプリケーション内に、以下のディレクトリと空の `__init__.py` ファイルを作成します。

    ```
    dashboard/
    ├── management/
    │   ├── __init__.py
    │   └── commands/
    │       ├── __init__.py
    │       └── clear_orders.py  <-- 新規作成
    ... (その他のファイル)
    ```

2.  新規作成した `dashboard/management/commands/clear_orders.py` ファイルを、以下の内容で**全面的に上書き**します。

    ```python
    # dashboard/management/commands/clear_orders.py
    from django.core.management.base import BaseCommand
    from django.db import connection, transaction
    
    class Command(BaseCommand):
        help = 'Clears all order-related data and resets stock order quantities. USE WITH CAUTION.'
    
        def handle(self, *args, **options):
            self.stdout.write(self.style.WARNING(
                "\n"
                "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n"
                "!! WARNING: This will permanently delete all order-related data !!\n"
                "!! (Orders, OrderItems, Bags, Allocations, Packages, etc.)    !!\n"
                "!! and reset stock order quantities.                        !!\n"
                "!! This action CANNOT be undone.                            !!\n"
                "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"
            ))
            
            confirm = input("\n> Are you sure you want to proceed? (yes/no): ")
            
            if confirm.lower() != 'yes':
                self.stdout.write(self.style.ERROR("Operation cancelled."))
                return
    
            queries = [
                "SET FOREIGN_KEY_CHECKS = 0;",
                "TRUNCATE TABLE `orders_packageitem`;",
                "TRUNCATE TABLE `orders_packageplanitem`;",
                "TRUNCATE TABLE `orders_allocation`;",
                "TRUNCATE TABLE `orders_package`;",
                "TRUNCATE TABLE `orders_orderitem`;",
                "TRUNCATE TABLE `orders_order`;",
                "TRUNCATE TABLE `orders_bag`;",
                "UPDATE `products_stock` SET `total_ordered_kg` = 0;",
                "SET FOREIGN_KEY_CHECKS = 1;",
            ]
    
            try:
                with connection.cursor() as cursor:
                    self.stdout.write("\nStarting data clearing process...")
                    for query in queries:
                        self.stdout.write(f"  Executing: {query.split('`')[0]}...")
                        cursor.execute(query)
                    self.stdout.write(self.style.SUCCESS("... process finished successfully."))
    
            except Exception as e:
                self.stdout.write(self.style.ERROR(f"\nAn error occurred: {e}"))
                self.stdout.write(self.style.ERROR("Operation failed. Please check the database state."))
                try:
                    with connection.cursor() as cursor:
                        cursor.execute("SET FOREIGN_KEY_CHECKS = 1;")
                except Exception as final_e:
                    self.stdout.write(self.style.ERROR(f"Could not re-enable foreign key checks: {final_e}"))
                return
    
            self.stdout.write(self.style.SUCCESS(
                "\nSuccessfully cleared all order-related data and reset stock quantities."
            ))
    ```

#### **2.3. 【ローカルPCでの作業】変更のコミットとプッシュ**

作成したコマンドをリポジトリに反映させます。

```bash
git add dashboard/
git commit -m "feat: Add clear_orders management command for data migration"
git push
```

```

---
ご確認いただき、問題ないようでしたら、次に`11_本番環境デプロイ手順書.md`の更新案を提示します。
