
### **【成果物 11/11】 `11_本番環境デプロイ手順書.md` (Ver. 4.0 FINAL)**

#### **1. はじめに**

本書は、Windows上で開発・テストが完了した「お米販売システム」を、本番用のVPSサーバー（Linux）へデプロイし、公開するための全手順を記したドキュメントです。

本書は、以下のパートで構成されています。

*   **初回サーバーセットアップ:** VPSサーバー上で、一番最初に一度だけ行う作業です。
*   **デプロイ・更新作業:** 機能追加や修正を反映する際に、繰り返し行う作業です。

#### **2. 新しい運用ルール（最重要）**

このシステムは、安定稼働を最優先するため、以下のルールで運用します。

*   **マイグレーションファイルはGitで管理:** データベースの設計図であるマイグレーションファイルは、Windows開発環境で作成・テストされたものをGit経由で本番環境に届けます。
*   **本番サーバーで`makemigrations`は厳禁:** 本番環境で`makemigrations`コマンドを実行すると、環境間の差異を生み、深刻なエラーの原因となるため**絶対に行いません**。
*   **デプロイは`entrypoint.sh`が自動化:** `docker compose up -d --build`を実行するだけで、コンテナ起動時に`entrypoint.sh`スクリプトがデータベースのマイグレーションと静的ファイルの収集を**自動で**実行します。手動での`migrate`や`collectstatic`は不要です。

#### **3. 前提条件**

この手順書を進めるにあたり、以下の環境がすべて整っていることを確認してください。

*   **サーバー側の準備:**
    *   VPSサーバー（OS: Ubuntu 24.04）が稼働していること。
    *   サーバーに `docker`、`admin_user`、`git`、そしてアプリケーション管理用の**`deploy_user`**ユーザーが作成済みであること。
    *   `admin_user`ユーザーは`sudo`権限を持っていること。
    *   サーバーに `Docker` と `Docker Compose (V2)` がインストール済みであること。
    *   サーバーに `git` がインストール済みであること。
    *   リバースプロキシとして `Traefik` が既に稼働しており、コンテナが参加できる `traefik-net` という名前の外部Dockerネットワークが存在すること。
*   **クライアント（開発PC）側の準備:**
    *   **【重要】** プロジェクトの最新のソースコード（**全てのマイグレーションファイルを含む**）が、すべて`gitea.example.com`のリポジトリにプッシュされていること。
    *   TeraTermのセットアップが完了していること。
*   **ドメインの準備:**
    *   `service-name.example.com` というドメインが、VPSサーバーのIPアドレスを指すようにDNS設定（Aレコード）が完了していること。

#### **4. 初回サーバーセットアップ（一度だけ行う作業）**

##### **手順 4.1. `admin_user`ユーザーでのSSH接続**

TeraTermを起動し、以下の設定でVPSサーバーにSSHでログインします。

*   **ホスト:** `example.com`
*   **SSHバージョン:** SSH2
*   **ユーザー名:** `admin_user`
*   **認証方式:** 「RSA/DSA/ECDSA/ED25199鍵を使う」を選択
*   **秘密鍵:** `/path/to/your/private_key.pem`
*   **パスフレーズ:** 秘密鍵に対応するパスフレーズを入力

##### **手順 4.2. Docker実行権限の付与**

`admin_user`ユーザーでログインした状態で、`deploy_user`ユーザーを`docker`グループに追加します。これにより、`deploy_user`ユーザーがDockerコマンドを実行できるようになります。
（このコマンドは**一度だけ**実行します。既に実行済みの場合は不要です。）

```bash
sudo usermod -aG docker deploy_user
```

##### **手順 4.3. `deploy_user`ユーザーへの切り替え**

`deploy_user`ユーザーに切り替わります。今後の作業は全てこのユーザーで行います。

```bash
sudo su - deploy_user
```

**【重要】** `usermod`によるグループ変更は、新しいセッションから有効になります。`su - deploy_user`で新しいセッションを開始することで、`deploy_user`ユーザーはDocker実行権限を持った状態になります。

##### **手順 4.4. Gitリポジトリからのクローン**

`deploy_user`ユーザーのホームディレクトリに、プロジェクトをクローンします。

```bash
# （su - deploy_user でホームディレクトリにいるはずですが、念のため）
cd ~

# プロジェクトをクローン
git clone https://your-git-server.com/your-user/your-repository.git develop/deploy_user
```

##### **手順 4.5. プロジェクトディレクトリへの移動**

クローンして作成されたプロジェクトのディレクトリに移動します。

```bash
cd develop/deploy_user
```

##### **手順 4.6. 本番用 環境設定ファイルの作成と編集**

`env.production.template`をコピーして、実際に本番環境で読み込む`env.production`ファイルを作成します。

```bash
cp env.production.template env.production
```

作成した`env.production`ファイルを`nano`エディタで開き、プレースホルダーを本番用の**安全な値**に書き換えてください。

```bash
nano env.production
```

* `DJANGO_SECRET_KEY`
* `MYSQL_PASSWORD`
* `MYSQL_ROOT_PASSWORD`

編集が終わったら、`Ctrl + X`、`Y`、`Enter` の順にキーを押して保存・終了します。

#### **5. アプリケーションの初回デプロイ**

（これ以降のコマンドは全て`deploy_user`ユーザーで実行します）

##### **手順 5.1. コンテナのビルドと起動**

以下のコマンドを一度実行するだけで、`entrypoint.sh`がデータベースのマイグレーションと静的ファイルの収集を自動的に行い、アプリケーションを起動します。

```bash
docker compose up -d --build
```

##### **手順 5.2. 起動ログの確認**

`entrypoint.sh`が正しく処理を完了したか、ログで確認します。

```bash
docker compose logs -f app
```

ログの最後に`Starting Gunicorn server...`と表示され、エラーが出ていなければ成功です。（`Ctrl + C`でログ表示を終了します）

##### **手順 5.3. 管理者アカウントの作成**

```bash
docker compose exec app python manage.py createsuperuser
```

##### **手順 5.4. 動作確認**

ブラウザを開き、`https://service-name.example.com`にアクセスします。ログイン画面が正しく表示されれば、デプロイは成功です。

#### **6. デプロイ・更新作業**

ソースコードに修正や機能追加があった場合の、通常の更新手順です。

1. `admin_user`ユーザーでサーバーにSSHログインし、`deploy_user`ユーザーに切り替わります。
2. プロジェクトディレクトリに移動し、Gitリポジトリから最新のソースコードを取得します。

    ```bash
    cd ~/develop/deploy_user
    git pull
    ```

3. コンテナを再ビルドして起動します。
    **【重要】** このコマンドだけで、`entrypoint.sh`がデータベースの更新（migrate）と静적ファイルの更新（collectstatic）を自動的に判断して実行してくれます。

    ```bash
    docker compose up -d --build
    ```

4. **（必要な場合）カスタム管理コマンドの実行**
    * 特別なデータ移行などが必要な場合は、コンテナ起動後に手動でコマンドを実行します。
    * **【送料モデル移行時の例】**

        ```bash
        docker compose exec app python manage.py clear_orders
        ```

#### **7. 運用とメンテナンス**

* **ログ確認:** `docker compose logs -f app`
* **再起動:** `docker compose restart`
* **停止:** `docker compose down`
* **全消去（データも含む）:** `docker compose down -v`

