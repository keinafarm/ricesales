### 【手順書更新 1/2】 `30_共通基盤設定 実装手順書.md` の更新

まず、プロジェクト全体のレイアウトの基礎となる `templates/base.html` を、先ほど確定した最新のコードに差し替えます。

##### **ファイル:** `30_共通基盤設定 実装手順書.md` **(全面的に上書き)**

```markdown
### **【機能単位】共通基盤設定 実装手順書 (Ver. 3.1)**

#### 1. 目的

この手順書は、プロジェクトの土台となる共通基盤を設定するための公式ドキュメントです。今回の更新では、将来的な拡張性を考慮し、プロジェクト全体で利用可能な**共通機能（テンプレートタグなど）を管理するための`common`アプリケーションを追加**します。また、金額表示で汎用的に利用する`humanize`ライブラリをベーステンプレートに導入します。

#### 2. 手順1：共通機能アプリケーションの準備

1. **アプリケーションの作成:**

    ```bash
    docker-compose -f docker-compose.dev.yml exec app python manage.py startapp common
    ```

2. **`settings.py`への登録:** `config/settings.py`の`INSTALLED_APPS`リストに`'common.apps.CommonConfig'`を追加します。

    ##### **ファイル:** `config/settings.py` **(全面的に上書き)**

    ```python
    # config/settings.py
    import os
    from pathlib import Path
    from dotenv import load_dotenv
    import socket

    BASE_DIR = Path(__file__).resolve().parent.parent

    load_dotenv()

    SECRET_KEY = os.getenv('DJANGO_SECRET_KEY')
    DEBUG = os.getenv('DJANGO_DEBUG', 'False') == 'True'

    ALLOWED_HOSTS = os.getenv('DJANGO_ALLOWED_HOSTS', '').split(',')

    if DEBUG:
        ALLOWED_HOSTS.extend(['localhost', '127.0.0.1'])
    else:
        ALLOWED_HOSTS.append('localhost')

    CSRF_TRUSTED_ORIGINS = os.getenv('DJANGO_CSRF_TRUSTED_ORIGINS', '').split(',')

    INSTALLED_APPS = [
        'django.contrib.admin',
        'django.contrib.auth',
        'django.contrib.contenttypes',
        'django.contrib.sessions',
        'django.contrib.messages',
        'whitenoise.runserver_nostatic',
        'django.contrib.staticfiles',
        'django.contrib.humanize',
        'bootstrap5',
        'django_extensions',
        'accounts.apps.AccountsConfig',
        'products.apps.ProductsConfig',
        'orders.apps.OrdersConfig',
        'cart.apps.CartConfig',
        'system_settings.apps.SystemSettingsConfig',
        'dashboard.apps.DashboardConfig',
        'mg_orders.apps.MgOrdersConfig',
        'mg_customers.apps.MgCustomersConfig',
        'mg_masters.apps.MgMastersConfig',
        'mg_workflow.apps.MgWorkflowConfig',
        'common.apps.CommonConfig',
    ]

    MIDDLEWARE = [
        'django.middleware.security.SecurityMiddleware',
        'whitenoise.middleware.WhiteNoiseMiddleware',
        'django.contrib.sessions.middleware.SessionMiddleware',
        'django.middleware.common.CommonMiddleware',
        'django.middleware.csrf.CsrfViewMiddleware',
        'django.contrib.auth.middleware.AuthenticationMiddleware',
        'django.contrib.messages.middleware.MessageMiddleware',
        'django.middleware.clickjacking.XFrameOptionsMiddleware',
    ]

    if DEBUG:
        INSTALLED_APPS.append('debug_toolbar')
        MIDDLEWARE.append('debug_toolbar.middleware.DebugToolbarMiddleware')

    ROOT_URLCONF = 'config.urls'

    TEMPLATES = [
        {
            'BACKEND': 'django.template.backends.django.DjangoTemplates',
            'DIRS': [BASE_DIR / 'templates'],
            'APP_DIRS': True,
            'OPTIONS': {
                'context_processors': [
                    'django.template.context_processors.debug',
                    'django.template.context_processors.request',
                    'django.contrib.auth.context_processors.auth',
                    'django.contrib.messages.context_processors.messages',
                    'cart.context_processors.cart_context',
                    'dashboard.context_processors.bag_stock_summary',
                    'dashboard.context_processors.stock_summary',
                ],
            },
        },
    ]

    WSGI_APPLICATION = 'config.wsgi.application'

    DATABASES = {
        'default': {
            'ENGINE': 'django.db.backends.mysql',
            'NAME': os.getenv('MYSQL_DATABASE'),
            'USER': os.getenv('MYSQL_USER'),
            'PASSWORD': os.getenv('MYSQL_PASSWORD'),
            'HOST': os.getenv('MYSQL_HOST', 'db'),
            'PORT': '3306',
            'OPTIONS': {'charset': 'utf8mb4'},
        }
    }

    AUTH_PASSWORD_VALIDATORS = []

    LANGUAGE_CODE = 'ja'
    TIME_ZONE = 'Asia/Tokyo'
    USE_I18N = True
    USE_L10N = True
    USE_THOUSAND_SEPARATOR = True
    NUMBER_GROUPING = 3
    USE_TZ = True

    STATIC_URL = 'static/'
    STATICFILES_DIRS = [BASE_DIR / "static"]
    STATIC_ROOT = BASE_DIR / "staticfiles"
    STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'

    DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

    INTERNAL_IPS = [ "127.0.0.1", ]
    if DEBUG:
        try:
            hostname, _, ips = socket.gethostbyname_ex(socket.gethostname())
            INTERNAL_IPS.extend([ip[: ip.rfind(".")] + ".1" for ip in ips])
        except socket.gaierror:
            pass

    # --- My Settings ---
    AUTH_USER_MODEL = 'accounts.User'
    LOGIN_URL = 'accounts:login'
    LOGIN_REDIRECT_URL = 'products:product_list'
    LOGOUT_REDIRECT_URL = 'accounts:login'
    CART_SESSION_ID = 'cart'
    CART_HYBRID_THRESHOLD = 3
    NORMAL_SHIPPING_FEE = 1200
    REMOTE_SHIPPING_FEE = 1800
    SEIMAI_WEIGHT_COEFFICIENT = 1.1
    PACKAGE_MAX_WEIGHT_KG = 20.0
    DEFAULT_BOX_WEIGHT_KG = 0.5

    if not DEBUG:
        SECURE_SSL_REDIRECT = True
        SESSION_COOKIE_SECURE = True
        CSRF_COOKIE_SECURE = True
        SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
    ```

3. **カスタムテンプレートタグの作成:**
    * `common/`ディレクトリ内に`templatetags`フォルダを作成します。
    * `common/templatetags/`内に、空の`__init__.py`ファイルを作成します。
    * `common/templatetags/`内に、`common_extras.py`ファイルを新規作成し、以下の内容を記述します。

    ##### **ファイル:** `common/templatetags/common_extras.py` **(新規作成)**

    ```python
    from django import template
    
    register = template.Library()
    
    @register.filter(name='get_item')
    def get_item(dictionary, key):
        """テンプレートで辞書のキーから値を取得するためのフィルター"""
        return dictionary.get(key)
    ```

#### 3. 手順2：共通ロジックの実装**

##### **ファイル:** `dashboard/context_processors.py` **(全面的に上書き)**

```python
# dashboard/context_processors.py

from django.db.models import Sum, Count, Q
from orders.models import Order, OrderItem, Bag, PackageItem
from products.models import Stock, Product
from cart.cart import Cart
from decimal import Decimal
from django.conf import settings

def stock_summary(request):
    """
    サイドバーにお客様向けの在庫状況を表示するためのコンテキストプロセッサ。
    """
    if not request.user.is_authenticated or request.user.is_staff:
        return {}

    cart = Cart(request)
    cart_consumption_by_variety = {}
    seimai_coeff = Decimal(str(settings.SEIMAI_WEIGHT_COEFFICIENT))

    all_product_ids_in_cart = [pid for d in cart.cart.values() for pid in d.get('items', {}).keys()]
    all_products_map = {p.id: p for p in Product.objects.filter(id__in=all_product_ids_in_cart).select_related('variety')}

    for dest_data in cart.cart.values():
        for prod_id_str, item_data in dest_data.get('items', {}).items():
            product = all_products_map.get(int(prod_id_str))
            if product:
                quantity = item_data.get('quantity', 0)
                variety_id = product.variety.id
                
                weight_in_cart = product.weight_kg * quantity
                if product.type == Product.ProductType.SEIMAI:
                    weight_in_cart *= seimai_coeff
                
                cart_consumption_by_variety.setdefault(variety_id, Decimal('0'))
                cart_consumption_by_variety[variety_id] += weight_in_cart

    stocks = Stock.objects.select_related('variety').order_by('variety__name')
    summary = []
    for stock in stocks:
        summary.append({
            'name': stock.variety.name,
            'available_kg': stock.available_kg,
            'cart_consumption_kg': cart_consumption_by_variety.get(stock.variety.id, Decimal('0'))
        })
        
    return {'stock_summary': summary}

def bag_stock_summary(request):
    """
    サイドバーの在庫サマリー（物理ベース）
    """
    if not request.user.is_authenticated or not request.user.is_staff:
        return {}

    required_qs = (
        OrderItem.objects
        .filter(order__status=Order.OrderStatus.ACCEPTED)
        .values('product_id', 'product__name')
        .annotate(q=Sum('quantity'))
    )
    by_prod = {}
    for r in required_qs:
        pid = r['product_id']
        by_prod[pid] = {
            'name': r['product__name'],
            'total_ordered': int(r['q'] or 0),
            'prepared_total': 0,
            'packed_total': 0,
        }

    prepared_bags_qs = (
        Bag.objects
        .filter(prepared=True)
        .values('product_id')
        .annotate(
            total_prepared_count=Count('id'),
            total_packed_count=Count('packageitem', filter=Q(packageitem__isnull=False))
        )
    )

    for row in prepared_bags_qs:
        pid = row['product_id']
        if pid in by_prod:
            by_prod[pid]['prepared_total'] = int(row['total_prepared_count'] or 0)
            by_prod[pid]['packed_total'] = int(row['total_packed_count'] or 0)

    rows = []
    for pid, data in by_prod.items():
        total_ordered = data['total_ordered']
        prepared_total = data['prepared_total']
        packed_total = data['packed_total']

        unbagged_count = max(0, total_ordered - prepared_total)
        
        unpacked_count = max(0, prepared_total - packed_total)

        rows.append({
            'name': data['name'],
            'total': total_ordered,
            'unbagged': unbagged_count,
            'bag_rice': unpacked_count,
            'boxed': packed_total,
        })

    rows.sort(key=lambda x: x['name'])
    return {'bag_stock_summary': rows}
```

#### 4. 手順3：ベーステンプレートの修正

##### **ファイル:** `templates/base.html` **(全面的に上書き)**

```html
<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>
            {% block title %}お米販売システム{% endblock %}
        </title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
              rel="stylesheet">
        <link rel="stylesheet"
              href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
        <style>
        :root {
            --sidebar-width: 300px;
        }
        /* スマホ表示時にフローティングバーの高さ分だけbodyの底上げをする */
        body {
            padding-bottom: 90px; /* フローティングバーの高さより少し多めに確保 */
        }

        .sidebar {
            width: var(--sidebar-width);
            flex-shrink: 0;
        }
        .sidebar.offcanvas {
            height: 100vh;
            height: 100dvh;
        }
        .offcanvas-body {
            flex: 1 1 auto;
            overflow-y: auto;
            min-height: 0;
        }
        
        /* PC表示用のレイアウト指定 */
        @media (min-width: 992px) {
            body {
                padding-bottom: 0;
            }
            .page-wrapper {
                display: flex;
            }
            .sidebar.offcanvas-lg {
                position: relative;
                transform: none;
                height: auto;
                min-height: 100vh;
                border-right: 1px solid rgba(0,0,0,.1);
                background-color: #f8f9fa;
            }
        }

        .main-content {
             flex-grow: 1;
             padding: 20px;
        }
        #manualModal .modal-body { max-height: 70vh; overflow-y: auto; }
        #manualModal .modal-body img { max-width: 100%; height: auto; }
        #manualModal .modal-body h1, #manualModal .modal-body h2, #manualModal .modal-body h3 { margin-top: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid #dee2e6; }
        
        .floating-cart-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #fff;
            border-top: 1px solid #dee2e6;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 0.75rem 1rem;
            z-index: 1040;
        }
        </style>
        {% block extra_css %}{% endblock %}
    </head>
    <body>
        {% load humanize %}
        <header class="navbar navbar-light bg-light sticky-top d-lg-none">
            <div class="container-fluid">
                <button class="navbar-toggler"
                        type="button"
                        data-bs-toggle="offcanvas"
                        data-bs-target="#sidebarOffcanvas"
                        aria-controls="sidebarOffcanvas">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <span class="navbar-brand mb-0 h1">お米販売システム</span>
                <button type="button" class="btn btn-outline-info btn-sm manual-open-btn">
                    <i class="bi bi-question-circle"></i>
                    <span class="d-none d-sm-inline">マニュアル</span>
                </button>
            </div>
        </header>

        <div class="page-wrapper">
            <div class="sidebar offcanvas-lg offcanvas-start bg-light d-flex flex-column"
                 tabindex="-1"
                 id="sidebarOffcanvas"
                 aria-labelledby="sidebarOffcanvasLabel">
                <div class="offcanvas-header d-lg-none">
                    <h5 class="offcanvas-title" id="sidebarOffcanvasLabel">メニュー</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="offcanvas"
                            data-bs-target="#sidebarOffcanvas"
                            aria-label="Close"></button>
                </div>
                <div class="offcanvas-body p-3 d-flex flex-column">
                    {% if user.is_authenticated %}
                        <!-- メインコンテンツ(スクロール対象) -->
                        <div style="flex-grow: 1; overflow-y: auto; min-height: 0;">
                            {% block sidebar_content %}
                                <h3>メニュー</h3>
                                <hr>
                                <p>こんにちは、{{ user.username }} さん</p>
                                <ul class="nav flex-column mb-3">
                                    <li class="nav-item">
                                        <a class="nav-link" href="{% url 'products:product_list' %}">商品一覧</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{% url 'orders:order_history_list' %}">注文履歴</a>
                                    </li>
                                </ul>
                                {% if stock_summary %}
                                    <hr>
                                    <div id="sidebar-stock-container" class="mb-3">
                                        <h4>在庫状況</h4>
                                        <table class="table table-sm small">
                                            <thead>
                                                <tr>
                                                    <th>品種</th>
                                                    <th class="text-end">残り在庫</th>
                                                    <th class="text-end text-muted">
                                                        <small>(カート消費量)</small>
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in stock_summary %}
                                                    <tr>
                                                        <td>{{ item.name }}</td>
                                                        <td class="text-end fw-bold">
                                                            {% if item.available_kg > 0 %}
                                                                {{ item.available_kg|floatformat:1|intcomma }} kg
                                                            {% else %}
                                                                <span class="badge bg-danger">在庫切れ</span>
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-end text-muted">
                                                            {% if item.cart_consumption_kg > 0 %}
                                                                <small>(-{{ item.cart_consumption_kg|floatformat:1|intcomma }} kg)</small>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        <div class="text-muted" style="font-size: 0.75rem;">※カート消費量は玄米換算での値です。</div>
                                    </div>
                                {% endif %}
                                <div id="sidebar-cart-container" class="d-none d-lg-block">
                                    <hr>
                                    <h4>ご注文内容</h4>
                                    {% for group in cart %}
                                        <div class="card my-2">
                                            <div class="card-header">
                                                {{ group.destination.name }} 様
                                                <span class="badge bg-success float-end">{{ group.group_total_price|intcomma }} 円</span>
                                            </div>
                                            <ul class="list-group list-group-flush">
                                                {% for item in group.items %}
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        <span>{{ item.product.name }} x {{ item.quantity }}</span>
                                                        <form action="{% url 'cart:remove_from_cart' %}"
                                                              method="post"
                                                              class="js-remove-from-sidebar-form">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="product_id" value="{{ item.product.id }}">
                                                            <input type="hidden"
                                                                   name="destination_id"
                                                                   value="{{ group.destination.id }}">
                                                            <button type="submit"
                                                                    class="btn btn-sm btn-outline-danger border-0"
                                                                    title="削除">×</button>
                                                        </form>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% empty %}
                                        <p>カートは空です。</p>
                                    {% endfor %}
                                    {% if cart|length > 0 %}
                                        <h5>総合計: {{ cart.get_grand_total_price|intcomma }} 円</h5>
                                        <a href="{% url 'orders:order_confirm' %}"
                                           class="btn btn-primary w-100 mt-2">注文内容の確認へ</a>
                                    {% endif %}
                                </div>
                            {% endblock sidebar_content %}
                        </div>

                        <!-- フッター(下部固定) -->
                        <div style="flex-shrink: 0; margin-top: auto;" class="pt-3 border-top">
                            <div class="d-flex justify-content-between align-items-center">
                                <form action="{% url 'accounts:logout' %}" method="post" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-secondary btn-sm">ログアウト</button>
                                </form>
                                <button type="button" class="btn btn-outline-info btn-sm manual-open-btn">
                                    <i class="bi bi-question-circle"></i> マニュアル
                                </button>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="main-content">
                {% if messages %}
                    {% for message in messages %}
                        {% if message.level == 40 %}
                            <div class="alert alert-danger" role="alert">{{ message }}</div>
                        {% elif message.level == 30 %}
                            <div class="alert alert-warning" role="alert">{{ message }}</div>
                        {% elif message.level == 25 %}
                            <div class="alert alert-success" role="alert">{{ message }}</div>
                        {% else %}
                            <div class="alert alert-info" role="alert">{{ message }}</div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
                {% block content %}{% endblock %}
            </div>
        </div>
        
        {% if user.is_authenticated and not user.is_staff and cart|length > 0 %}
            <div class="floating-cart-bar d-lg-none">
                {% block floating_bar_content %}
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="fw-bold">総合計:</span>
                        <span class="fs-5 text-danger fw-bold">{{ cart.get_grand_total_price|intcomma }} 円</span>
                    </div>
                    <a href="{% url 'orders:order_confirm' %}" class="btn btn-primary">
                        注文内容の確認へ <i class="bi bi-arrow-right-circle"></i>
                    </a>
                </div>
                {% endblock floating_bar_content %}
            </div>
        {% endif %}
        
        <div class="modal fade"
             id="manualModal"
             tabindex="-1"
             aria-labelledby="manualModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="d-flex align-items-center">
                            <button type="button"
                                    class="btn btn-outline-secondary btn-sm me-3"
                                    id="manual-back-btn"
                                    title="戻る">
                                <i class="bi bi-arrow-left"></i>
                            </button>
                            <button type="button"
                                    class="btn btn-outline-primary btn-sm me-3"
                                    id="manual-index-btn"
                                    title="目次へ">
                                <i class="bi bi-list-ul"></i>
                            </button>
                            <h5 class="modal-title" id="manualModalLabel">オンラインマニュアル</h5>
                        </div>
                        <button type="button"
                                class="btn-close"
                                data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="manual-content"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        {% load static %}
        <script src="{% static 'js/manual.js' %}"></script>
        {% block extra_js %}{% endblock %}
    </body>
</html>
```

---

以上が `30_共通基盤設定 実装手順書.md` の更新案です。
ご確認いただき、問題ないようでしたら、最後に `40_送料計算モデル変更 実装手順書.md` の更新案を提示します。
