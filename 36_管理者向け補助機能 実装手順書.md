
### **【機能単位】管理者向け補助機能 実装手順書 (Ver. 3.0)**

#### 1. 目的

この手順書は、`【機能単位】管理者向け出荷ワークフロー機能 実装手順書 (Ver. 3.0)`までが完了した状態から、管理業務を支援する以下の補助的な機能を、`dashboard`アプリケーションに実装するための公式ドキュメントです。

* **ダッシュボード機能:** 管理者がログイン後に「次に何をすべきか」を把握するためのToDoリスト形式のトップページ。
* **旧システムからのデータ移行機能:** 管理者がWeb UIからSQLファイルをアップロードするだけで、旧システムの顧客およびお届け先情報を安全に一括で取り込みます。
* **オンラインマニュアル管理機能:** 管理者がマニュアルの元となるMarkdown（`.md`）ファイルを、専用画面からアップロード・削除できる機能を提供します。
* **デバッグ機能:** システムの内部状態（注文、パッケージ、袋、在庫）を一覧で確認できる開発者向け画面を提供します。

#### 2. 手順1：バックエンドの実装 (`dashboard`アプリケーション)

`dashboard`アプリケーションのビューとURL定義を最終形に更新します。

##### **ファイル:** `dashboard/views.py` **(全面的に上書き)**

```python
# dashboard/views.py
import json
import re
import os
from django.shortcuts import render, get_object_or_404
from django.contrib.auth.decorators import login_required, user_passes_test
from django.db.models import Sum, Count, Max, Q, F, Value
from django.db.models.functions import Coalesce
from django.db import transaction
from django.contrib import messages
from django.conf import settings
from django.http import JsonResponse, HttpResponse, Http404
from django.views.decorators.csrf import ensure_csrf_cookie

from orders.models import Order, OrderItem, Bag, Package
from products.models import Stock
from accounts.models import Destination, User

def is_staff_user(user):
    return user.is_staff

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
def dashboard_view(request):
    new_orders_count = Order.objects.filter(status=Order.OrderStatus.NEW).count()
    bagging_items = OrderItem.objects.filter(order__status=Order.OrderStatus.ACCEPTED)
    bagging_total_bags = bagging_items.aggregate(total=Sum('quantity'))['total'] or 0
    unpaid_customer_count = Order.objects.filter(
        payment_status=Order.PaymentStatus.UNPAID
    ).exclude(status=Order.OrderStatus.CANCELED).values('user').distinct().count()
    packaging_dest_count = Package.objects.filter(
        status=Package.PackageStatus.PACKAGING
    ).values('destination').distinct().count()
    context = {
        'new_orders_count': new_orders_count,
        'bagging_total_bags': bagging_total_bags,
        'unpaid_customer_count': unpaid_customer_count,
        'packaging_count': packaging_dest_count,
        'shipping_packages_count': 0,
        'ready_for_pickup_count': 0,
    }
    return render(request, 'dashboard/dashboard.html', context)

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
def debug_view(request):
    orders_data = []
    orders = Order.objects.select_related('user', 'destination').prefetch_related(
        'items__product', 'items__allocations__bag'
    ).order_by('-id')[:10]
    for order in orders:
        items_data = [{'id': item.id, 'product_name': item.product.name, 'quantity': item.quantity, 'allocations': [{'id': a.id, 'bag_id': a.bag.id} for a in item.allocations.all()]} for item in order.items.all()]
        orders_data.append({'id': order.id, 'user': order.user.username, 'destination_name': order.destination.name, 'status': order.get_status_display(), 'items': items_data})
    
    packages_data = []
    packages = Package.objects.select_related('destination').prefetch_related(
        'items__bag__product', 'plan_items__product'
    ).order_by('id')
    for pkg in packages:
        pkg_items_data = [{'bag_id': p_item.bag.id, 'product_name': p_item.bag.product.name} for p_item in pkg.items.all()]
        plan_items_data = [{'product_name': plan.product.name, 'quantity': plan.quantity} for plan in pkg.plan_items.all()]
        packages_data.append({'id': pkg.id, 'label': pkg.label, 'destination_name': pkg.destination.name, 'items': pkg_items_data, 'plans': plan_items_data})
    
    bags_data = []
    all_bags = Bag.objects.select_related('product', 'allocation__order_item', 'packageitem__package').order_by('id')
    for bag in all_bags:
        status, location, allocation_info = ("未準備", "", "なし")
        if bag.prepared:
            if hasattr(bag, 'allocation') and bag.allocation:
                allocation_info = f"OrderItem #{bag.allocation.order_item_id}"
                if hasattr(bag, 'packageitem') and bag.packageitem:
                    status, location = ("箱入", f"Package #{bag.packageitem.package_id}")
                else:
                    status = "未梱包"
            else:
                status = "未引当 (準備済み在庫)"
        bags_data.append({'id': bag.id, 'product_name': bag.product.name, 'status': status, 'location': location, 'allocation_info': allocation_info})

    stocks_data = list(Stock.objects.select_related('variety').values('variety__name', 'total_supplied_kg', 'total_ordered_kg').order_by('variety__name'))
    for stock_data in stocks_data:
        stock_data['available_kg'] = stock_data['total_supplied_kg'] - stock_data['total_ordered_kg']
    context = {'orders_data': orders_data, 'packages_data': packages_data, 'bags_data': bags_data, 'stocks_data': stocks_data}
    return render(request, 'dashboard/debug.html', context)

def _parse_sql_values(values_str):
    vals, in_quote, current_val, quote_char = [], False, '', None
    for char in values_str:
        if not quote_char and (char == "'" or char == '"'): quote_char = char; continue
        if char == quote_char: quote_char = None; continue
        if char == ',' and not quote_char: vals.append(current_val.strip()); current_val = ''
        else: current_val += char
    vals.append(current_val.strip())
    cleaned_vals = []
    for v in vals:
        if v == 'NULL': cleaned_vals.append(None)
        elif (v.startswith("'") and v.endswith("'")) or (v.startswith('"') and v.endswith('"')): cleaned_vals.append(v[1:-1])
        elif v.isdigit(): cleaned_vals.append(int(v))
        else: cleaned_vals.append(v)
    return cleaned_vals

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
def import_old_data_view(request):
    if request.method == 'POST':
        sql_file = request.FILES.get('sql_file')
        if not sql_file: messages.error(request, "SQLファイルが選択されていません。"); return redirect('dashboard:import')
        try:
            content = sql_file.read().decode('utf-8')
            old_users, old_destinations = [], []
            insert_pattern = re.compile(r"INSERT INTO `([^`]+)`.*?VALUES\s*(.*?);", re.IGNORECASE | re.DOTALL)
            values_pattern = re.compile(r"\((.*?)\)")
            for match in insert_pattern.finditer(content):
                table_name, values_block = match.group(1), match.group(2)
                for values_match in values_pattern.finditer(values_block):
                    parsed_values = _parse_sql_values(values_match.group(1))
                    if table_name == '販売システムユーザー' and len(parsed_values) >= 3: old_users.append(parsed_values)
                    elif table_name == '顧客名簿' and len(parsed_values) >= 15: old_destinations.append(parsed_values)
            if not old_users and not old_destinations: messages.warning(request, "SQLファイルから取り込むべきデータが見つかりませんでした。"); return redirect('dashboard:import')
            with transaction.atomic():
                Package.objects.all().delete()
                users_to_delete = User.objects.filter(is_staff=False, is_superuser=False)
                Order.objects.filter(user__in=users_to_delete).delete()
                Destination.objects.all().delete()
                users_to_delete.delete()
                new_user_map = {}
                for old_user_data in old_users:
                    old_id, username, password = old_user_data[0], old_user_data[1], old_user_data[2]
                    if not username or password is None: continue
                    new_user = User.objects.create_user(username=username, password=str(password), is_staff=False)
                    new_user_map[old_id] = new_user
                created_dest_count = 0
                for old_dest_data in old_destinations:
                    user_obj = new_user_map.get(old_dest_data[13])
                    if not user_obj: continue
                    address_parts = [p for p in [old_dest_data[5], old_dest_data[6], old_dest_data[7], old_dest_data[8]] if p]
                    shipping_type = old_dest_data[14]
                    delivery_method = Destination.DeliveryMethod.TEWATASHI if shipping_type == '持帰り' else Destination.DeliveryMethod.YAMATO
                    shipping_zone = Destination.ShippingZone.ENCHI if shipping_type == '遠地' else Destination.ShippingZone.NORMAL
                    Destination.objects.create(user=user_obj, name=old_dest_data[1], postal_code=old_dest_data[4] or '', address=''.join(address_parts), phone=old_dest_data[10] or '', delivery_method=delivery_method, shipping_zone=shipping_zone)
                    created_dest_count += 1
            messages.success(request, f"{len(new_user_map)}件のユーザーと{created_dest_count}件の送付先を取り込みました。")
        except Exception as e:
            messages.error(request, f"データの取り込み中にエラーが発生しました: {e}")
        return redirect('dashboard:import')
    return render(request, 'dashboard/import_old_data.html')

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
def manual_management_view(request):
    manuals_dir = settings.BASE_DIR / "static" / "manuals"
    os.makedirs(manuals_dir, exist_ok=True)
    is_ajax = request.headers.get('x-requested-with') == 'XMLHttpRequest'
    if request.method == 'POST':
        action = request.POST.get('form_action')
        if action == 'delete':
            filename = request.POST.get('filename')
            if not filename or any(c in filename for c in ('..', '/', '\\')): messages.error(request, "不正なファイル名です。")
            else:
                file_path = manuals_dir / filename
                if file_path.is_file() and file_path.name.endswith('.md'): os.remove(file_path); messages.success(request, f"ファイル「{filename}」を削除しました。")
                else: messages.error(request, "指定されたファイルは存在しないか、削除できません。")
            return redirect('dashboard:manuals')
        elif (action == 'upload' or action == 'confirm_overwrite') and is_ajax:
            uploaded_files = request.FILES.getlist('manual_files')
            if not uploaded_files: return JsonResponse({'status': 'error', 'message': 'ファイルが選択されていません。'}, status=400)
            overwrite_files, valid_files = [], []
            for f in uploaded_files:
                if not f.name.endswith('.md') or any(c in f.name for c in ('..', '/', '\\')): continue
                valid_files.append(f)
                if (manuals_dir / f.name).exists(): overwrite_files.append(f.name)
            if overwrite_files and action == 'upload': return JsonResponse({'status': 'confirm_overwrite', 'files': overwrite_files})
            for f in valid_files:
                with open(manuals_dir / f.name, 'wb+') as dest:
                    for chunk in f.chunks(): dest.write(chunk)
            msg = f"{len(valid_files)}件のファイルをアップロードしました。"
            if action == 'confirm_overwrite': msg = f"{len(valid_files)}件のファイルをアップロード（上書き含む）しました。"
            messages.success(request, msg); return JsonResponse({'status': 'success_reload'})
    files_info = []
    try:
        for filename in sorted(os.listdir(manuals_dir)):
            if filename.endswith('.md'):
                filepath = manuals_dir / filename
                stat = filepath.stat()
                files_info.append({'name': filename, 'size': stat.st_size, 'modified_at': stat.st_mtime})
    except FileNotFoundError: pass
    context = {'manual_files': files_info}
    return render(request, 'dashboard/manual_management.html', context)

@login_required
def manual_content_view(request, page_name):
    if any(c in page_name for c in ('..', '/', '\\')): raise Http404
    filename = 'index_admin.md' if page_name == 'index' and request.user.is_staff else f"{page_name}.md"
    file_path = settings.BASE_DIR / 'static' / 'manuals' / filename
    try:
        with open(file_path, 'r', encoding='utf-8') as f: content = f.read()
        return HttpResponse(content, content_type='text/markdown; charset=utf-8')
    except FileNotFoundError: raise Http404("Manual file not found.")

@ensure_csrf_cookie
def csrf_seed(request):
    return JsonResponse({"ok": True})
```

##### **ファイル:** `dashboard/urls.py` **(全面的に上書き)**

```python
# dashboard/urls.py
from django.urls import path, include
from . import views

urlpatterns = [
    path('', views.dashboard_view, name='dashboard_top'),
    path('debug/', views.debug_view, name='debug_view'),
    path('import/', views.import_old_data_view, name='import'),
    path('manuals/', views.manual_management_view, name='manuals'),
    
    path('orders/', include('mg_orders.urls')),
    path('customers/', include('mg_customers.urls')),
    path('masters/', include('mg_masters.urls')),
    path('workflow/', include('mg_workflow.urls')),

    path('api/manuals/<str:page_name>/', views.manual_content_view, name='api_manual_content'),
    path('api/csrf/', views.csrf_seed, name='api_csrf_seed'),
]
```

#### 3. 手順2：フロントエンドの実装 (`dashboard`アプリケーション)

##### **ファイル:** `templates/dashboard/dashboard.html` **(全面的に上書き)**

```html
{% extends "base_management.html" %}
{% block title %}管理者ダッシュボード{% endblock %}
{% block content %}
    <h1>ダッシュボード (ToDoリスト)</h1>
    <p>現在対応が必要な作業の一覧です。</p>
    <hr>
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th>ToDo項目名</th>
                    <th class="text-center">件数</th>
                    <th>クリック時の遷移先（予定）</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <a href="{% url 'dashboard:mg_orders:order_list' %}?status=NEW"><strong>新規注文（未受付）</strong></a>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-danger rounded-pill fs-6">{{ new_orders_count }}</span>
                    </td>
                    <td>注文受付画面</td>
                </tr>
                <tr>
                    <td>
                        <strong><a href="{% url 'dashboard:mg_workflow:bagging_list' %}">要袋詰リスト</a></strong>
                    </td>
                    <td class="text-center">
                        {% if bagging_total_bags > 0 %}
                            <span class="badge bg-warning text-dark rounded-pill fs-6">{{ bagging_total_bags }}袋</span>
                        {% else %}
                            <span class="badge bg-secondary rounded-pill fs-6">0</span>
                        {% endif %}
                    </td>
                    <td>袋詰・割当画面</td>
                </tr>
                <tr>
                    <td>
                        <a href="{% url 'dashboard:mg_orders:order_list' %}?payment_status=UNPAID"><strong>未入金リスト</strong></a>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-warning text-dark rounded-pill fs-6">{{ unpaid_customer_count }}</span>
                    </td>
                    <td>入金管理画面</td>
                </tr>
                <tr {% if packaging_count == 0 %}class="text-muted"{% endif %}>
                    <td>
                        <strong><a href="{% url 'dashboard:mg_workflow:packaging_board' %}">要パッケージングリスト</a></strong>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-warning text-dark rounded-pill fs-6">{{ packaging_count }}</span>
                    </td>
                    <td>パッケージング画面</td>
                </tr>
                <tr class="text-muted">
                    <td>発送待ちパッケージ</td>
                    <td class="text-center">
                        <span class="badge bg-light text-dark rounded-pill fs-6">{{ shipping_packages_count }}</span>
                    </td>
                    <td>
                        <em>※出荷ワークフロー実装時に追加</em>
                    </td>
                </tr>
                <tr class="text-muted">
                    <td>手渡し準備完了</td>
                    <td class="text-center">
                        <span class="badge bg-light text-dark rounded-pill fs-6">{{ ready_for_pickup_count }}</span>
                    </td>
                    <td>
                        <em>※出荷ワークフロー実装時に追加</em>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
{% endblock %}
```

##### **ファイル:** `templates/dashboard/debug.html` **(全面的に上書き)**

```html
{% extends "base.html" %}
{% load humanize %}
{% block title %}デバッグ情報{% endblock %}

{% block content %}
<style>
    .debug-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        border: 1px solid #dee2e6;
        border-radius: .3rem;
        background-color: #f8f9fa;
    }
    .debug-section h2 {
        font-size: 1.5rem;
        border-bottom: 2px solid #0d6efd;
        padding-bottom: .5rem;
        margin-bottom: 1.5rem;
    }
    .data-tree ul {
        list-style-type: none;
        padding-left: 25px;
    }
    .data-tree li {
        margin-bottom: .6rem;
        position: relative;
    }
    .data-tree li::before {
        content: '';
        position: absolute;
        left: -20px;
        top: 0;
        border-left: 1px solid #adb5bd;
        height: 100%;
    }
    .data-tree li:last-child::before {
        height: 12px;
    }
    .data-tree li > strong::before {
        content: '';
        position: absolute;
        left: -20px;
        top: 12px;
        border-top: 1px solid #adb5bd;
        width: 15px;
    }
    .data-tree .card {
        margin-top: 0.5rem;
    }
</style>

<h1>開発者向けデバッグ情報</h1>
<p>現在のシステムの詳細な状態です。この内容をコピーして共有することで、正確な情報共有が可能になります。</p>
<hr>

<!-- 注文ツリー -->
<div class="debug-section">
    <h2>注文ツリー (Orders Tree)</h2>
    <div class="data-tree">
        <ul>
        {% for order in orders_data %}
            <li>
                <strong>Order: ORD-{{ order.id|stringformat:"06d" }}</strong> (購入者: {{ order.user }}, 状態: {{ order.status }})
                <div class="card mt-2">
                    <div class="card-body p-2">
                        <ul>
                            <li><strong>宛先:</strong> {{ order.destination_name }}</li>
                            <li>
                                <strong>注文明細:</strong>
                                <ul>
                                {% for item in order.items %}
                                    <li>
                                        <strong>OrderItem #{{ item.id }}:</strong> {{ item.product_name }} (数量: {{ item.quantity }})
                                        {% if item.allocations %}
                                        <ul><li>
                                            <strong>→ 引当済み:</strong>
                                            <ul>
                                            {% for alloc in item.allocations %}
                                                <li>Allocation #{{ alloc.id }} → Bag #{{ alloc.bag_id }}</li>
                                            {% endfor %}
                                            </ul>
                                        </li></ul>
                                        {% endif %}
                                    </li>
                                {% empty %}
                                    <li>(明細なし)</li>
                                {% endfor %}
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </li>
        {% empty %}
            <li>(注文データなし)</li>
        {% endfor %}
        </ul>
    </div>
</div>

<!-- パッケージング状態 -->
<div class="debug-section">
    <h2>パッケージング状態 (Packaging Status)</h2>
    <div class="data-tree">
        <ul>
        {% for pkg in packages_data %}
            <li>
                <strong>Package #{{ pkg.id }} {% if pkg.label %}/ ラベル: {{ pkg.label }}{% endif %}</strong>
                <div class="card mt-2">
                    <div class="card-body p-2">
                        <ul>
                            <li><strong>宛先:</strong> {{ pkg.destination_name }}</li>
                            <li>
                                <strong>箱の中身 (PackageItem):</strong>
                                <ul>
                                {% for item in pkg.items %}
                                    <li>Bag #{{ item.bag_id }} ({{ item.product_name }})</li>
                                {% empty %}
                                    <li>(空)</li>
                                {% endfor %}
                                </ul>
                            </li>
                            <li>
                                <strong>予約 (PackagePlanItem):</strong>
                                <ul>
                                {% for plan in pkg.plans %}
                                    <li>{{ plan.product_name }} (数量: {{ plan.quantity }})</li>
                                {% empty %}
                                    <li>(予約なし)</li>
                                {% endfor %}
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </li>
        {% empty %}
            <li>(パッケージデータなし)</li>
        {% endfor %}
        </ul>
    </div>
</div>

<!-- 袋の全件ステータス -->
<div class="debug-section">
    <h2>袋の全件ステータス (All Bags Status)</h2>
    <div class="table-responsive">
        <table class="table table-sm table-bordered table-striped">
            <thead class="table-light">
                <tr><th>袋ID</th><th>商品名</th><th>状態</th><th>場所</th><th>引当先</th></tr>
            </thead>
            <tbody>
            {% for bag in bags_data %}
                <tr>
                    <td>Bag #{{ bag.id }}</td>
                    <td>{{ bag.product_name }}</td>
                    <td>{{ bag.status }}</td>
                    <td>{{ bag.location|default:"-" }}</td>
                    <td>{{ bag.allocation_info }}</td>
                </tr>
            {% empty %}
                <tr><td colspan="5" class="text-center">(袋データなし)</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 在庫 -->
<div class="debug-section">
    <h2>在庫 (Stocks)</h2>
    <table class="table table-sm table-bordered" style="max-width: 600px;">
        <thead class="table-light">
            <tr>
                <th>品種</th>
                <th class="text-end">総供給量</th>
                <th class="text-end">総注文量</th>
                <th class="text-end">現在在庫量</th>
            </tr>
        </thead>
        <tbody>
        {% for stock in stocks_data %}
            <tr>
                <td>{{ stock.variety__name }}</td>
                <td class="text-end">{{ stock.total_supplied_kg|floatformat:3 }} kg</td>
                <td class="text-end">{{ stock.total_ordered_kg|floatformat:3 }} kg</td>
                <td class="text-end fw-bold">{{ stock.available_kg|floatformat:3 }} kg</td>
            </tr>
        {% empty %}
            <tr><td colspan="4" class="text-center">(在庫データなし)</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<a href="{% url 'dashboard:dashboard_top' %}" class="btn btn-secondary mt-3">&laquo; ダッシュボードに戻る</a>
{% endblock %}
```

##### **ファイル:** `templates/dashboard/import_old_data.html` **(全面的に上書き)**

```html
{% extends "base_management.html" %}

{% block title %}旧システムデータ取込 | お米販売システム{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">旧システムからのデータ移行</h1>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">データ取込手順</h6>
        </div>
        <div class="card-body">
            <p>
                旧システムのデータをエクスポートしたSQLファイルをアップロードすることで、顧客およびお届け先情報を一括で取り込むことができます。
            </p>
            <ol>
                <li>旧システムから指定された手順でSQLファイル（INSERT文の羅列）をエクスポートします。</li>
                <li>下のフォームでエクスポートしたSQLファイルを選択します。</li>
                <li>「取り込み実行」ボタンをクリックします。</li>
                <li>処理が完了すると、上部にメッセージが表示されます。</li>
            </ol>
        </div>
    </div>

    <div class="alert alert-danger">
        <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>重要：必ずお読みください</h4>
        <p>
            <strong>この操作を実行すると、既存のすべての顧客・お届け先データが削除され、アップロードしたファイルの内容に置き換わります。</strong>
        </p>
        <hr>
        <ul>
            <li>管理者アカウント（スタッフ権限を持つユーザー）は削除されません。</li>
            <li>処理は一度開始すると中断できません。</li>
            <li>ファイルの内容や形式に問題があると、エラーが発生し、データは一切取り込まれません（処理前の状態が維持されます）。</li>
            <li>誤ったファイルをアップロードしないよう、十分に注意してください。</li>
        </ul>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">SQLファイルアップロード</h6>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" action="{% url 'dashboard:import' %}">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="sql_file" class="form-label">データファイル (.sql)</label>
                    <input class="form-control" type="file" id="sql_file" name="sql_file" accept=".sql" required>
                </div>
                <hr>
                <button type="submit" class="btn btn-primary btn-lg" onclick="return confirm('本当に実行しますか？既存の顧客・お届け先データはすべて削除されます。');">
                    <i class="bi bi-upload me-2"></i>取り込み実行
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}
```

##### **ファイル:** `templates/dashboard/manual_management.html` **(全面的に上書き)**

```html
{% extends "base_management.html" %}
{% load humanize %}
{% block title %}マニュアル管理{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">マニュアル管理</h1>
</div>
<p>
    オンラインマニュアル用のMarkdownファイル（.md）を管理します。<br>
    ファイル名は、対応するページのURLから自動生成されるID（例：<code>management_customers_detail.md</code>）と一致させてください。
</p>

<div class="card mb-4">
    <div class="card-header">
        <strong>新規アップロード / 上書き更新</strong>
    </div>
    <div class="card-body">
        <form id="upload-form" method="post" enctype="multipart/form-data" action="{% url 'dashboard:manuals' %}">
            {% csrf_token %}
            <input type="hidden" name="form_action" value="upload">
            <div class="input-group">
                <input type="file" class="form-control" name="manual_files" accept=".md,text/markdown" required multiple>
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-upload"></i> 選択したファイルをアップロード
                </button>
            </div>
            <div class="form-text">
                .md ファイルを複数選択できます (CtrlキーまたはShiftキーを押しながらクリック)。
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <strong>既存のマニュアルファイル</strong>
    </div>
    <div class="card-body p-0">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>ファイル名</th>
                    <th class="text-end">サイズ</th>
                    <th>最終更新日時</th>
                    <th style="width: 10%;"></th>
                </tr>
            </thead>
            <tbody>
                {% for file in manual_files %}
                <tr>
                    <td><i class="bi bi-filetype-md"></i> <code>{{ file.name }}</code></td>
                    <td class="text-end">{{ file.size|filesizeformat }}</td>
                    <td>{{ file.modified_at|date:"Y/m/d H:i:s" }}</td>
                    <td class="text-center">
                        <form method="post" onsubmit="return confirm('本当に「{{ file.name }}」を削除しますか？この操作は元に戻せません。');" action="{% url 'dashboard:manuals' %}">
                            {% csrf_token %}
                            <input type="hidden" name="form_action" value="delete">
                            <input type="hidden" name="filename" value="{{ file.name }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="削除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center p-4 text-muted">
                        マニュアルファイルはまだありません。
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="overwriteConfirmModal" tabindex="-1" aria-labelledby="overwriteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="overwriteConfirmModalLabel">上書きの確認</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>以下のファイルは既に存在します。上書きしますか？</p>
        <ul id="overwrite-file-list" class="list-group">
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-danger" id="confirm-overwrite-btn">上書きして続行</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const uploadForm = document.getElementById('upload-form');
    const overwriteModalEl = document.getElementById('overwriteConfirmModal');
    const overwriteModal = new bootstrap.Modal(overwriteModalEl);
    const fileListEl = document.getElementById('overwrite-file-list');
    const confirmOverwriteBtn = document.getElementById('confirm-overwrite-btn');
    let filesToUpload = null; 

    uploadForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        
        const fileInput = uploadForm.querySelector('input[type="file"]');
        if (fileInput.files.length === 0) {
            alert('ファイルを選択してください。');
            return;
        }
        filesToUpload = fileInput.files;

        const formData = new FormData(uploadForm);
        const submitButton = uploadForm.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 確認中...';

        try {
            const response = await fetch(uploadForm.getAttribute('action'), {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            
            const data = await response.json();

            if (response.ok) {
                if (data.status === 'confirm_overwrite') {
                    fileListEl.innerHTML = '';
                    data.files.forEach(file => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.textContent = file;
                        fileListEl.appendChild(li);
                    });
                    overwriteModal.show();
                } else if (data.status === 'success_reload') {
                    window.location.reload();
                }
            } else {
                alert(`エラー: ${data.message || 'アップロードに失敗しました。'}`);
            }
        } catch (error) {
            console.error('Upload error:', error);
            alert('通信エラーが発生しました。ページを再読み込みして再度お試しください。');
            window.location.reload();
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="bi bi-upload"></i> 選択したファイルをアップロード';
        }
    });

    confirmOverwriteBtn.addEventListener('click', async function () {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 処理中...';
        
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', uploadForm.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('form_action', 'confirm_overwrite');
        
        if (filesToUpload) {
            for (const file of filesToUpload) {
                formData.append('manual_files', file);
            }
        }

        try {
            const response = await fetch(uploadForm.getAttribute('action'), {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            const data = await response.json();
            if (response.ok && data.status === 'success_reload') {
                window.location.reload();
            } else {
                alert(`エラー: ${data.message || '処理に失敗しました。'}`);
            }
        } catch (error) {
            console.error('Confirm overwrite error:', error);
            alert('通信エラーが発生しました。');
        } finally {
            overwriteModal.hide();
            btn.disabled = false;
            btn.innerHTML = '上書きして続行';
            filesToUpload = null;
        }
    });
});
</script>
{% endblock %}
```

#### 5. 手順5：データベースへの反映と動作確認

1. **データベースマイグレーションの実行:**
    この手順書ではモデル構造に変更がないため、マイグレーションコマンドの実行は不要です。

2. **動作確認:**
    * 管理者としてログインし、`/management/debug/`にアクセスします。
    * 一番下の「在庫 (Stocks)」セクションのテーブルが、新しいレイアウト（総供給量, 総注文量, 現在在庫量）で表示されていることを確認します。

```
