### **【更新提案1/2 再々々提示】 `01_要件定義書.md` の更新**

管理者向け機能の「注文編集」の項目に、送料を未確定に戻す挙動を明記します。

##### **ファイル:** `01_要件定義書.md` **(全面的に上書き)**

```markdown
### **【成果物 2/11】 `01_要件定義書` (Ver. 4.3)**

#### **1. はじめに**

##### **1.1. 本書の位置づけ**
本書は、お米販売システムの開発における要求と仕様を定義する唯一のドキュメントである。システムの目的、機能、および非機能要件のすべてを網羅し、開発の指針となる。

##### **1.2. 開発アプローチ**
本プロジェクトでは、厳密なウォーターフォールモデルは採用しない。要件定義、設計、実装、テストのサイクルを機能単位で繰り返す、**反復的・発展的な開発アプローチ（スパイラルモデルに近い考え方）**をとる。
これにより、開発途中で発生する仕様の変更や改善要求に柔軟に対応し、システムの完成度を段階的に高めていくことを目指す。

---

#### **2. システムの概要と目的**

##### **2.1. 概要**
本システムは、農場で生産したお米を特定の招待制顧客に対してオンラインで販売するためのWEBシステムである。友人・知人との信頼関係をベースとした、柔軟な取引の支援を目的とする。

##### **2.2. 目的**
本システムの主な目的は、新規顧客の獲得ではなく、既存の販売業務における以下の課題を解決することにある。
*   **業務の効率化とミスの防止:** 注文受付から出荷、入金管理までの一連のプロセスをシステム化することで、人為的なミス（注文の聞き間違い、発送漏れ、在庫の数え間違いなど）を防止する。
*   **作業の最適化支援:** 管理者の煩雑な思考や判断をシステムが肩代わりし、**常に最適な次のアクションを提案する**ことで、作業の抜け漏れを防ぎ、業務品質を向上させる。
*   **状態の可視化:** 顧客ごとの注文内容や支払い状況を正確に把握し、突発的な問い合わせや変更依頼にも迅速かつ正確に対応できる体制を構築する。

---

#### **3. システムの利用者と認証**

##### **3.1. 利用者種別**
*   **購入者:** 商品の閲覧および注文を行う。
*   **管理者:** 農場主1名のみ。システムの全ての管理機能を操作する。

##### **3.2. 認証**
*   購入者は、管理者が事前に発行したIDとパスワードを用いてログインする。
*   IDおよびパスワードは、`UTF-8`文字セット（**ひらがな、カタカナ、漢字、スペース**等を含む）に対応すること。
*   購入者自身によるアカウントの新規登録機能は不要とする。
*   パスワードを忘れた際のオンライン再設定機能は不要とし、管理者が手動で対応する。

---

#### **4. 機能要件**

##### **4.1. 購入者向け機能**

###### **4.1.1. 画面構成**
*   PCとモバイルの**レスポンシブデザイン**に対応する。
*   基本レイアウトは左サイドバーとメインコンテンツで構成する。

###### **4.1.2. 商品表示・注文**
*   **お届け先の選択:** 商品一覧ページの上部で、管理者が事前に登録したお届け先リストの中から、商品の送付先となるお届け先を一つ選択する。
*   **商品表示:** 商品一覧ページには「商品内容（品種名、精米/玄米、容量）」「価格」「**購入可能な残り在庫数**」を表示する。
*   **在庫状況の表示:** サイドバーに、品種ごとの具体的な残り在庫量（kg単位、小数点表示）と、自身のカートで消費している量（玄米換算）を併記する。
*   **ショッピングカート:**
    *   システムは**「お届け先」ごと**に独立したカート（以下、配送グループ）を持つ。
    *   購入者は、選択中のお届け先に対する配送グループに、商品を直接追加できる。
    *   **在庫チェック:** 商品をカートに追加、または数量を変更する際、リアルタイムで在庫を確認する。在庫が不足する場合は操作をブロックし、エラーメッセージを表示する。
    *   複数の配送グループ（例：「自宅用」「実家への贈り物用」）を同時に保持できる。

###### **4.1.3. 注文手続き**
*   購入者は、サイドバーに表示された内容を確認し、「注文内容の確認へ」ボタンを押す。
*   **注文内容の確認:** 全ての配送グループの内容（お届け先、商品）を一覧で表示する。送料については、**カート内の商品を梱包した場合の見込み箱数から計算した「参考送料」**と、それを加算した「参考合計額」を表示する。「※送料は管理者が梱包を確定した後に正式に決定されます。」という注釈を明記する。
*   **注文の確定:** 確認後、「この内容で注文する」ボタンを押すと、システムは最終的な在庫確認を行う。在庫が確保できた場合、保持している全ての配送グループが、それぞれ**お届け先ごとの個別の「注文」**としてシステムに一括で記録される。在庫が不足した場合は処理を中断し、エラーメッセージを表示する。この際、**算出された参考送料が注文の`provisional_shipping_fee`として保存**される。

###### **4.1.4. 注文後の情報確認**
*   **注文履歴:** ログイン後、マイページで自身の「注文履歴」を確認できる。
*   **注文ステータス確認:** 注文詳細画面で、注文の現在のステータス（例：「新規注文」「発送準備完了」など）と、送料の状態（参考送料か確定送料か）を確認できる。
*   **配送状況確認:** 注文詳細画面で、荷物が発送された場合、箱ごとの「伝票番号」と配送業者の追跡サイトへのリンクを確認できる。
*   **注文のキャンセル:** 自身の注文ステータスが「新規注文」である間に限り、マイページから注文をキャンセルできる。
*   **注文の変更:**
    *   自身の注文ステータスが「新規注文」である間に限り、マイページから注文内容を変更できる。
    *   変更可能な項目は、注文に含まれる**各商品の数量**のみとする。
    *   数量の変更は、画面を再読み込みしない**非同期通信によるスムーズなUI/UX**で提供されること。
*   **請求書ダウンロード:**
    *   注文履歴一覧画面から、**表示されている複数の注文を対象とした一括請求書（PDF形式）をいつでもダウンロード**できる。
    *   請求書は、ダウンロードしたその瞬間の最新の注文内容・金額を反映して、都度システムが自動生成する。
    *   **請求対象の注文の中に`final_shipping_fee`（確定送料）が未設定のものが一つでも含まれる場合、請求書には「送料（未確定）」「合計（暫定）」といった旨が明記される。全ての送料が確定している場合にのみ、最終的な合計金額が表示される。**

##### **4.2. 管理者向け機能**

###### **4.2.1. ダッシュボード（ToDoリスト）**
管理者がログイン後に表示されるトップページ。「次に何をすべきか」がわかるToDoリスト形式で、以下の項目と件数を表示する。

| ToDo項目名 | 件数カウントの対象 | クリック時の遷移先 |
| :--- | :--- | :--- |
| **新規注文（未受付）** | ステータスが「新規注文」の注文数 | 注文管理画面 |
| **要袋詰リスト** | 「注文受付」済の注文から集計した品種・容量ごとの必要袋数 | 袋詰管理画面 |
| **未入金リスト** | 入金ステータスが「未入金」の注文を持つ顧客数 | 注文管理画面 |
| **要パッケージングリスト** | 袋詰が完了し、箱詰め待ちの宛先の数 | 自動引当ボード |
| **発送準備完了** | パッケージステータスが「発送準備完了」の荷物数 | 発送管理画面 |

###### **4.2.2. 料金計算モデル**
*   **商品価格:**
    1.  システムは、品種の基準価格、商品の容量、精米/玄米の別、価格係数を基に**提案単価**を算出する。
    2.  管理者は、商品マスタの編集画面で、この提案単価を参考に価格を設定する。注文編集画面で、個別の注文に対して価格を手動で上書きすることも可能。
*   **送料:**
    *   お届け先に設定された「送料区分（通常/遠地）」に基づき、システムが送料を自動計算する。**（購入者向けには参考値として、管理者向けには最終確定値として利用される）**
*   **消費税:**
    *   管理者が設定する全ての価格は**内税（消費税込み）**として扱う。

###### **4.2.3. 注文管理**
*   **注文一覧:** 全ての注文を、ステータスやキーワードで柔軟に検索・絞り込みできる。
*   **注文受付:** 新規注文を確認し、管理者がステータスを「注文受付」に変更する。
*   **注文編集:**
    *   注文が発送完了となる前であれば、いつでも注文内容（お届け先、商品数量、商品単価、商品の追加・削除）を変更できる。
    *   **注文の商品内容（数量変更、追加、削除）が変更された場合、その注文の`final_shipping_fee`（確定送料）は自動的に`NULL`（未確定状態）に戻される。**

###### **4.2.4. 出荷ワークフロー**
*   **袋詰管理:**
    1.  システムは、「注文受付」済みの全注文から、品種・容量ごとに必要な袋数を自動で集計し、「要袋詰リスト」として表示する。
    2.  管理者は物理的な袋詰作業後、完了した袋数をシステムに登録する。システムはこれを物理的な**『袋在庫』**として管理する。
*   **自動引当・パッケージング提案ボード:**
    1.  **UI:** 画面は「未引当の袋在庫エリア」と「宛先ごとのエリア」で構成される。
    2.  **手動操作:** 管理者は、ドラッグ＆ドロップまたはクリック操作により、袋の箱詰め、箱間の移動、予約の追加・充当などを直感的に行うことができる。
    3.  **自動提案:**
        *   **宛先ごと:** 宛先単位で「自動梱包」を実行すると、その宛先の注文品を箱数が最小になるよう自動で箱詰めする案を提示する。
        *   **一括:** 全体を対象に「一括自動梱包」を実行すると、全宛先の全注文を評価し、システム全体で最も効率的な梱包案を一度に計算し、提案する。
    4.  **ロック機能:** 箱ごとに3段階（変更可、追加のみ可、変更不可）のロック状態を設定でき、自動提案の挙動を細かく制御できる。
    5.  **梱包確定:** 計画が完了した箱を「確定」すると、その箱は「発送準備完了」状態となり、次の発送管理プロセスに進む。この時、システムは**その宛先の注文に紐づく全ての荷物（パッケージ）の梱包が完了したかを自動で判定**する。完了していた場合、**箱数に基づいて最終的な送料を自動計算し、関連する注文の`final_shipping_fee`にその値を保存**する。
*   **発送管理:**
    1.  **一覧表示:** 「発送準備完了」「伝票印刷済み」「完了済み」のタブで、荷物のステータスを管理する。
    2.  **ヤマトB2用CSV出力:** 発送対象の荷物を選択し、ヤマトB2クラウドに取り込むためのCSVファイルをダウンロードする。
    3.  **伝票番号CSVインポート:** ヤマトB2クラウドから出力された伝票番号付きCSVをアップロードすることで、システム内の荷物に伝票番号を自動で紐付ける。
    4.  **ステータス更新と差し戻し:** 「発送済み」「手渡し済み」へのステータス更新や、間違いがあった場合に前のステータスへ差し戻す操作が可能。

###### **4.2.5. ダッシュボード統合管理機能**
*   **顧客管理:** 顧客の検索、新規作成、情報編集、パスワード再設定、およびお届け先情報のCRUD操作を、Django管理サイトではなくシステム専用のUIで完結できる。
*   **マスタ管理:** 品種マスタ、商品マスタのCRUD操作を専用UIで提供する。
*   **在庫管理:** 品種ごとの玄米換算での在庫を管理する。システムは「**総供給量**」と「**総注文量**」をデータとして保持し、「現在在庫量」は両者の差分から動的に計算される。管理者は、専用UIから「総供給量」を**調整量（増減）で更新**する。
*   **動的価格提案:** 商品の作成・編集時、品種や容量の変更に応じて提案価格をリアルタイムで自動計算し、管理者の価格設定を支援する。
*   **安全な削除:** 注文等に利用されている品種や商品は、誤操作防止のために削除ボタンが非活性化される。

###### **4.2.6. システム設定とデータ移行**
*   **システム設定:** 依頼主情報、送料、各種計算係数、請求書の振込先口座情報などは、Django管理サイトで設定する。
*   **旧システムデータ移行:** 管理者は、旧システムからエクスポートしたSQLファイルを専用画面からアップロードすることで、顧客およびお届け先情報を一括で安全に取り込むことができる。

###### **4.2.7. オンラインマニュアル機能**
*   **コンテキスト対応:** 利用者がどの画面を開いているかに応じて、関連するヘルプコンテンツをモーダルウィンドウで表示する。
*   **マニュアル管理:** 管理者は、マニュアルの元となるMarkdown（`.md`）ファイルを、専用画面からアップロード・削除できる。

---

#### **5. 非機能要件**

##### **5.1. UI/UX（デザインと使いやすさ）**
*   華美な装飾は不要とし、シンプルで機能的、利用者が直感的に操作できる分かりやすさを最優先する。
*   管理者向けの主要な操作（顧客編集、マスタ管理、データ移行など）は、Django管理サイトに遷移することなく、システム内で完結する一貫した体験を提供する。

##### **5.2. セキュリティ**
*   **SSL/TLS:** 全てのページで通信を常時暗話化（`HTTPS`化）することを必須とする。
*   **インフラ:** 管理者が用意する`Docker`および`traefik`（リバースプロキシ）環境上で動作させることを前提とする。
*   **在庫整合性:** 注文確定、変更、キャンセルなど、在庫数を変更する全ての処理は、データベースの**トランザクションおよび排他ロック**によって保護され、複数ユーザーによる同時アクセス時でもデータの整合性を保証する。

##### **5.3. 開発・運用**
*   **開発環境:** Dockerコンテナ上で動作させる。
*   **ソースコード管理:** Gitを利用する。
*   **本番環境:** レンタルサーバー上のDockerコンテナで稼働させる。
