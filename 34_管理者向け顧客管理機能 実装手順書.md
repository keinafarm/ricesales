この手順書では、リファクタリングで新設された`mg_customers`アプリケーションに、管理者向けの顧客管理機能を実装します。

---

### **【作業前確認】対象ファイル一覧**

今回のタスク「管理者向け顧客管理機能の実装」では、以下の聖典ファイルを参照・作成します。お手元のファイル群にこれらが全て含まれているか、ご確認ください。

* **バックエンド (新規アプリケーション):**
  * `mg_customers/api.py`
  * `mg_customers/views.py`
  * `mg_customers/urls.py`
* **テンプレート (新規アプリケーション):**
  * `mg_customers/templates/mg_customers/customer_list.html`
  * `mg_customers/templates/mg_customers/customer_create.html`
  * `mg_customers/templates/mg_customers/customer_detail.html`
* **プロジェクト全体への組込:**
  * `dashboard/urls.py` （変更）
* **テンプレート継承元:**
  * `templates/base_management.html`
* **参照するモデル:**
  * `accounts/models.py`

上記ファイルが揃っていることを確認いたしましたので、実装手順書を作成します。

---

### **【機能単位】管理者向け顧客管理機能 実装手順書 (Ver. 3.0)**

#### 1. 目的

現在Django管理サイトで行われている顧客およびお届け先の管理を、システムの管理者向け画面内に統合します。この手順書では、新設された`mg_customers`アプリケーションとして、以下の機能を実装します。

* **顧客一覧画面:** 全顧客を検索・ソート可能な一覧で表示し、新規顧客を追加するボタンを設置します。
* **顧客新規作成画面:** 新しい顧客のログインID、メールアドレス、パスワードを登録できます。
* **顧客詳細画面:**
  * 顧客の基本情報（ログインID、メールアドレス）を画面遷移なく編集できます。
  * モーダルウィンドウでパスワードの再設定が可能です。
  * 顧客に紐づくお届け先情報を非同期で追加・編集・削除（CRUD）できます。
  * パスワード入力欄には、表示/非表示を切り替える「目玉アイコン」を設置します。

#### 2. 手順1：バックエンドの実装 (`mg_customers`アプリケーション)

顧客管理機能のロジック、API、URL定義を`mg_customers`アプリケーションとして新規に作成します。

##### **ファイル:** `mg_customers/api.py` **(新規作成)**

```python
# mg_customers/api.py
from django.http import JsonResponse, HttpRequest
from django.views import View
from django.shortcuts import get_object_or_404
from django.utils.decorators import method_decorator
from django.views.decorators.csrf import csrf_protect
from django.contrib.admin.views.decorators import staff_member_required
import json

from accounts.models import User, Destination

def _json(request: HttpRequest):
    try:
        body = request.body.decode("utf-8") or "{}"
        return json.loads(body)
    except json.JSONDecodeError:
        return {}

def _bad_request(message: str, *, code: str = "invalid_request", errors=None):
    payload = {"ok": False, "error": {"code": code, "message": message}}
    if errors:
        payload["error"]["errors"] = errors
    return JsonResponse(payload, status=400)

def _ok(data=None, *, status: int = 200):
    payload = {"ok": True}
    if data:
        payload.update(data)
    return JsonResponse(payload, status=status)

@method_decorator(staff_member_required(login_url='/accounts/login/'), name="dispatch")
class DestinationListView(View):
    def get(self, request: HttpRequest, user_id: int):
        user = get_object_or_404(User, id=user_id)
        destinations = Destination.objects.filter(user=user).order_by('id')
        data = [
            {
                "id": dest.id,
                "name": dest.name,
                "postal_code": dest.postal_code,
                "address": dest.address,
                "phone": dest.phone,
                "delivery_method": dest.delivery_method,
                "delivery_method_display": dest.get_delivery_method_display(),
                "shipping_zone": dest.shipping_zone,
                "shipping_zone_display": dest.get_shipping_zone_display(),
            }
            for dest in destinations
        ]
        return _ok({"destinations": data})

@method_decorator(csrf_protect, name="dispatch")
@method_decorator(staff_member_required(login_url='/accounts/login/'), name="dispatch")
class DestinationUpsertView(View):
    def post(self, request: HttpRequest):
        data = _json(request)
        dest_id = data.get("id")
        user_id = data.get("user_id")
        if not user_id:
            return _bad_request("ユーザーIDは必須です。")
        user = get_object_or_404(User, id=user_id)
        required_fields = ["name", "postal_code", "address", "phone"]
        if not all(data.get(f) for f in required_fields):
            return _bad_request("宛名、郵便番号、住所、電話番号は必須です。")
        if dest_id:
            destination = get_object_or_404(Destination, id=dest_id, user=user)
        else:
            destination = Destination(user=user)
        destination.name = data.get("name", "")
        destination.postal_code = data.get("postal_code", "")
        destination.address = data.get("address", "")
        destination.phone = data.get("phone", "")
        destination.delivery_method = data.get("delivery_method", "YAMATO")
        destination.shipping_zone = data.get("shipping_zone", "NORMAL")
        destination.save()
        return _ok({"message": "お届け先情報を保存しました。"})

@method_decorator(csrf_protect, name="dispatch")
@method_decorator(staff_member_required(login_url='/accounts/login/'), name="dispatch")
class DestinationDeleteView(View):
    def post(self, request: HttpRequest, pk: int):
        destination = get_object_or_404(Destination, id=pk)
        if destination.order_set.exists():
            return _bad_request("このお届け先は既存の注文に紐付いているため削除できません。")
        destination.delete()
        return _ok({"message": "お届け先を削除しました。"})

@method_decorator(csrf_protect, name="dispatch")
@method_decorator(staff_member_required(login_url='/accounts/login/'), name="dispatch")
class CustomerInfoUpdateView(View):
    def post(self, request: HttpRequest, user_id: int):
        user = get_object_or_404(User, id=user_id)
        data = _json(request)
        new_username = data.get("username", "").strip()
        new_email = data.get("email", "").strip()
        if not new_username:
            return _bad_request("顧客名（ログインID）は必須です。")
        if User.objects.exclude(id=user_id).filter(username=new_username).exists():
            return _bad_request("このログインIDは既に使用されています。")
        user.username = new_username
        user.email = new_email
        user.save(update_fields=['username', 'email'])
        return _ok({"message": "顧客情報を更新しました。"})

@method_decorator(csrf_protect, name="dispatch")
@method_decorator(staff_member_required(login_url='/accounts/login/'), name="dispatch")
class CustomerPasswordSetView(View):
    def post(self, request: HttpRequest, user_id: int):
        user = get_object_or_404(User, id=user_id)
        data = _json(request)
        password = data.get("password")
        if not password or len(password) < 8:
            return _bad_request("パスワードは8文字以上で入力してください。")
        user.set_password(password)
        user.save(update_fields=['password'])
        return _ok({"message": "パスワードを更新しました。"})
```

##### **ファイル:** `mg_customers/views.py` **(新規作成)**

```python
# mg_customers/views.py
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required, user_passes_test
from django.db.models import Sum, F, Count, Max, Q, Value, OuterRef, Subquery
from django.db.models.functions import Coalesce
from django.contrib import messages
import json

from accounts.models import Destination, User
from orders.models import Order, OrderItem

def is_staff_user(user):
    return user.is_staff

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
def customer_list_view(request):
    query = request.GET.get('q', '')
    sort = request.GET.get('sort', '-last_order_date')
    
    # 正しい送料（確定送料があればそれ、なければ参考送料）を注文ごとに集計するサブクエリ
    # キャンセルされた注文は除外する
    shipping_total_subquery = Order.objects.filter(
        user=OuterRef('pk')
    ).exclude(
        status=Order.OrderStatus.CANCELED
    ).values('user').annotate(
        total_shipping=Sum(
            Coalesce('final_shipping_fee', 'provisional_shipping_fee')
        )
    ).values('total_shipping')

    # 商品金額の合計を計算 (キャンセルされた注文は除外)
    items_total_annotation = Sum(
        F('order__items__price_at_order') * F('order__items__quantity'),
        filter=Q(order__isnull=False) & ~Q(order__status=Order.OrderStatus.CANCELED)
    )

    users = User.objects.filter(is_staff=False).annotate(
        last_order_date=Max('order__created_at'),
        # 商品合計と送料合計を別々に計算し、最後に合算することで、
        # 注文商品数によって送料が複数回カウントされる不具合を修正
        total_items_amount=Coalesce(items_total_annotation, Value(0)),
        total_shipping_amount=Coalesce(Subquery(shipping_total_subquery), Value(0))
    ).annotate(
        total_order_amount=F('total_items_amount') + F('total_shipping_amount')
    )

    if query:
        users = users.filter(
            Q(username__icontains=query) |
            Q(destination__name__icontains=query) |
            Q(destination__address__icontains=query)
        ).distinct()
    if sort in ['username', '-username', 'last_order_date', '-last_order_date', 'total_order_amount', '-total_order_amount']:
        users = users.order_by(sort)
    context = {
        'users': users,
        'query': query,
        'sort': sort,
    }
    return render(request, 'mg_customers/customer_list.html', context)

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
def customer_detail_view(request, user_id):
    user = get_object_or_404(User, id=user_id, is_staff=False)
    delivery_method_choices = Destination.DeliveryMethod.choices
    shipping_zone_choices = Destination.ShippingZone.choices
    context = {
        'customer': user,
        'delivery_method_choices_json': json.dumps(delivery_method_choices),
        'shipping_zone_choices_json': json.dumps(shipping_zone_choices),
    }
    return render(request, 'mg_customers/customer_detail.html', context)

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
def customer_create_view(request):
    if request.method == 'POST':
        username = request.POST.get('username', '').strip()
        email = request.POST.get('email', '').strip()
        password = request.POST.get('password', '')
        errors = {}
        if not username:
            errors['username'] = '顧客名（ログインID）は必須です。'
        elif User.objects.filter(username=username).exists():
            errors['username'] = 'このログインIDは既に使用されています。'
        if not password or len(password) < 8:
            errors['password'] = 'パスワードは8文字以上で入力してください。'
        if errors:
            context = {'errors': errors, 'form_data': request.POST}
            return render(request, 'mg_customers/customer_create.html', context)
        new_user = User.objects.create_user(
            username=username,
            email=email,
            password=password
        )
        messages.success(request, f'顧客「{new_user.username}」を登録しました。')
        return redirect('dashboard:mg_customers:customer_detail', user_id=new_user.id)
    return render(request, 'mg_customers/customer_create.html')
```

##### **ファイル:** `mg_customers/urls.py` **(新規作成)**

```python
# mg_customers/urls.py
from django.urls import path
from . import views
from . import api

app_name = 'mg_customers'

urlpatterns = [
    path('', views.customer_list_view, name='customer_list'),
    path('create/', views.customer_create_view, name='customer_create'),
    path('<int:user_id>/', views.customer_detail_view, name='customer_detail'),
    
    # API
    path('api/<int:user_id>/destinations/', api.DestinationListView.as_view(), name='api_destinations_list'),
    path('api/destinations/upsert/', api.DestinationUpsertView.as_view(), name='api_destinations_upsert'),
    path('api/destinations/<int:pk>/delete/', api.DestinationDeleteView.as_view(), name='api_destinations_delete'),
    path('api/<int:user_id>/update-info/', api.CustomerInfoUpdateView.as_view(), name='api_info_update'),
    path('api/<int:user_id>/set-password/', api.CustomerPasswordSetView.as_view(), name='api_password_set'),
]
```

#### 3. 手順2：プロジェクト全体へのURL組込み

`dashboard`アプリケーションのURL定義を修正し、新しく作成した`mg_customers`アプリケーションへのルーティングを追加します。

##### **ファイル:** `dashboard/urls.py` **(全面的に上書き)**

```python
# dashboard/urls.py
from django.urls import path, include
from . import views

urlpatterns = [
    path('', views.dashboard_view, name='dashboard_top'),
    path('debug/', views.debug_view, name='debug_view'),
    path('import/', views.import_old_data_view, name='import'),
    path('manuals/', views.manual_management_view, name='manuals'),
    
    path('orders/', include('mg_orders.urls')),
    # ▼▼▼ 変更点: mg_customersアプリケーションのURLをインクルード ▼▼▼
    path('customers/', include('mg_customers.urls')),
    # ▲▲▲ 変更点ここまで ▲▲▲
    path('masters/', include('mg_masters.urls')),
    path('workflow/', include('mg_workflow.urls')),

    path('api/manuals/<str:page_name>/', views.manual_content_view, name='api_manual_content'),
    path('api/csrf/', views.csrf_seed, name='api_csrf_seed'),
]
```


#### 4. 手順3：フロントエンドの実装 (`mg_customers`アプリケーション)

管理者向け顧客管理機能の各画面に対応するテンプレートファイルを`mg_customers/templates/mg_customers/`ディレクトリに新規作成します。

##### **ファイル:** `mg_customers/templates/mg_customers/customer_list.html` **(新規作成)**

```html
{% extends "base_management.html" %}
{% load humanize %}
{% block title %}顧客管理{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">顧客管理</h1>
    <a href="{% url 'dashboard:mg_customers:customer_create' %}" class="btn btn-primary">
        <i class="bi bi-person-plus"></i> 新規顧客を追加
    </a>
</div>

<div class="card mb-3">
    <div class="card-body">
        <form method="get" action="">
            <div class="input-group">
                <input type="text" class="form-control" name="q" placeholder="顧客名、宛名、住所で検索..." value="{{ query }}">
                <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i> 検索</button>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body p-0">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    {% with sort_username='username' sort_last_order='-last_order_date' sort_total='-total_order_amount' %}
                    <th>
                        <a href="?sort={% if sort == 'username' %}-username{% else %}username{% endif %}&q={{ query }}">
                            顧客名
                            {% if sort == 'username' %}<i class="bi bi-sort-alpha-down"></i>{% elif sort == '-username' %}<i class="bi bi-sort-alpha-up"></i>{% endif %}
                        </a>
                    </th>
                    <th class="text-end">
                        <a href="?sort={% if sort == '-last_order_date' %}last_order_date{% else %}-last_order_date{% endif %}&q={{ query }}">
                            最終注文日
                            {% if sort == '-last_order_date' %}<i class="bi bi-sort-down"></i>{% elif sort == 'last_order_date' %}<i class="bi bi-sort-up"></i>{% endif %}
                        </a>
                    </th>
                    <th class="text-end">
                        <a href="?sort={% if sort == '-total_order_amount' %}total_order_amount{% else %}-total_order_amount{% endif %}&q={{ query }}">
                            累計注文金額
                            {% if sort == '-total_order_amount' %}<i class="bi bi-sort-numeric-down"></i>{% elif sort == 'total_order_amount' %}<i class="bi bi-sort-numeric-up"></i>{% endif %}
                        </a>
                    </th>
                    <th style="width: 10%;"></th>
                    {% endwith %}
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.username }}</td>
                    <td class="text-end">
                        {% if user.last_order_date %}
                            {{ user.last_order_date|date:"Y/m/d" }}
                        {% else %}
                            ー
                        {% endif %}
                    </td>
                    <td class="text-end">{{ user.total_order_amount|intcomma }} 円</td>
                    <td class="text-center">
                        <a href="{% url 'dashboard:mg_customers:customer_detail' user.id %}" class="btn btn-sm btn-outline-primary">詳細</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center p-4">
                        <p class="mb-0">対象の顧客が見つかりませんでした。</p>
                        {% if query %}
                        <a href="{% url 'dashboard:mg_customers:customer_list' %}">検索条件をクリア</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
```

##### **ファイル:** `mg_customers/templates/mg_customers/customer_create.html` **(新規作成)**

```html
{% extends "base_management.html" %}
{% block title %}新規顧客の追加{% endblock %}

{% block extra_css %}
<style>
    .password-wrapper { position: relative; }
    .password-wrapper input { padding-right: 40px !important; }
    .toggle-password { position: absolute; top: 50%; right: 10px; transform: translateY(-50%); cursor: pointer; user-select: none; color: #777; }
</style>
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'dashboard:mg_customers:customer_list' %}">顧客管理</a></li>
    <li class="breadcrumb-item active" aria-current="page">新規追加</li>
  </ol>
</nav>

<h1 class="mb-3">新規顧客の追加</h1>

<div class="card">
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            <div class="mb-3">
                <label for="username" class="form-label">顧客名 (ログインID) <span class="text-danger">*</span></label>
                <input type="text" class="form-control {% if errors.username %}is-invalid{% endif %}" id="username" name="username" value="{% if form_data.username %}{{ form_data.username }}{% endif %}" required>
                {% if errors.username %}<div class="invalid-feedback">{{ errors.username }}</div>{% endif %}
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">メールアドレス</label>
                <input type="email" class="form-control" id="email" name="email" value="{% if form_data.email %}{{ form_data.email }}{% endif %}">
                <small class="form-text text-muted">（任意）注文確認メールなどの通知先として利用されます。</small>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">パスワード <span class="text-danger">*</span></label>
                <div class="password-wrapper">
                    <input type="password" class="form-control {% if errors.password %}is-invalid{% endif %}" id="password" name="password" required>
                    <span class="toggle-password">👁️</span>
                </div>
                 {% if errors.password %}<div class="invalid-feedback">{{ errors.password }}</div>
                 {% else %}<small class="form-text text-muted">8文字以上で設定してください。</small>{% endif %}
            </div>
            <hr>
            <div class="d-flex justify-content-end">
                <a href="{% url 'dashboard:mg_customers:customer_list' %}" class="btn btn-secondary me-2">キャンセル</a>
                <button type="submit" class="btn btn-primary">登録する</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const togglePassword = document.querySelector('.toggle-password');
    const passwordInput = document.getElementById('password');
    if (togglePassword && passwordInput) {
        togglePassword.addEventListener('click', function () {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.textContent = type === 'password' ? '👁️' : '🙈';
        });
    }
});
</script>
{% endblock %}
```

##### **ファイル:** `mg_customers/templates/mg_customers/customer_detail.html` **(新規作成)**

```html
{% extends "base_management.html" %}
{% load humanize %}
{% block title %}顧客詳細 - {{ customer.username }}{% endblock %}

{% block extra_css %}
<style>
    .password-wrapper { position: relative; }
    .password-wrapper input { padding-right: 40px !important; }
    .toggle-password { position: absolute; top: 50%; right: 10px; transform: translateY(-50%); cursor: pointer; user-select: none; color: #777; }
</style>
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'dashboard:mg_customers:customer_list' %}">顧客管理</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ customer.username }}</li>
  </ol>
</nav>
<h1 class="mb-3">顧客詳細</h1>
<div class="row">
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">顧客情報<div id="customer-info-actions"><button class="btn btn-sm btn-outline-secondary" id="edit-customer-btn"><i class="bi bi-pencil"></i> 編集</button></div></div>
            <div class="card-body">
                <div id="customer-info-view"><dl class="row mb-0"><dt class="col-sm-5">ログインID:</dt><dd class="col-sm-7" id="view-username">{{ customer.username }}</dd><dt class="col-sm-5">メールアドレス:</dt><dd class="col-sm-7" id="view-email">{{ customer.email|default:"未設定" }}</dd><dt class="col-sm-5">登録日:</dt><dd class="col-sm-7">{{ customer.date_joined|date:"Y/m/d" }}</dd></dl></div>
                <div id="customer-info-edit" class="d-none"><div class="mb-3"><label for="edit-username-input" class="form-label">顧客名 (ログインID)</label><input type="text" id="edit-username-input" class="form-control form-control-sm" value="{{ customer.username }}"></div><div class="mb-3"><label for="edit-email-input" class="form-label">メールアドレス</label><input type="email" id="edit-email-input" class="form-control form-control-sm" value="{{ customer.email }}"></div><div class="d-flex justify-content-end"><button class="btn btn-sm btn-secondary me-2" id="cancel-edit-customer-btn">中止</button><button class="btn btn-sm btn-primary" id="save-customer-btn">保存</button></div></div>
            </div>
        </div>
        <div class="card"><div class="card-header">セキュリティ</div><div class="card-body"><button class="btn btn-outline-danger" id="set-password-btn">パスワードを再設定する</button></div></div>
    </div>
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">お届け先情報<button class="btn btn-sm btn-primary" id="add-destination-btn"><i class="bi bi-plus-circle"></i> 新規追加</button></div>
            <div class="card-body"><div id="destination-list" class="list-group"></div><div id="destination-list-empty" class="alert alert-secondary d-none">お届け先はまだ登録されていません。</div></div>
        </div>
    </div>
</div>
<div class="modal fade" id="destinationModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="destinationModalLabel">お届け先の編集</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="destination-form"><input type="hidden" id="dest-id"><input type="hidden" id="dest-user-id" value="{{ customer.id }}"><div class="mb-3"><label for="dest-name" class="form-label">宛名 <span class="text-danger">*</span></label><input type="text" class="form-control" id="dest-name" required></div><div class="row mb-3"><div class="col-md-6"><label for="dest-postal-code" class="form-label">郵便番号 <span class="text-danger">*</span></label><input type="text" class="form-control" id="dest-postal-code" placeholder="例: 123-4567" required></div><div class="col-md-6"><label for="dest-phone" class="form-label">電話番号 <span class="text-danger">*</span></label><input type="text" class="form-control" id="dest-phone" placeholder="例: 090-1234-5678" required></div></div><div class="mb-3"><label for="dest-address" class="form-label">住所 <span class="text-danger">*</span></label><input type="text" class="form-control" id="dest-address" required></div><div class="row mb-3"><div class="col-md-6"><label for="dest-delivery-method" class="form-label">配送方法</label><select id="dest-delivery-method" class="form-select"></select></div><div class="col-md-6"><label for="dest-shipping-zone" class="form-label">送料区分</label><select id="dest-shipping-zone" class="form-select"></select></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button><button type="button" class="btn btn-primary" id="save-destination-btn">保存</button></div></div></div></div>
<div class="modal fade" id="passwordModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="passwordModalLabel">パスワードの再設定</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>新しいパスワードを<strong>8文字以上</strong>で入力してください。</p><form id="password-form"><div class="mb-3"><label for="new-password" class="form-label">新しいパスワード</label><div class="password-wrapper"><input type="password" class="form-control" id="new-password"><span class="toggle-password">👁️</span></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button><button type="button" class="btn btn-primary" id="save-password-btn">設定する</button></div></div></div></div>
<div class="toast-container position-fixed bottom-0 end-0 p-3"><div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true"><div class="toast-header"><strong id="appToastTitle" class="me-auto">通知</strong><button type="button" class="btn-close" data-bs-dismiss="toast"></button></div><div id="appToastBody" class="toast-body"></div></div></div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const USER_ID = {{ customer.id }};
    const deliveryMethodChoices = JSON.parse('{{ delivery_method_choices_json|escapejs }}');
    const shippingZoneChoices = JSON.parse('{{ shipping_zone_choices_json|escapejs }}');
    const destinationModal = new bootstrap.Modal(document.getElementById('destinationModal'));
    const passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'));
    const appToast = new bootstrap.Toast(document.getElementById('appToast'), { delay: 4000 });
    let allDestinations = [];
    function getCookie(name) { const v = `; ${document.cookie}`; const p = v.split(`; ${name}=`); if (p.length === 2) return p.pop().split(';').shift(); }
    function showToast(message, type = 'success') { const t = appToast._element; t.querySelector('#appToastBody').textContent = message; const h = t.querySelector('.toast-header'); h.classList.remove('bg-success', 'bg-danger', 'text-white'); if (type === 'success') { t.querySelector('#appToastTitle').textContent = '成功'; h.classList.add('bg-success', 'text-white'); } else { t.querySelector('#appToastTitle').textContent = 'エラー'; h.classList.add('bg-danger', 'text-white'); } appToast.show(); }
    async function api(path, { method = 'GET', json, headers } = {}) { const hds = { 'X-CSRFToken': getCookie('csrftoken'), ...headers }; let body; if (json !== undefined) { hds['Content-Type'] = 'application/json'; body = JSON.stringify(json); } const res = await fetch(path, { method, headers: hds, body }); const data = await res.json().catch(() => null); return { ok: res.ok, status: res.status, data }; }
    const customerInfoView = document.getElementById('customer-info-view'); const customerInfoEdit = document.getElementById('customer-info-edit');
    function toggleCustomerInfoEdit(isEditMode) { customerInfoView.classList.toggle('d-none', isEditMode); customerInfoEdit.classList.toggle('d-none', !isEditMode); }
    document.getElementById('edit-customer-btn').addEventListener('click', () => { toggleCustomerInfoEdit(true); });
    document.getElementById('cancel-edit-customer-btn').addEventListener('click', () => { document.getElementById('edit-username-input').value = document.getElementById('view-username').textContent; document.getElementById('edit-email-input').value = document.getElementById('view-email').textContent; toggleCustomerInfoEdit(false); });
    document.getElementById('save-customer-btn').addEventListener('click', async () => { const newUsername = document.getElementById('edit-username-input').value; const newEmail = document.getElementById('edit-email-input').value; const res = await api(`/management/customers/api/${USER_ID}/update-info/`, { method: 'POST', json: { username: newUsername, email: newEmail } }); if (res.ok) { showToast(res.data.message); document.getElementById('view-username').textContent = newUsername; document.querySelector('.breadcrumb-item.active').textContent = newUsername; document.title = `顧客詳細 - ${newUsername}`; document.getElementById('view-email').textContent = newEmail || '未設定'; toggleCustomerInfoEdit(false); } else { showToast(res.data?.error?.message || '更新に失敗しました。', 'danger'); } });
    document.getElementById('set-password-btn').addEventListener('click', () => { document.getElementById('password-form').reset(); passwordModal.show(); });
    document.getElementById('save-password-btn').addEventListener('click', async () => { const password = document.getElementById('new-password').value; const res = await api(`/management/customers/api/${USER_ID}/set-password/`, { method: 'POST', json: { password: password } }); if (res.ok) { showToast(res.data.message); passwordModal.hide(); } else { showToast(res.data?.error?.message || 'パスワードの設定に失敗しました。', 'danger'); } });
    const togglePasswordModal = document.querySelector('#passwordModal .toggle-password'); const passwordInputModal = document.getElementById('new-password'); if (togglePasswordModal && passwordInputModal) { togglePasswordModal.addEventListener('click', function () { const type = passwordInputModal.getAttribute('type') === 'password' ? 'text' : 'password'; passwordInputModal.setAttribute('type', type); this.textContent = type === 'password' ? '👁️' : '🙈'; }); }
    function renderDestinations() { const c = document.getElementById('destination-list'); const e = document.getElementById('destination-list-empty'); c.innerHTML = ''; if (allDestinations.length === 0) { e.classList.remove('d-none'); return; } e.classList.add('d-none'); allDestinations.forEach(d => { const i = document.createElement('div'); i.className = 'list-group-item list-group-item-action'; i.innerHTML = `<div class="d-flex w-100 justify-content-between"><h6 class="mb-1">${d.name}</h6><div><button class="btn btn-sm btn-outline-secondary edit-btn" data-id="${d.id}"><i class="bi bi-pencil"></i> 編集</button> <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${d.id}"><i class="bi bi-trash"></i> 削除</button></div></div><p class="mb-1 small">〒${d.postal_code} ${d.address}</p><small class="text-muted">電話: ${d.phone} / 配送: ${d.delivery_method_display}</small>`; c.appendChild(i); }); }
    async function fetchDestinations() { const res = await api(`/management/customers/api/${USER_ID}/destinations/`); if (res.ok) { allDestinations = res.data.destinations; renderDestinations(); } else { showToast('お届け先情報の読み込みに失敗しました。', 'danger'); } }
    function populateSelect(selectId, choices, selectedValue) { const s = document.getElementById(selectId); s.innerHTML = ''; choices.forEach(([v, t]) => { const o = new Option(t, v); if (v === selectedValue) o.selected = true; s.add(o); }); }
    function openModal(destination = null) { const f = document.getElementById('destination-form'); f.reset(); document.getElementById('destinationModalLabel').textContent = destination ? 'お届け先の編集' : 'お届け先の新規追加'; document.getElementById('dest-id').value = destination?.id || ''; if (destination) { document.getElementById('dest-name').value = destination.name; document.getElementById('dest-postal-code').value = destination.postal_code; document.getElementById('dest-phone').value = destination.phone; document.getElementById('dest-address').value = destination.address; } populateSelect('dest-delivery-method', deliveryMethodChoices, destination?.delivery_method || 'YAMATO'); populateSelect('dest-shipping-zone', shippingZoneChoices, destination?.shipping_zone || 'NORMAL'); destinationModal.show(); }
    document.getElementById('add-destination-btn').addEventListener('click', () => openModal());
    document.getElementById('destination-list').addEventListener('click', (e) => { const eb = e.target.closest('.edit-btn'); if (eb) { const dId = parseInt(eb.dataset.id, 10); const d = allDestinations.find(d => d.id === dId); if (d) openModal(d); } const db = e.target.closest('.delete-btn'); if (db) { const dId = parseInt(db.dataset.id, 10); if (confirm('このお届け先を本当に削除しますか？\n（既存の注文に紐付いている場合は削除できません）')) { handleDelete(dId); } } });
    document.getElementById('save-destination-btn').addEventListener('click', async () => { const p = { id: document.getElementById('dest-id').value || null, user_id: USER_ID, name: document.getElementById('dest-name').value, postal_code: document.getElementById('dest-postal-code').value, phone: document.getElementById('dest-phone').value, address: document.getElementById('dest-address').value, delivery_method: document.getElementById('dest-delivery-method').value, shipping_zone: document.getElementById('dest-shipping-zone').value, }; if (p.id) p.id = parseInt(p.id, 10); const res = await api('/management/customers/api/destinations/upsert/', { method: 'POST', json: p }); if (res.ok) { showToast(res.data.message); destinationModal.hide(); fetchDestinations(); } else { showToast(res.data?.error?.message || '保存に失敗しました。', 'danger'); } });
    async function handleDelete(destinationId) { const res = await api(`/management/customers/api/destinations/${destinationId}/delete/`, { method: 'POST' }); if (res.ok) { showToast(res.data.message); fetchDestinations(); } else { showToast(res.data?.error?.message || '削除に失敗しました。', 'danger'); } }
    fetchDestinations();
});
</script>
{% endblock %}
```

#### 5. 手順4：データベースへの反映と動作確認

1. **データベースマイグレーションの実行:**
    この手順書ではモデル構造に変更がないため、マイグレーションコマンドの実行は不要です。

2. **動作確認:**
    * 管理者としてログインし、サイドバーから「顧客管理」にアクセスします。
    * **顧客一覧画面:**
        * URLが`/management/customers/`となっていることを確認します。
        * 右上の「新規顧客を追加」ボタンから新規顧客追加画面に遷移することを確認します。
        * 検索やソートが機能することを確認します。
    * **顧客新規作成画面:**
        * パスワード入力欄の「目玉アイコン」が機能することを確認します。
        * フォームを正しく入力し、「登録する」ボタンを押すと顧客が作成され、その顧客の詳細画面にリダイレクトされることを確認します。
    * **顧客詳細画面:**
        * URLが`/management/customers/<user_id>/`となっていることを確認します。
        * 顧客情報のインライン編集、パスワード再設定、お届け先情報の非同期CRUDがすべて意図通りに動作することを確認します。

---
---

ご確認いただき、問題ないようでしたら、次に`30_共通基盤設定 実装手順書.md`の更新案を提示します。