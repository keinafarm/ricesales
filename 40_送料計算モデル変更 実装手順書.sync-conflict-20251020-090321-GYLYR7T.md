### **【機能単位】新・送料計算モデル 実装手順書 (Ver. 1.4 - 最終確定版) - Part 1/3**

#### 1. 目的

この手順書は、`01_要件定義書 (Ver. 4.3)` および `03_基本設計書 (Ver. 5.2)` で定義された新しい送料計算モデルをシステムに実装するための、唯一の公式ドキュメントです。

この手順書を適用することで、以下の仕様が実現されます。

* **データベースの更新:** `Order` モデルが「参考送料」と「確定送料」を個別に保持できるようになります。
* **参考送料の自動計算:** 購入者が注文確認画面に進む際、カートの中身から梱包をシミュレーションし、算出された「参考送料」を提示します。
* **確定送料の保存:** 管理者がパッケージング管理画面で梱包を完了させた際、実際の箱数に基づいた「確定送料」が自動で計算・保存されます。
* **送料の自動リセット:** 管理者が一度送料が確定した注文の商品内容を変更すると、安全のため「確定送料」が自動的にリセット（未確定状態に）されます。
* **UIの連動:** 注文詳細画面や請求書PDFなど、システムのあらゆる画面で送料の確定状態が正しく反映されます。
* **管理サイトの修正:** Django管理サイトが、モデルの変更に追従して正しく動作するようになります。

#### 2. 手順1：モデル定義の更新 (`orders/models.py`)

##### **ファイル:** `orders/models.py` **(全面的に上書き)**

```python
# orders/models.py
from django.db import models
from django.conf import settings
from django.utils import timezone
from decimal import Decimal
from django.db.models import Sum, F, Count

class Order(models.Model):
    class OrderStatus(models.TextChoices):
        NEW = 'NEW', '新規注文'
        ACCEPTED = 'ACCEPTED', '注文受付'
        PACKED = 'PACKED', '梱包完了'
        SHIPPED = 'SHIPPED', '発送済み'
        DELIVERED = 'DELIVERED', '手渡し済み'
        CANCELED = 'CANCELED', 'キャンセル済み'
    class PaymentStatus(models.TextChoices):
        UNPAID = 'UNPAID', '未入金'
        PAID = 'PAID', '入金済み'

    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.PROTECT, verbose_name='購入者')
    destination = models.ForeignKey('accounts.Destination', on_delete=models.PROTECT, verbose_name='お届け先')
    status = models.CharField(max_length=20, choices=OrderStatus.choices, default=OrderStatus.NEW, verbose_name='注文ステータス')
    payment_status = models.CharField(max_length=20, choices=PaymentStatus.choices, default=PaymentStatus.UNPAID, verbose_name='入金ステータス')
    
    provisional_shipping_fee = models.IntegerField(verbose_name='参考送料')
    final_shipping_fee = models.IntegerField(null=True, blank=True, verbose_name='確定送料')

    created_at = models.DateTimeField(auto_now_add=True, verbose_name='注文日時')

    class Meta:
        verbose_name = '注文'
        verbose_name_plural = '注文ヘッダー'

    @property
    def is_shipping_fee_finalized(self):
        return self.final_shipping_fee is not None

    @property
    def shipping_fee(self):
        if self.is_shipping_fee_finalized:
            return self.final_shipping_fee
        return self.provisional_shipping_fee

    @property
    def items_subtotal(self):
        aggregation = self.items.aggregate(
            subtotal=Sum(F('price_at_order') * F('quantity'))
        )
        return aggregation['subtotal'] or 0

    @property
    def total_price(self):
        return self.items_subtotal + self.shipping_fee

    @property
    def is_cancelable(self):
        return self.status == self.OrderStatus.NEW

    @property
    def is_editable(self):
        return self.status not in [self.OrderStatus.SHIPPED, self.OrderStatus.DELIVERED, self.OrderStatus.CANCELED]

    @property
    def is_canceled(self):
        return self.status == self.OrderStatus.CANCELED

    @property
    def is_acceptable(self):
        return self.status == self.OrderStatus.NEW

    @property
    def is_paid(self):
        return self.payment_status == self.PaymentStatus.PAID
    
    @property
    def packages(self):
        return Package.objects.filter(
            items__bag__allocation__order_item__order=self
        ).distinct()
    
    def get_total_weight_in_genmai(self):
        total_weight = Decimal('0')
        seimai_coefficient = Decimal(str(settings.SEIMAI_WEIGHT_COEFFICIENT))
        for item in self.items.all():
            weight = item.product.weight_kg * item.quantity
            if item.product.type == '精米':
                weight *= seimai_coefficient
            total_weight += weight
        return total_weight

    def get_total_weight_in_genmai_for_variety(self, variety_id):
        total_weight = Decimal('0')
        seimai_coefficient = Decimal(str(settings.SEIMAI_WEIGHT_COEFFICIENT))
        for item in self.items.filter(product__variety_id=variety_id):
            weight = item.product.weight_kg * item.quantity
            if item.product.type == '精米':
                weight *= seimai_coefficient
            total_weight += weight
        return total_weight

    def __str__(self):
        return f"注文ID: {self.id} ({self.user.username}様)"


class OrderItem(models.Model):
    order = models.ForeignKey(Order, on_delete=models.CASCADE, related_name='items', verbose_name='注文')
    product = models.ForeignKey('products.Product', on_delete=models.PROTECT, verbose_name='商品')
    price_at_order = models.IntegerField(verbose_name='注文時単価')
    quantity = models.PositiveIntegerField(verbose_name='数量')

    class Meta:
        verbose_name = '注文明細'
        verbose_name_plural = '注文明細'

    @property
    def subtotal(self):
        return self.price_at_order * self.quantity

    def __str__(self):
        return f"{self.product.name} (数量: {self.quantity})"


class Bag(models.Model):
    product = models.ForeignKey('products.Product', on_delete=models.PROTECT, verbose_name='商品')
    prepared = models.BooleanField(default=False, verbose_name='袋詰済み')
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='作成日時')
    updated_at = models.DateTimeField(auto_now=True, verbose_name='更新日時')

    class Meta:
        verbose_name = '袋'
        verbose_name_plural = '袋在庫'

    def __str__(self):
        status = "袋詰済" if self.prepared else "未準備"
        return f"袋ID: {self.id} ({self.product.name}, {status})"

    @property
    def is_unprepared(self) -> bool:
        return not self.prepared

    @property
    def is_allocated(self) -> bool:
        return hasattr(self, 'allocation')

    @property
    def is_packaged(self) -> bool:
        return hasattr(self, 'packageitem')


class Allocation(models.Model):
    order_item = models.ForeignKey(OrderItem, on_delete=models.CASCADE, related_name='allocations', verbose_name='注文明細')
    bag = models.OneToOneField(Bag, on_delete=models.CASCADE, related_name='allocation', verbose_name='袋')
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='引当日時')

    class Meta:
        verbose_name = '引当'
        verbose_name_plural = '引当'

    def __str__(self):
        return f"引当: Bag#{self.bag_id} -> OrderItem#{self.order_item_id}"


class Package(models.Model):
    class PackageStatus(models.TextChoices):
        PACKAGING = 'PACKAGING', '準備中'
        READY_TO_SHIP = 'READY_TO_SHIP', '発送準備完了'
        LABEL_PRINTED = 'LABEL_PRINTED', '伝票印刷済み'
        SHIPPED = 'SHIPPED', '発送済み'
        DELIVERED = 'DELIVERED', '手渡し済み'

    class LockStatus(models.TextChoices):
        UNLOCKED = 'UNLOCKED', '変更可'
        APPEND_ONLY = 'APPEND_ONLY', '追加のみ可'
        LOCKED = 'LOCKED', '変更不可'

    destination = models.ForeignKey('accounts.Destination', on_delete=models.PROTECT, verbose_name='お届け先')
    status = models.CharField(max_length=20, choices=PackageStatus.choices, default=PackageStatus.PACKAGING, verbose_name='パッケージステータス')
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='作成日時')
    updated_at = models.DateTimeField(auto_now=True, verbose_name='更新日時')
    label = models.CharField(max_length=50, null=True, blank=True, verbose_name='箱ラベル')
    lock_status = models.CharField(max_length=20, choices=LockStatus.choices, default=LockStatus.UNLOCKED, verbose_name='ロック状態')
    csv_exported_at = models.DateTimeField(null=True, blank=True, verbose_name='CSV出力日時')
    tracking_number = models.CharField('伝票番号', max_length=50, null=True, blank=True)

    class Meta:
        verbose_name = 'パッケージ'
        verbose_name_plural = 'パッケージ'
        ordering = ['-created_at']

    def __str__(self):
        return f"PackageID: {self.id} ({self.destination.name}様宛)"

    @property
    def tracking_url(self):
        """ヤマト運輸の荷物追跡URLを生成する"""
        if self.tracking_number and self.destination.delivery_method == 'YAMATO':
            return f"https://toi.kuronekoyamato.co.jp/cgi-bin/tneko?&t_no={self.tracking_number}"
        return None


class PackageItem(models.Model):
    package = models.ForeignKey(Package, on_delete=models.CASCADE, related_name='items', verbose_name='パッケージ')
    bag = models.OneToOneField(Bag, on_delete=models.PROTECT, verbose_name='袋')

    class Meta:
        verbose_name = 'パッケージ明細'
        verbose_name_plural = 'パッケージ明細'

    def __str__(self):
        return f"{self.package} に含まれる {self.bag}"


class PackagePlanItem(models.Model):
    package = models.ForeignKey(Package, on_delete=models.CASCADE, related_name='plan_items', verbose_name='パッケージ')
    product = models.ForeignKey('products.Product', on_delete=models.PROTECT, verbose_name='商品')
    quantity = models.PositiveIntegerField(default=0, verbose_name='予約数量')
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='作成日時')
    updated_at = models.DateTimeField(auto_now=True, verbose_name='更新日時')

    class Meta:
        verbose_name = 'パッケージ計画'
        verbose_name_plural = 'パッケージ計画'
        unique_together = (('package', 'product'),)

    def __str__(self):
        return f"Plan: pkg#{self.package_id} {self.product.name} x {self.quantity}"
```

#### 3. 手順2：Django管理サイト定義の修正 (`orders/admin.py`)

##### **ファイル:** `orders/admin.py` **(全面的に上書き)**

```python
# orders/admin.py
from django.contrib import admin
from .models import Order, OrderItem, Bag, Package, PackageItem

class OrderItemInline(admin.TabularInline):
    model = OrderItem
    extra = 1

@admin.register(Order)
class OrderAdmin(admin.ModelAdmin):
    list_display = ('id', 'user', 'status', 'payment_status', 'created_at')
    list_filter = ('status', 'payment_status')
    inlines = [OrderItemInline]

@admin.register(Bag)
class BagAdmin(admin.ModelAdmin):
    list_display = ('id', 'product', 'prepared', 'get_order_item', 'created_at')
    list_select_related = ('product', 'allocation__order_item__order')
    search_fields = ('product__name',)

    def get_order_item(self, obj):
        return getattr(getattr(obj, 'allocation', None), 'order_item', None)
    get_order_item.short_description = '紐づく注文明細'

@admin.register(Package)
class PackageAdmin(admin.ModelAdmin):
    list_display = ('id', 'destination', 'status', 'created_at')
    list_filter = ('status',)

@admin.register(PackageItem)
class PackageItemAdmin(admin.ModelAdmin):
    list_display = ('id', 'package', 'bag')
```

#### 4. 手順3：バックエンドロジックの修正

##### **ファイル:** `orders/views.py` **(全面的に上書き)**

```python
# orders/views.py
from django.http import HttpResponse, JsonResponse
from django.template.loader import get_template
from xhtml2pdf import pisa
import os
from django.contrib.staticfiles import finders
from system_settings.models import SystemSetting

from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required
from django.db import transaction
from django.contrib import messages
from django.conf import settings
from decimal import Decimal
from .models import Order, OrderItem, Package
from products.models import Product, Stock, ProductVariety
from accounts.models import Destination
from cart.cart import Cart

from django.utils import timezone
from django.views.decorators.http import require_POST
from django.urls import reverse

def _calculate_provisional_shipping_fee(cart_group):
    """カートグループから梱包をシミュレートし、参考送料を計算する"""
    from mg_workflow.api_packaging import _pack_bags

    pseudo_bags = []
    for item in cart_group['items']:
        for _ in range(item['quantity']):
            pseudo_bag = type('PseudoBag', (), {
                'product': item['product'],
            })()
            pseudo_bags.append(pseudo_bag)

    if not pseudo_bags:
        return 0

    max_weight = Decimal(str(getattr(settings, "PACKAGE_MAX_WEIGHT_KG", 25.0)))
    box_weight = Decimal(str(getattr(settings, "DEFAULT_BOX_WEIGHT_KG", 0.5)))
    packaged_groups = _pack_bags(pseudo_bags, max_weight, box_weight)
    
    box_count = len(packaged_groups)
    
    destination = cart_group['destination']
    if destination.delivery_method == 'TEWATASHI':
        return 0
    
    base_fee = settings.REMOTE_SHIPPING_FEE if destination.shipping_zone == 'ENCHI' else settings.NORMAL_SHIPPING_FEE
    return int(base_fee * box_count)

@login_required
def order_confirm(request):
    cart = Cart(request)
    if len(cart) == 0:
        messages.warning(request, 'カートが空です。')
        return redirect('products:product_list')
    
    seimai_coefficient = Decimal(settings.SEIMAI_WEIGHT_COEFFICIENT)
    required_stock_by_variety = {}
    
    cart_groups_with_fee = []
    grand_total = 0
    
    for group in cart:
        for item in group['items']:
            product = item['product']
            weight_needed = product.weight_kg * item['quantity']
            if product.type == Product.ProductType.SEIMAI:
                weight_needed *= seimai_coefficient
            required_stock_by_variety.setdefault(product.variety.id, Decimal('0'))
            required_stock_by_variety[product.variety.id] += weight_needed
        
        provisional_fee = _calculate_provisional_shipping_fee(group)
        group['provisional_shipping_fee'] = provisional_fee
        group['group_total_price_provisional'] = group['items_subtotal'] + provisional_fee
        cart_groups_with_fee.append(group)
        grand_total += group['group_total_price_provisional']

    stocks = Stock.objects.filter(variety_id__in=required_stock_by_variety.keys())
    stock_map = {stock.variety_id: stock for stock in stocks}

    for variety_id, weight_needed in required_stock_by_variety.items():
        stock = stock_map.get(variety_id)
        if not stock or stock.available_kg < weight_needed:
            variety_name = get_object_or_404(ProductVariety, id=variety_id).name
            messages.error(request, f'申し訳ありません。「{variety_name}」を含む商品の在庫が不足しているため、注文内容の確認に進めません。カートの内容を修正してください。')
            return redirect('products:product_list')

    context = {
        'cart_groups': cart_groups_with_fee,
        'grand_total_provisional': grand_total,
    }
    return render(request, 'orders/confirm.html', context)

@login_required
@transaction.atomic
def order_create(request):
    if request.method != 'POST':
        return redirect('orders:order_confirm')
        
    cart = Cart(request)
    if len(cart) == 0:
        messages.warning(request, 'カートが空のため注文できませんでした。')
        return redirect('products:product_list')
    
    seimai_coefficient = Decimal(settings.SEIMAI_WEIGHT_COEFFICIENT)
    required_stock_by_variety = {}
    
    product_ids_by_variety = {}

    for group in cart:
        for item in group['items']:
            product = item['product']
            weight_needed = product.weight_kg * item['quantity']
            if product.type == Product.ProductType.SEIMAI:
                weight_needed *= seimai_coefficient
            
            required_stock_by_variety.setdefault(product.variety.id, Decimal('0'))
            required_stock_by_variety[product.variety.id] += weight_needed

            if product.variety.id not in product_ids_by_variety:
                product_ids_by_variety[product.variety.id] = set()
            product_ids_by_variety[product.variety.id].add(product.id)

    variety_ids_to_lock = list(required_stock_by_variety.keys())
    stocks = Stock.objects.select_for_update().filter(variety_id__in=variety_ids_to_lock)
    stock_map = {stock.variety_id: stock for stock in stocks}

    for variety_id, weight_needed in required_stock_by_variety.items():
        stock = stock_map.get(variety_id)
        if not stock or stock.available_kg < weight_needed:
            variety_name = get_object_or_404(ProductVariety, id=variety_id).name
            messages.error(request, f'申し訳ありません。手続きの途中で「{variety_name}」を含む商品の在庫がなくなりました。')
            return redirect('products:product_list')

    for group in cart:
        destination = group['destination']
        provisional_fee = _calculate_provisional_shipping_fee(group)
        
        order = Order.objects.create(
            user=request.user, 
            destination=destination, 
            provisional_shipping_fee=provisional_fee
        )
        
        for item in group['items']:
            product = item['product']
            OrderItem.objects.create(order=order, product=product, price_at_order=item['price'], quantity=item['quantity'])
            
            stock = stock_map.get(product.variety.id)
            weight_to_add = product.weight_kg * item['quantity']
            if product.type == Product.ProductType.SEIMAI:
                weight_to_add *= seimai_coefficient
            
            stock.total_ordered_kg += weight_to_add
            stock.save(update_fields=['total_ordered_kg', 'updated_at'])

    cart.clear()
    messages.success(request, 'ご注文ありがとうございました。')
    return redirect('orders:order_history_list')

@login_required
def order_history_list(request):
    show_all = request.GET.get('show_all') == 'true'
    orders_query = Order.objects.filter(user=request.user)

    if not show_all:
        orders_query = orders_query.exclude(status=Order.OrderStatus.CANCELED)

    orders = orders_query.prefetch_related(
        'items', 
        'items__allocations__bag__packageitem__package'
    ).order_by('-created_at')
    
    context = {
        'orders': orders,
        'show_all': show_all,
    }
    return render(request, 'orders/history_list.html', context)


@login_required
def order_detail(request, order_id):
    order = get_object_or_404(
        Order.objects.prefetch_related(
            'items__product',
            'items__allocations__bag__packageitem__package__items__bag__product'
        ), 
        id=order_id, 
        user=request.user
    )
    context = {
        'order': order,
    }
    return render(request, 'orders/detail.html', context)

@login_required
@require_POST
@transaction.atomic
def order_cancel(request, order_id):
    order = get_object_or_404(Order, id=order_id, user=request.user)

    if not order.is_cancelable:
        messages.error(request, 'この注文はキャンセルできません。')
        return redirect('orders:order_detail', order_id=order.id)
    
    seimai_coefficient = Decimal(settings.SEIMAI_WEIGHT_COEFFICIENT)
    stock_updates = {}

    for item in order.items.all():
        weight_to_restore = item.product.weight_kg * item.quantity
        if item.product.type == Product.ProductType.SEIMAI:
            weight_to_restore *= seimai_coefficient
        
        stock_updates.setdefault(item.product.variety_id, Decimal('0'))
        stock_updates[item.product.variety_id] += weight_to_restore

    variety_ids_to_lock = list(stock_updates.keys())
    stocks = Stock.objects.select_for_update().filter(variety_id__in=variety_ids_to_lock)

    for stock in stocks:
        restore_amount = stock_updates.get(stock.variety_id, Decimal('0'))
        stock.total_ordered_kg -= restore_amount
        stock.save(update_fields=['total_ordered_kg', 'updated_at'])

    order.status = Order.OrderStatus.CANCELED
    order.save()

    messages.success(request, f'注文(ORD-{order.id:06d})をキャンセルしました。')
    return redirect('orders:order_history_list')

def link_callback(uri, rel):
    result = finders.find(uri)
    if result:
        if not isinstance(result, (list, tuple)):
            result = [result]
        return result
    return uri

@login_required
def generate_invoice_pdf(request):
    show_all = request.GET.get('show_all') == 'true'
    orders_query = Order.objects.filter(user=request.user)
    if not show_all:
        orders_query = orders_query.exclude(status=Order.OrderStatus.CANCELED)
    orders = orders_query.order_by('created_at')

    if not orders.exists():
        messages.error(request, '請求書を作成する対象の注文がありません。')
        return redirect('orders:order_history_list')

    grand_total = sum(order.total_price for order in orders)
    any_fee_not_finalized = any(not order.is_shipping_fee_finalized for order in orders)
    
    system_settings = SystemSetting.load()
    template_path = 'orders/invoice_template.html'
    context = {
        'orders': orders,
        'grand_total': grand_total,
        'customer': request.user,
        'settings': system_settings,
        'any_fee_not_finalized': any_fee_not_finalized,
    }
    
    response = HttpResponse(content_type='application/pdf')
    filename = f"invoice_{request.user.username}_{timezone.now().strftime('%Y%m%d')}.pdf"
    response['Content-Disposition'] = f'attachment; filename="{filename}"'

    template = get_template(template_path)
    html = template.render(context, request=request)

    pisa_status = pisa.CreatePDF(
        html.encode('utf-8'), 
        dest=response, 
        encoding='utf-8',
        link_callback=link_callback
    )

    if pisa_status.err:
        return HttpResponse('PDFの生成中にエラーが発生しました。')
    return response

@login_required
@require_POST
@transaction.atomic
def order_update(request, order_id):
    order = get_object_or_404(Order.objects.select_related('user').prefetch_related('items__product__variety'), id=order_id, user=request.user)

    if not order.is_cancelable:
        return JsonResponse({'success': False, 'message': 'この注文は変更できません。'})
    
    original_total_weight = order.get_total_weight_in_genmai()
    
    updates = {}
    new_items_data = {}
    seimai_coefficient = Decimal(settings.SEIMAI_WEIGHT_COEFFICIENT)
    for item in order.items.all():
        new_quantity_str = request.POST.get(f'quantity_{item.id}')
        if not new_quantity_str or not new_quantity_str.isdigit():
            return JsonResponse({'success': False, 'message': '数量は有効な数字で入力してください。'})
        new_quantity = int(new_quantity_str)
        updates[item.id] = new_quantity
        variety_id = item.product.variety.id
        new_items_data[variety_id] = new_items_data.get(variety_id, Decimal('0'))
        weight = item.product.weight_kg * new_quantity
        if item.product.type == Product.ProductType.SEIMAI:
            weight *= seimai_coefficient
        new_items_data[variety_id] += weight

    new_total_weight = sum(new_items_data.values())
    weight_diff = new_total_weight - original_total_weight

    if weight_diff > 0:
        variety_ids_to_lock = list(new_items_data.keys())
        stocks = Stock.objects.select_for_update().filter(variety_id__in=variety_ids_to_lock)
        available_stock_in_db = {s.variety_id: s.available_kg for s in stocks}
        for variety_id in variety_ids_to_lock:
            original_variety_weight = order.get_total_weight_in_genmai_for_variety(variety_id)
            new_variety_weight = new_items_data.get(variety_id, Decimal('0'))
            variety_weight_diff = new_variety_weight - original_variety_weight
            if variety_weight_diff > 0 and available_stock_in_db.get(variety_id, Decimal('0')) < variety_weight_diff:
                variety = get_object_or_404(ProductVariety, id=variety_id)
                return JsonResponse({'success': False, 'message': f'在庫が不足しています。「{variety.name}」の追加分を確保できません。'})

    stock_updates_by_variety = {}
    for item in order.items.all():
        original_quantity = item.quantity
        new_quantity = updates.get(item.id, original_quantity)
        if new_quantity != original_quantity:
            weight_change = item.product.weight_kg * (new_quantity - original_quantity)
            if item.product.type == Product.ProductType.SEIMAI:
                weight_change *= seimai_coefficient
            variety_id = item.product.variety.id
            stock_updates_by_variety[variety_id] = stock_updates_by_variety.get(variety_id, Decimal('0')) + weight_change
        if new_quantity > 0:
            item.quantity = new_quantity
            item.save(update_fields=['quantity'])
        else:
            item.delete()

    if stock_updates_by_variety:
        variety_ids_to_update = list(stock_updates_by_variety.keys())
        stocks_to_update = Stock.objects.select_for_update().filter(variety_id__in=variety_ids_to_update)
        for stock in stocks_to_update:
            change_for_this_variety = stock_updates_by_variety.get(stock.variety_id, Decimal('0'))
            stock.total_ordered_kg += change_for_this_variety
            stock.save(update_fields=['total_ordered_kg', 'updated_at'])

    if not order.items.exists():
        order.delete()
        messages.success(request, f'注文(ORD-{order.id:06d})の全商品を削除したため、注文は自動的にキャンセルされました。')
        return JsonResponse({'success': True, 'redirect_url': reverse('orders:order_history_list')})

    temp_cart_group = {
        'destination': order.destination,
        'items': [{'product': item.product, 'quantity': item.quantity, 'price': item.price_at_order} for item in order.items.all()]
    }
    order.provisional_shipping_fee = _calculate_provisional_shipping_fee(temp_cart_group)
    order.final_shipping_fee = None
    order.save(update_fields=['provisional_shipping_fee', 'final_shipping_fee'])

    messages.success(request, f'注文(ORD-{order.id:06d})を更新しました。')
    return JsonResponse({'success': True, 'redirect_url': reverse('orders:order_detail', args=[order.id])})
```

##### **ファイル:** `mg_orders/views.py` **(全面的に上書き)**

```python
# mg_orders/views.py
from decimal import Decimal
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required, user_passes_test
from django.db import transaction
from django.contrib import messages
from django.views.decorators.http import require_POST
from django.conf import settings

from orders.models import Order, OrderItem
from products.models import Product, Stock
from accounts.models import Destination

def is_staff_user(user):
    return user.is_staff

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
def order_list(request):
    filter_type = request.GET.get('filter', 'active')
    status_filter = request.GET.get('status', '')
    payment_status_filter = request.GET.get('payment_status', '')

    orders_query = Order.objects.select_related('user', 'destination') \
        .prefetch_related('items__product').order_by('-created_at')

    if status_filter:
        orders_query = orders_query.filter(status=status_filter)
        filter_type = 'status'
    elif payment_status_filter:
        orders_query = orders_query.filter(payment_status=payment_status_filter)
        filter_type = 'payment_status'
    elif filter_type == 'active':
        orders_query = orders_query.exclude(
            status__in=[
                Order.OrderStatus.SHIPPED,
                Order.OrderStatus.DELIVERED,
                Order.OrderStatus.CANCELED,
            ]
        )
    
    context = {
        'orders': orders_query,
        'all_statuses': Order.OrderStatus.choices,
        'current_status': status_filter,
        'current_payment_status': payment_status_filter,
        'filter_type': filter_type,
    }
    return render(request, 'mg_orders/order_list.html', context)

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
@require_POST
def order_accept(request, order_id):
    order = get_object_or_404(Order, id=order_id)
    if order.status == Order.OrderStatus.NEW:
        order.status = Order.OrderStatus.ACCEPTED
        order.save()
        messages.success(request, f'注文(ORD-{order.id:06d})を受付済みにしました。')
    else:
        messages.warning(request, f'注文(ORD-{order.id:06d})は既に処理されています。')
    return redirect('dashboard:mg_orders:order_list')

@login_required
@user_passes_test(is_staff_user, login_url='/accounts/login/')
@transaction.atomic
def order_edit(request, order_id):
    order = get_object_or_404(Order.objects.prefetch_related('items__product__variety'), id=order_id)
    if not order.is_editable:
        messages.error(request, 'この注文は発送済みまたはキャンセル済みのため編集できません。')
        return redirect('dashboard:mg_orders:order_list')

    if request.method == 'POST':
        seimai_coefficient = Decimal(settings.SEIMAI_WEIGHT_COEFFICIENT)
        
        has_changes = False
        product_content_changed = False

        new_weights_by_variety = {}

        # 既存商品の数量・単価変更
        for item in order.items.all():
            quantity_str = request.POST.get(f'quantity_{item.id}', str(item.quantity))
            price_str = request.POST.get(f'price_{item.id}', str(item.price_at_order))
            new_quantity = int(quantity_str) if quantity_str.isdigit() else item.quantity
            new_price = int(price_str) if price_str.isdigit() else item.price_at_order

            if new_quantity != item.quantity:
                has_changes = True
                product_content_changed = True
            if new_price != item.price_at_order:
                has_changes = True

            weight = item.product.weight_kg * new_quantity
            if item.product.type == Product.ProductType.SEIMAI:
                weight *= seimai_coefficient
            new_weights_by_variety[item.product.variety_id] = new_weights_by_variety.get(item.product.variety_id, Decimal('0')) + weight

        # 新規追加商品
        new_product_id = request.POST.get('new_product')
        new_product_quantity_str = request.POST.get('new_product_quantity', '0')
        new_product_quantity = int(new_product_quantity_str) if new_product_quantity_str.isdigit() else 0
        if new_product_id and new_product_quantity > 0:
            has_changes = True
            product_content_changed = True
            product = get_object_or_404(Product, id=new_product_id)
            weight = product.weight_kg * new_product_quantity
            if product.type == Product.ProductType.SEIMAI:
                weight *= seimai_coefficient
            new_weights_by_variety[product.variety_id] = new_weights_by_variety.get(product.variety_id, Decimal('0')) + weight
        
        # 在庫チェック
        weight_diff_by_variety = {v_id: new_weights_by_variety.get(v_id, 0) - order.get_total_weight_in_genmai_for_variety(v_id) for v_id in set(new_weights_by_variety.keys()) | set(item.product.variety_id for item in order.items.all())}
        stocks_to_check = Stock.objects.select_for_update().filter(variety_id__in=weight_diff_by_variety.keys())
        for stock in stocks_to_check:
            if stock.available_kg < weight_diff_by_variety.get(stock.variety_id, 0):
                messages.error(request, f"在庫不足: {stock.variety.name}")
                return redirect('dashboard:mg_orders:order_edit', order_id=order.id)

        # 変更を適用
        if has_changes:
            for stock in stocks_to_check:
                diff = weight_diff_by_variety.get(stock.variety_id, 0)
                if diff != 0:
                    stock.total_ordered_kg += diff
                    stock.save(update_fields=['total_ordered_kg', 'updated_at'])
            
            for item in order.items.all():
                new_quantity = int(request.POST.get(f'quantity_{item.id}'))
                new_price = int(request.POST.get(f'price_{item.id}'))
                if new_quantity <= 0:
                    item.delete()
                    product_content_changed = True
                else:
                    item.quantity = new_quantity
                    item.price_at_order = new_price
                    item.save()

            if new_product_id and new_product_quantity > 0:
                product = get_object_or_404(Product, id=new_product_id)
                OrderItem.objects.create(order=order, product=product, quantity=new_product_quantity, price_at_order=product.price)
            
            if product_content_changed:
                order.final_shipping_fee = None
            
            order.save()
            messages.success(request, f'注文(ORD-{order.id:06d})を更新しました。')
        else:
            messages.info(request, '変更点がなかったため、注文は更新されませんでした。')
        
        return redirect('dashboard:mg_orders:order_edit', order_id=order.id)

    customer_destinations = Destination.objects.filter(user=order.user)
    all_products = Product.objects.filter(status=Product.ProductStatus.FOR_SALE).order_by('name')
    context = {'order': order, 'customer_destinations': customer_destinations, 'all_products': all_products}
    return render(request, 'mg_orders/order_edit.html', context)
```

##### **ファイル:** `mg_workflow/api_shipping.py` **(全面的に上書き)**

```python
# mg_workflow/api_shipping.py
from django.http import JsonResponse, HttpRequest, HttpResponse
from django.views import View
from django.shortcuts import get_object_or_404
from django.utils.decorators import method_decorator
from django.views.decorators.csrf import csrf_protect
from django.contrib.admin.views.decorators import staff_member_required
from django.utils import timezone
from django.db import transaction
from django.db.models import F, Count
import json
import csv
import io
import re
from collections import Counter

from orders.models import Package, Order, OrderItem
from system_settings.models import SystemSetting
from accounts.models import Destination
from django.conf import settings

def _json(request: HttpRequest):
    try:
        body = request.body.decode("utf-8") or "{}"
        return json.loads(body)
    except json.JSONDecodeError:
        return {}

def _bad_request(message: str, *, code: str = "invalid_request"):
    return JsonResponse({"ok": False, "error": {"code": code, "message": message}}, status=400)

def _ok(data=None, *, status: int = 200):
    payload = {"ok": True}
    if data:
        payload.update(data)
    return JsonResponse(payload, status=status)

def _finalize_shipping_fee_if_all_packed(destination: Destination):
    related_orders = Order.objects.filter(destination=destination, status=Order.OrderStatus.ACCEPTED)
    if not related_orders.exists():
        return

    all_packages = Package.objects.filter(destination=destination)
    if not all_packages.exists() or not all(p.status in [Package.PackageStatus.READY_TO_SHIP, Package.PackageStatus.LABEL_PRINTED, Package.PackageStatus.SHIPPED, Package.PackageStatus.DELIVERED] for p in all_packages):
        related_orders.update(final_shipping_fee=None)
        return

    package_count = all_packages.count()
    if destination.delivery_method == 'TEWATASHI':
        final_fee = 0
    else:
        base_fee = settings.REMOTE_SHIPPING_FEE if destination.shipping_zone == 'ENCHI' else settings.NORMAL_SHIPPING_FEE
        final_fee = int(base_fee * package_count)

    related_orders.update(final_shipping_fee=final_fee)

@method_decorator(staff_member_required(login_url='/accounts/login/'), name="dispatch")
class ShippingDataView(View):
    def get(self, request: HttpRequest):
        packages_qs = Package.objects.exclude(status=Package.PackageStatus.PACKAGING).select_related(
            'destination'
        ).prefetch_related(
            'items__bag__product__variety'
        ).order_by('destination__name', 'created_at')

        shipping_packages = []
        for pkg in packages_qs:
            item_names = [item.bag.product.name for item in pkg.items.all()]
            item_counts = Counter(item_names)
            summary_parts = [f"{name} x {count}" for name, count in sorted(item_counts.items())]
            items_summary = ", ".join(summary_parts)

            shipping_packages.append({
                "id": pkg.id,
                "label": pkg.label,
                "status": pkg.status,
                "status_display": pkg.get_status_display(),
                "items_summary": items_summary,
                "csv_exported_at": pkg.csv_exported_at.isoformat() if pkg.csv_exported_at else None,
                "tracking_number": pkg.tracking_number,
                "destination": {
                    "id": pkg.destination.id,
                    "name": pkg.destination.name,
                    "delivery_method": pkg.destination.delivery_method,
                }
            })
        
        return _ok({"shipping_packages": shipping_packages})

@method_decorator(csrf_protect, name="dispatch")
@method_decorator(staff_member_required(login_url='/accounts/login/'), name="dispatch")
class PackageStatusUpdateView(View):
    def post(self, request: HttpRequest):
        data = _json(request)
        package_ids = data.get("package_ids", [])
        new_status = data.get("status")

        if not all([package_ids, new_status]):
            return _bad_request("package_ids and status are required.")
        if not isinstance(package_ids, list):
            return _bad_request("package_ids must be a list of integers.")

        valid_statuses = [s for s in Package.PackageStatus.choices]
        if new_status not in valid_statuses:
            return _bad_request(f"Invalid status. Must be one of: {', '.join(valid_statuses)}")
        
        updated_count = 0
        with transaction.atomic():
            packages = Package.objects.select_for_update().filter(id__in=package_ids).select_related('destination')
            destinations_to_check = {pkg.destination for pkg in packages}
            
            if new_status == Package.PackageStatus.LABEL_PRINTED:
                target_packages = packages.filter(csv_exported_at__isnull=False)
                updated_count = target_packages.update(status=new_status, updated_at=timezone.now())
            else:
                updated_count = packages.update(status=new_status, updated_at=timezone.now())
            
            for dest in destinations_to_check:
                _finalize_shipping_fee_if_all_packed(dest)

        return _ok({
            "message": f"{updated_count}件のパッケージの状態を「{dict(Package.PackageStatus.choices)[new_status]}」に更新しました。",
            "updated_count": updated_count,
        })

@method_decorator(csrf_protect, name="dispatch")
@method_decorator(staff_member_required(login_url='/accounts/login/'), name="dispatch")
class ResetCsvExportStatusView(View):
    def post(self, request: HttpRequest):
        data = _json(request)
        package_ids = data.get("package_ids", [])
        if not package_ids or not isinstance(package_ids, list):
            return _bad_request("package_ids (リスト形式) は必須です。")

        with transaction.atomic():
            updated_count = Package.objects.filter(id__in=package_ids).update(csv_exported_at=None)

        return _ok({
            "message": f"{updated_count}件を「CSV出力前」に戻しました。",
            "updated_count": updated_count,
        })

@method_decorator(csrf_protect, name="dispatch")
@method_decorator(staff_member_required(login_url='/accounts/login/'), name="dispatch")
class DownloadB2CsvView(View):
    def post(self, request: HttpRequest):
        data = _json(request)
        package_ids = data.get("package_ids", [])
        if not package_ids:
            return _bad_request("package_idsは必須です。")

        try:
            settings_obj = SystemSetting.load()
        except SystemSetting.DoesNotExist:
            return _bad_request("システム設定（依頼主情報）が登録されていません。", code="no_settings")

        packages = Package.objects.filter(id__in=package_ids).select_related('destination').prefetch_related('items__bag__product__variety')
        
        output = io.StringIO()
        writer = csv.writer(output)
        
        header = ["お客様管理番号", "送り状種別", "クール区分", "伝票番号", "出荷予定日", "お届け予定日", "配達時間帯", "お届け先コード", "お届け先電話番号", "お届け先電話番号枝番", "お届け先郵便番号", "お届け先住所", "お届け先住所（アパート名等）", "お届け先会社・部門１", "お届け先会社・部門２", "お届け先名", "お届け先名（カナ）", "敬称", "ご依頼主コード", "ご依頼主電話番号", "ご依頼主電話番号枝番", "ご依頼主郵便番号", "ご依頼主住所", "ご依頼主住所（アパート名等）", "ご依頼主名", "ご依頼主名（カナ）", "品名コード１", "品名１", "品名コード２", "品名２", "荷扱い１", "荷扱い２", "記事", "コレクト代金引換額（税込）", "内消費税額等", "止置き", "営業所コード", "発行枚数", "個数口表示", "ご請求先顧客コード", "ご請求先分類コード", "運賃管理番号"]
        writer.writerow(header)

        for pkg in packages:
            dest = pkg.destination
            item_counts = Counter(item.bag.product for item in pkg.items.all())
            hinmei_parts = []
            for prod, count in sorted(item_counts.items(), key=lambda x: x.name):
                variety_name = prod.variety.name[:2]
                milling_char = '精' if prod.type == '精米' else '玄'
                weight_num = str(int(prod.weight_kg))
                hinmei_parts.append(f"{variety_name}{milling_char}{weight_num}x{count}")
            hinmei_full = ",".join(hinmei_parts)
            if len(hinmei_full) > 25: hinmei_full = hinmei_full[:24] + "…"
            addr1, addr2 = (dest.address[:50], dest.address[50:100]) if len(dest.address) > 50 else (dest.address, "")
            tel_edaban = str(dest.id) if dest.phone == settings_obj.shop_phone else ""
            user_id_fallback = ""
            try:
                first_order = Order.objects.filter(destination=dest, status=Order.OrderStatus.ACCEPTED).first()
                if first_order: user_id_fallback = first_order.user.id
            except: pass
            b2_code_raw = settings_obj.b2_customer_code or ""
            b2_customer_code_part, b2_fare_management_part = (b2_code_raw.split("-", 1) + [""])[:2] if "-" in b2_code_raw else (b2_code_raw, "")
            row = [f"PKG{pkg.id}", "0", "0", "", timezone.now().strftime('%Y/%m/%d'), "", "", dest.id, re.sub(r'\D', '', dest.phone or ""), tel_edaban, re.sub(r'\D', '', dest.postal_code or ""), addr1, addr2, "", "", dest.name, "", "様", "", re.sub(r'\D', '', settings_obj.shop_phone or ""), "", re.sub(r'\D', '', settings_obj.shop_postal_code or ""), settings_obj.shop_address or "", "", settings_obj.shop_name or "", "", "", hinmei_full, "", "", "", "", "", "", "", "0", "", "", "", b2_customer_code_part or user_id_fallback, "", b2_fare_management_part]
            writer.writerow(row)

        with transaction.atomic():
            packages.update(csv_exported_at=timezone.now())

        encoded_csv = output.getvalue().encode('cp932')
        filename = timezone.now().strftime('b2_export_%Y%m%d_%H%M%S.csv')
        response = HttpResponse(encoded_csv, content_type='text/csv; charset=Shift_JIS')
        response['Content-Disposition'] = f'attachment; filename="{filename}"'
        return response

@method_decorator(csrf_protect, name="dispatch")
@method_decorator(staff_member_required(login_url='/accounts/login/'), name="dispatch")
class ImportTrackingNumbersView(View):
    def post(self, request: HttpRequest):
        csv_file = request.FILES.get("csv_file")
        if not csv_file: return _bad_request("CSVファイルが提供されていません。")
        if not csv_file.name.lower().endswith('.csv'): return _bad_request("有効なCSVファイルをアップロードしてください。")
        try:
            decoded_file = csv_file.read().decode('cp932')
        except UnicodeDecodeError:
            return _bad_request("ファイルのデコードに失敗しました。文字コードがShift_JISであることを確認してください。")
        csv_reader = csv.reader(io.StringIO(decoded_file))
        try:
            next(csv_reader)
        except StopIteration:
            return _bad_request("CSVファイルが空か、ヘッダー行がありません。")
        updates, errors = {}, []
        for i, row in enumerate(csv_reader, start=2):
            if not row or len(row) < 4: continue
            pkg_id_raw, tracking_number = row, row
            if not pkg_id_raw.upper().startswith('PKG') or not tracking_number.isdigit(): continue
            try:
                pkg_id = int(pkg_id_raw[3:])
                updates[pkg_id] = tracking_number
            except (ValueError, IndexError):
                errors.append(f"{i}行目: お客様管理番号 '{pkg_id_raw}' の形式が不正です。")
        if not updates:
            errors.append("CSVから有効な更新対象データが見つかりませんでした。")
            return _bad_request("CSVから有効な更新対象データが見つかりませんでした。")
        updated_count = 0
        with transaction.atomic():
            packages = Package.objects.select_for_update().filter(id__in=updates.keys())
            for pkg in packages:
                pkg.tracking_number = updates[pkg.id]
                pkg.save(update_fields=['tracking_number', 'updated_at'])
                updated_count += 1
        return _ok({"message": f"{updated_count}件の伝票番号を更新しました。", "updated_count": updated_count, "errors": errors})
```

#### 5. 手順4：フロントエンド（テンプレート）の修正

##### **ファイル:** `templates/orders/confirm.html` **(全面的に上書き)**

```html
{% extends "base.html" %}
{% load humanize %}
{% block title %}注文内容の確認{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">注文内容の確認</h1>
    
    <div class="alert alert-info">
        <p class="mb-0">以下の内容でよろしければ、「注文を確定する」ボタンを押してください。</p>
        <p class="mb-0"><strong>送料は、管理者が梱包作業を完了した後に確定します。</strong>ここに表示される送料・合計額はあくまで参考値です。</p>
    </div>

    <form id="order-confirm-form" action="{% url 'orders:order_create' %}" method="post">
        {% csrf_token %}
        
        {% for group in cart_groups %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">お届け先: {{ group.destination.name }} 様</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>商品</th>
                            <th class="text-end">単価</th>
                            <th class="text-center">数量</th>
                            <th class="text-end">小計</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in group.items %}
                        <tr>
                            <td>{{ item.product.name }}</td>
                            <td class="text-end">{{ item.price|intcomma }}円</td>
                            <td class="text-center">{{ item.quantity }}</td>
                            <td class="text-end">{{ item.total_price|intcomma }}円</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-end"><strong>商品小計</strong></td>
                            <td class="text-end"><strong>{{ group.items_subtotal|intcomma }}円</strong></td>
                        </tr>
                        <tr>
                            <td colspan="3" class="text-end">
                                <strong>送料（参考）</strong>
                            </td>
                            <td class="text-end"><strong>{{ group.provisional_shipping_fee|intcomma }}円</strong></td>
                        </tr>
                        <tr class="table-light fs-5">
                            <td colspan="3" class="text-end"><strong>合計（参考）</strong></td>
                            <td class="text-end"><strong>{{ group.group_total_price_provisional|intcomma }}円</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        {% endfor %}

        <div class="card bg-light d-none d-lg-block">
            <div class="card-body text-end">
                <h4 class="mb-3">総合計（参考）: <span class="text-danger">{{ grand_total_provisional|intcomma }}円</span></h4>
                <div class="d-flex justify-content-between align-items-center">
                    <a href="{% url 'products:product_list' %}" class="btn btn-secondary">
                        &laquo; 商品一覧に戻る
                    </a>
                    <button type="submit" class="btn btn-success btn-lg">
                        この内容で注文を確定する
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block floating_bar_content %}
<div class="d-flex justify-content-between align-items-center w-100">
    <a href="{% url 'products:product_list' %}" class="btn btn-secondary">
        &laquo; 戻る
    </a>
    <div class="text-end">
        <div class="small">総合計（参考）</div>
        <div class="fs-5 text-danger fw-bold">{{ grand_total_provisional|intcomma }}円</div>
    </div>
    <button type="submit" form="order-confirm-form" class="btn btn-success">
        注文を確定する
    </button>
</div>
{% endblock floating_bar_content %}
```

##### **ファイル:** `templates/orders/detail.html` **(全面的に上書き)**

```html
{% extends "base.html" %}
{% load humanize %}

{% block title %}注文詳細 - ORD-{{ order.id|stringformat:"06d" }}{% endblock %}

{% block content %}
    <h1>注文詳細</h1>
    <a href="{% url 'orders:order_history_list' %}">« 注文履歴に戻る</a>
    <hr>

    <div class="row">
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-header">ご注文情報</div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>注文番号:</strong> ORD-{{ order.id|stringformat:"06d" }}</li>
                    <li class="list-group-item"><strong>注文日時:</strong> {{ order.created_at|date:"Y/m/d H:i" }}</li>
                    <li class="list-group-item"><strong>注文ステータス:</strong> {{ order.get_status_display }}</li>
                </ul>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-header">お届け先情報</div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>お名前:</strong> {{ order.destination.name }}</li>
                    <li class="list-group-item"><strong>ご住所:</strong> 〒{{ order.destination.postal_code }} {{ order.destination.address }}</li>
                    <li class="list-group-item"><strong>電話番号:</strong> {{ order.destination.phone }}</li>
                </ul>
            </div>
        </div>
    </div>

    <h3 class="mt-4">ご注文明細</h3>
    
    <form id="order-update-form" action="{% url 'orders:order_update' order.id %}" method="post">
        {% csrf_token %}
        <table class="table table-bordered">
            <thead class="table-light"><tr><th>商品名</th><th class="text-end" style="width: 15%;">単価</th><th class="text-center" style="width: 15%;">数量</th><th class="text-end" style="width: 20%;">小計</th></tr></thead>
            <tbody>
                {% for item in order.items.all %}
                <tr>
                    <td>{{ item.product.name }}</td>
                    <td class="text-end">{{ item.price_at_order|intcomma }} 円</td>
                    <td class="text-center">
                        <span class="view-mode">{{ item.quantity }}</span>
                        <input type="number" name="quantity_{{ item.id }}" value="{{ item.quantity }}" class="form-control form-control-sm edit-mode d-none" min="0">
                    </td>
                    <td class="text-end">{{ item.subtotal|intcomma }} 円</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr><td colspan="3" class="text-end"><strong>商品小計</strong></td><td class="text-end">{{ order.items_subtotal|intcomma }} 円</td></tr>
                <tr>
                    <td colspan="3" class="text-end">
                        <strong>送料</strong>
                        {% if not order.is_shipping_fee_finalized %}
                            <span class="badge bg-warning text-dark">未確定</span>
                        {% endif %}
                    </td>
                    <td class="text-end">{{ order.shipping_fee|intcomma }} 円</td>
                </tr>
                <tr class="table-light">
                    <td colspan="3" class="text-end">
                        <strong>総合計</strong>
                        {% if not order.is_shipping_fee_finalized %}
                            <small class="d-block text-muted fw-normal">（参考価格）</small>
                        {% endif %}
                    </td>
                    <td class="text-end"><strong>{{ order.total_price|intcomma }} 円</strong></td>
                </tr>
            </tfoot>
        </table>
    </form>
    
    {% with packages=order.packages.all %}
    {% if packages %}
    <h3 class="mt-4">配送状況</h3>
    <div class="card">
        <div class="card-body">
            {% for package in packages %}
                <div class="d-flex justify-content-between align-items-start mb-2 pb-2 {% if not forloop.last %}border-bottom{% endif %}">
                    <div>
                        <h6 class="mb-1">箱 #{{ package.id }}</h6>
                        <small class="text-muted">
                            {% for item in package.items.all %}
                                {{ item.bag.product.name }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-success rounded-pill">{{ package.get_status_display }}</span>
                        {% if package.tracking_url %}
                            <div class="mt-1">
                                <small>
                                    伝票番号: <a href="{{ package.tracking_url }}" target="_blank" rel="noopener noreferrer">{{ package.tracking_number }} <i class="bi bi-box-arrow-up-right" style="font-size: 0.8em;"></i></a>
                                </small>
                            </div>
                        {% elif package.tracking_number %}
                            <div class="mt-1">
                                <small>伝票番号: {{ package.tracking_number }}</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endwith %}

    <hr>
    
    <div id="actions-view-mode" class="d-flex align-items-center">
        {% if order.is_cancelable %}
            <button id="btn-edit" class="btn btn-primary me-2">この注文内容を変更する</button>
            <form action="{% url 'orders:order_cancel' order.id %}" method="post" class="d-inline" onsubmit="return confirm('本当にこの注文をキャンセルしますか？');">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">この注文をキャンセルする</button>
            </form>
        {% endif %}
    </div>

    <div id="actions-edit-mode" class="d-none">
        <button id="btn-update" class="btn btn-success">変更を更新する</button>
        <button id="btn-cancel-edit" class="btn btn-secondary ms-2">変更を中止</button>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const editButton = document.getElementById('btn-edit');
    if (!editButton) return;
    const viewModeActions = document.getElementById('actions-view-mode');
    const editModeActions = document.getElementById('actions-edit-mode');
    const viewModeItems = document.querySelectorAll('.view-mode');
    const editModeItems = document.querySelectorAll('.edit-mode');
    const updateButton = document.getElementById('btn-update');
    const form = document.getElementById('order-update-form');
    function switchToEditMode() {
        viewModeActions.classList.add('d-none');
        editModeActions.classList.remove('d-none');
        viewModeItems.forEach(el => el.classList.add('d-none'));
        editModeItems.forEach(el => el.classList.remove('d-none'));
    }
    function switchToViewMode() { location.reload(); }
    editButton.addEventListener('click', switchToEditMode);
    document.getElementById('btn-cancel-edit').addEventListener('click', switchToViewMode);
    updateButton.addEventListener('click', function() {
        updateButton.disabled = true;
        fetch(form.action, { method: 'POST', body: new FormData(form), headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => response.json())
        .then(data => {
            if (data.success) { window.location.href = data.redirect_url; } 
            else { alert('エラー: ' + data.message); updateButton.disabled = false; }
        }).catch(error => { console.error('Error:', error); alert('通信中にエラーが発生しました。'); updateButton.disabled = false; });
    });
});
</script>
{% endblock %}
```

##### **ファイル:** `templates/orders/history_list.html` **(全面的に上書き)**

```html
{% extends "base.html" %}
{% load humanize %}
{% block title %}注文履歴{% endblock %}
{% block content %}
    <div class="d-flex justify-content-between align-items-center">
        <h1>注文履歴</h1>
        <div>
            {% if orders %}
                <a href="{% url 'orders:order_invoice_pdf' %}{% if show_all %}?show_all=true{% endif %}"
                   class="btn btn-success btn-sm me-2">表示中の全注文で請求書作成</a>
            {% endif %}
            {% if show_all %}
                <a href="{% url 'orders:order_history_list' %}"
                   class="btn btn-outline-secondary btn-sm">キャンセル済みを非表示</a>
            {% else %}
                <a href="{% url 'orders:order_history_list' %}?show_all=true"
                   class="btn btn-outline-primary btn-sm">キャンセル済みを表示</a>
            {% endif %}
        </div>
    </div>
    <hr>
    {% for order in orders %}
        <div class="card mb-3 {% if order.is_canceled %}bg-light text-muted opacity-75{% endif %}">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                <div>
                    <strong>注文日:</strong> {{ order.created_at|date:"Y/m/d H:i" }} |
                    <strong>注文番号:</strong> ORD-{{ order.id|stringformat:"06d" }}
                </div>
                <div class="d-flex align-items-center gap-2 mt-1 mt-md-0">
                    <strong>ステータス:</strong>
                    <span class="badge {% if order.is_canceled %}bg-secondary{% else %}bg-info{% endif %}">{{ order.get_status_display }}</span>
                    
                    {% with packages=order.packages.all %}
                        {% if packages %}
                            <i class="bi bi-arrow-right"></i>
                            {% for pkg in packages %}
                                <span class="badge bg-success">{{ pkg.get_status_display }}</span>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    {% if order.is_cancelable %}
                        <form action="{% url 'orders:order_cancel' order.id %}"
                              method="post"
                              class="d-inline ms-2"
                              onsubmit="return confirm('本当にこの注文をキャンセルしますか？');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger btn-sm">キャンセル</button>
                        </form>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <h5 class="card-title">お届け先: {{ order.destination.name }} 様</h5>
                <p class="card-text">
                    <strong>商品:</strong>
                    {% for item in order.items.all %}
                        {{ item.product.name }} ({{ item.quantity }}点)
                        {% if not forloop.last %},{% endif %}
                    {% endfor %}
                </p>
                <p class="card-text">
                    <strong>合計金額:</strong> {{ order.total_price|intcomma }} 円（送料込
                    {% if not order.is_shipping_fee_finalized %}
                        <span class="badge bg-warning text-dark ms-1">送料未確定</span>
                    {% endif %}
                    ）
                </p>
                <a href="{% url 'orders:order_detail' order.id %}"
                   class="btn btn-primary">詳細を見る</a>
            </div>
        </div>
    {% empty %}
        <p>表示対象の注文履歴はありません。</p>
    {% endfor %}
{% endblock %}
```

##### **ファイル:** `templates/orders/invoice_template.html` **(全面的に上書き)**

```html
<!DOCTYPE html>
<html lang="ja">
    {% load humanize %}
    <head>
        <meta charset="UTF-8">
        <style>
        @font-face {
            font-family: 'IPAexGothic';
            src: url("fonts/ipaexg.ttf");
        }
        body {
            font-family: 'IPAexGothic', sans-serif;
            font-size: 9.5pt;
            line-height: 1.3;
            color: #2c2c2c;
        }
        p, h1, h2, h3, h4, div, table {
            margin: 0;
            padding: 0;
        }
        .invoice-box {
            max-width: 800px;
            margin: auto;
            padding: 15px;
        }
        
        .title-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .title-table td {
            border: none;
            padding: 0;
            vertical-align: top;
        }
        .title-table .title {
            text-align: left;
            font-size: 20pt;
        }
        .title-table .issue-date {
            text-align: right;
            padding-top: 8px;
        }
        
        .header-info {
            display: -pdf-table;
            width: 100%;
            margin-bottom: 15px;
        }
        .customer-info, .shop-info {
            display: -pdf-table-cell;
            width: 50%;
            vertical-align: top;
        }
        .shop-info {
            text-align: right;
            font-size: 9pt;
        }
        hr {
            border: 0;
            border-top: 1px solid #ccc;
            margin: 10px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: left;
        }
        th {
            background-color: #f8f8f8;
            font-weight: normal;
        }
        .text-right { text-align: right; }

        .order-block {
            margin-bottom: 18px;
        }
        .order-header {
            font-size: 10.5pt;
            margin-bottom: 4px;
        }
        .order-header small {
            font-size: 8.5pt;
            color: #555;
        }
        
        .grand-total {
            margin: 15px 0;
            padding: 8px;
            text-align: right;
            font-size: 13pt;
            font-weight: bold;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
        }
        .notes {
            margin-top: 20px;
            padding: 12px;
            border: 1px solid #e0e0e0;
            font-size: 9pt;
        }
        .account-block {
            margin-bottom: 8px;
        }
        .account-details {
            margin-left: 1em;
        }
        .remarks ul {
            padding-left: 20px;
            margin: 5px 0 0 0;
        }
        .remarks li {
            margin-bottom: 2px;
        }

        </style>
    </head>
    <body>
        <div class="invoice-box">
            <table class="title-table">
                <tr>
                    <td class="title">
                        <h1>ご請求書</h1>
                    </td>
                    <td class="issue-date">
                        <p>発行日: {% now "Y年m月d日" %}</p>
                    </td>
                </tr>
            </table>
            <div class="header-info">
                <div class="customer-info">
                    <p>
                        〒{{ orders.first.destination.postal_code }}
                        <br>
                        {{ orders.first.destination.address }}
                        <br>
                        <strong style="font-size: 11pt; line-height: 1.6;">{{ orders.first.destination.name }} 様</strong>
                    </p>
                </div>
                <div class="shop-info">
                    <p>
                        <strong>{{ settings.shop_name }}</strong>
                        <br>
                        〒{{ settings.shop_postal_code }} {{ settings.shop_address }}
                        <br>
                        電話: {{ settings.shop_phone }}
                    </p>
                </div>
            </div>
            <p style="margin-bottom: 5px;">下記の通りご請求申し上げます。</p>
            <hr>
            {% for order in orders %}
                <div class="order-block">
                    <h4 class="order-header">
                        注文番号: ORD-{{ order.id|stringformat:"06d" }}
                        <small>(注文日時: {{ order.created_at|date:"Y/m/d H:i" }}, お届け先: {{ order.destination.name }}様)</small>
                    </h4>
                    <table>
                        <thead>
                            <tr>
                                <th>商品名</th>
                                <th class="text-right" style="width: 15%;">単価</th>
                                <th class="text-right" style="width: 15%;">数量</th>
                                <th class="text-right" style="width: 20%;">小計</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in order.items.all %}
                                <tr>
                                    <td>{{ item.product.name }}</td>
                                    <td class="text-right">{{ item.price_at_order|intcomma }}円</td>
                                    <td class="text-right">{{ item.quantity|intcomma }}</td>
                                    <td class="text-right">{{ item.subtotal|intcomma }}円</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-right" style="border:0; padding-right: 10px;">商品小計</td>
                                <td class="text-right">{{ order.items_subtotal|intcomma }}円</td>
                            </tr>
                            <tr>
                                <td colspan="3" class="text-right" style="border:0; padding-right: 10px;">
                                    送料
                                    {% if not order.is_shipping_fee_finalized %}(未確定){% endif %}
                                </td>
                                <td class="text-right">{{ order.shipping_fee|intcomma }}円</td>
                            </tr>
                            <tr style="background-color: #f8f8f8;">
                                <td colspan="3"
                                    class="text-right"
                                    style="border-top: 1px solid #ddd;
                                           padding-right: 10px">
                                    <strong>ご注文合計</strong>
                                </td>
                                <td class="text-right" style="border-top: 1px solid #ddd;">
                                    <strong>{{ order.total_price|intcomma }}円</strong>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            {% endfor %}
            <div class="grand-total">
                ご請求金額 合計{% if any_fee_not_finalized %}（暫定）{% endif %}: {{ grand_total|intcomma }}円
            </div>
            <div class="notes">
                <strong>お振込先</strong>
                <p style="font-size: 8.5pt; margin-top: 3px;">下記いずれかの口座にお振込みください。</p>
                <hr style="margin: 8px 0;">
                {% for account in settings.bank_accounts.all %}
                    <div class="account-block">
                        <strong>【{{ account.title }}】</strong>
                        <div class="account-details">{{ account.details|linebreaksbr }}</div>
                    </div>
                {% endfor %}
            </div>
            <div class="notes remarks" style="margin-top: 10px;">
                <strong>備考</strong>
                <ul>
                    <li>本状は、最新の注文内容の控えとして発行されたものです。</li>
                    <li>金額は消費税込みの価格です。</li>
                    {% if any_fee_not_finalized %}
                    <li>送料が未確定の注文が含まれるため、合計金額は暫定値です。管理者が梱包を完了した後に、最終的なご請求額が確定します。</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </body>
</html>
```

#### 6. 手順5：動作確認

ローカル開発環境で、以下の項目をテストして、システムが意図通りに動作することを確認します。

1. **購入者フロー:**
    * 商品をカートに入れ、注文確認画面に進むと「参考送料」と「参考合計額」が表示されること。
    * 注文を確定し、マイページの注文詳細で送料が「未確定」状態で表示されること。
2. **管理者フロー:**
    * 該当の注文を受付済みにし、パッケージング管理画面で梱包作業を行い、箱を「確定」させる。
    * その結果、マイページ（購入者側）と注文管理画面（管理者側）で送料が「確定送料」に更新され、「未確定」バッジが消えること。
    * 送料確定後、管理者としてその注文を編集（例: 商品Aの数量を1つ増やす）して保存する。
    * 再度、注文詳細画面を確認すると、送料が新しい「参考送料」に更新され、再び「未確定」状態に戻っていること。
3. **請求書:**
    * 送料未確定の状態で請求書PDFをダウンロードすると、「送料（未確定）」と表示されること。
    * 送料確定後に請求書PDFをダウンロードすると、確定した送料と合計金額が表示されること。

#### 7. 手順6：運用サーバーへのデプロイ

開発環境で全ての動作確認が完了したら、運用サーバーにリリースします。

1. `akira`ユーザーでサーバーにSSHログインし、`riceshop`ユーザーに切り替わります。
2. プロジェクトディレクトリに移動します。
3. Gitリポジトリから最新のソースコードを取得します。

    ```bash
    git pull
    ```

4. コンテナを再ビルドして起動します。

    ```bash
    docker compose up -d --build
    ```

5. **データベースのマイグレーションを実行します。**

    ```bash
    docker compose exec app python manage.py migrate
    ```

---
---

以上で、今回の修正に関連するすべての手順書の更新が完了しました。
システムは現在、安定した動作状態にあり、その状態が聖典ファイルにも正しく反映されています。

ご確認のほど、よろしくお願いいたします。また何かありましたら、いつでもお声がけください。
